<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>‡∏®‡∏π‡∏ô‡∏¢‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡πÅ‡∏õ‡∏£‡∏£‡∏π‡∏õ‡∏≠‡∏≤‡∏´‡∏≤‡∏£ - Food Processing Fun</title>

<!-- Performance: Preconnect -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preconnect" href="https://cdn.tailwindcss.com">

<!-- Font -->
<link href="https://fonts.googleapis.com/css2?family=Kodchasan:wght@400;500;700&family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
<!-- Tailwind CSS (CDN) -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- Icon Library -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
  :root {
    --primary: #FF9F1C;
    --secondary: #2EC4B6;
    --bg-color: #FFFDF7;
    --text-main: #2D3436;
    --card-bg: #ffffff;
  }

  body {
    font-family: 'Sarabun', sans-serif;
    background-color: var(--bg-color);
    color: var(--text-main);
    /* Performance: ‡πÉ‡∏ä‡πâ Fixed Background ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏î‡∏†‡∏≤‡∏û‡∏ã‡πâ‡∏≥‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ */
    background-image: radial-gradient(#FF9F1C 0.5px, transparent 0.5px), radial-gradient(#2EC4B6 0.5px, var(--bg-color) 0.5px);
    background-size: 24px 24px;
    background-position: 0 0, 12px 12px;
    background-attachment: fixed; 
    -webkit-tap-highlight-color: transparent;
    overflow-x: hidden; /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ã‡πâ‡∏≤‡∏¢‡∏Ç‡∏ß‡∏≤ */
  }

  h1, h2, h3, .brand-font { font-family: 'Kodchasan', sans-serif; }

  /* Optimized Animation */
  .mascot-container { animation: float 3s ease-in-out infinite; will-change: transform; }
  @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-8px); } 100% { transform: translateY(0px); } }

  .food-card {
    background: var(--card-bg);
    border-radius: 12px;
    border: 1px solid #f0f0f0;
    touch-action: manipulation; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏ß‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏ï‡∏∞‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
  }
  .food-card:active { transform: scale(0.96); border-color: var(--primary); transition: transform 0.1s; }

  /* Accordion Style */
  details > summary { list-style: none; cursor: pointer; }
  details > summary::-webkit-details-marker { display: none; }
  details[open] summary ~ * { animation: sweep .25s ease-out; }
  @keyframes sweep { 0% {opacity: 0; transform: translateY(-5px)} 100% {opacity: 1; transform: translateY(0)} }
  
  details summary .chevron { transition: transform 0.2s; }
  details[open] summary .chevron { transform: rotate(180deg); }

  /* Optimized Glass Effect (‡∏•‡∏î Blur ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏£‡∏∏‡πà‡∏ô‡πÄ‡∏Å‡πà‡∏≤) */
  .glass-panel {
    background: rgba(255, 255, 255, 0.98);
    border: 1px solid rgba(255,255,255,0.2);
    box-shadow: 0 8px 32px rgba(0,0,0,0.08);
  }
  @supports (backdrop-filter: blur(8px)) {
      .glass-panel { backdrop-filter: blur(8px); background: rgba(255, 255, 255, 0.95); }
  }

  .fab-btn { transition: transform 0.2s, box-shadow 0.2s; touch-action: manipulation; }
  .fab-btn:active { transform: scale(0.90); }
  
  input[type=number]::-webkit-inner-spin-button, 
  input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }

  /* Hide scrollbar but allow scrolling */
  .no-scrollbar::-webkit-scrollbar { display: none; }
  .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
</style>
</head>
<body class="pb-28">

<!-- Header Section -->
<div class="relative bg-white shadow-sm rounded-b-[30px] mb-6 pb-6 pt-6 px-4 border-b-4 border-orange-100 transform translate-z-0">
  <div class="max-w-4xl mx-auto flex items-center justify-between relative z-10">
    <!-- Logo -->
    <div class="flex items-center gap-3">
        <div class="mascot-container w-16 h-16 bg-orange-50 rounded-full flex items-center justify-center border-2 border-orange-200 shadow-sm">
             <svg viewBox="0 0 200 200" width="40" height="40">
                <rect x="50" y="70" width="100" height="90" rx="20" fill="#FF9F1C" stroke="#333" stroke-width="4"/>
                <rect x="65" y="85" width="70" height="50" rx="10" fill="#333"/>
                <circle cx="85" cy="105" r="5" fill="#2EC4B6"><animate attributeName="opacity" values="1;0;1" dur="2s" repeatCount="indefinite"/></circle>
                <circle cx="115" cy="105" r="5" fill="#2EC4B6"><animate attributeName="opacity" values="1;0;1" dur="2s" repeatCount="indefinite"/></circle>
                <path d="M85 120 Q100 130 115 120" stroke="#2EC4B6" stroke-width="3" fill="none"/>
                <line x1="50" y1="100" x2="30" y2="90" stroke="#333" stroke-width="4"/>
                <line x1="150" y1="100" x2="170" y2="90" stroke="#333" stroke-width="4"/>
            </svg>
        </div>
        <div>
            <h1 class="text-xl md:text-2xl font-bold brand-font text-gray-800 leading-none">
              Food Tech <span class="text-orange-500">Hub</span>
            </h1>
            <p class="text-xs text-gray-500 mt-1">‡∏Ñ‡∏•‡∏±‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ & ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡πÅ‡∏õ‡∏£‡∏£‡∏π‡∏õ</p>
        </div>
    </div>

    <!-- Top Tools -->
    <div class="flex gap-2">
        <button onclick="openModal('calendar-modal')" class="w-10 h-10 rounded-full bg-blue-50 text-blue-500 flex items-center justify-center hover:bg-blue-100 transition shadow-sm border border-blue-100" title="‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö">
            <i class="fa-regular fa-calendar-days"></i>
        </button>
        <button onclick="openRecipeModal('‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Å‡∏•‡∏≤‡∏á')" class="w-10 h-10 rounded-full bg-green-50 text-green-600 flex items-center justify-center hover:bg-green-100 transition shadow-sm border border-green-100 relative" title="‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Å‡∏•‡∏≤‡∏á">
            <i class="fa-solid fa-calculator"></i>
            <span class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full border border-white animate-pulse"></span>
        </button>
    </div>
  </div>

  <!-- Search Bar -->
  <div class="max-w-4xl mx-auto mt-6">
    <div class="relative">
      <i class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
      <input type="search" id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏°‡∏ô‡∏π (‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏´‡∏ô‡∏°, ‡∏Å‡∏•‡πâ‡∏ß‡∏¢‡∏ï‡∏≤‡∏Å)..." 
             class="w-full bg-gray-50 border border-gray-200 rounded-xl py-3 pl-10 pr-4 focus:ring-2 focus:ring-orange-300 focus:outline-none transition text-sm">
    </div>
  </div>
</div>

<!-- Main Content -->
<div class="max-w-4xl mx-auto px-4 space-y-4" id="category-container"></div>

<!-- Footer -->
<footer class="mt-12 text-center text-gray-400 text-xs py-8">
  <p>¬© 2025 Food Tech Hub | Lite & Stable Version</p>
</footer>

<!-- Floating Chat Button -->
<button id="fab-chat-toggle" class="fab-btn fixed bottom-6 right-6 w-14 h-14 rounded-full bg-gradient-to-tr from-orange-400 to-orange-500 text-white flex items-center justify-center z-40 shadow-lg border-2 border-white">
  <i class="fa-solid fa-robot text-xl"></i>
</button>

<!-- ================= MODALS ================= -->

<!-- 1. Recipe & Cost Modal -->
<div id="recipe-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/60 transition-opacity" onclick="closeModal('recipe-modal')"></div>
    <div class="glass-panel w-full max-w-md bg-white rounded-2xl p-0 relative overflow-hidden transform transition-all scale-100 flex flex-col max-h-[90vh]">
        
        <!-- Header -->
        <div class="bg-white border-b p-4 flex justify-between items-center sticky top-0 z-10 shadow-sm">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-orange-100 text-orange-500 flex items-center justify-center text-lg shrink-0">
                    <i class="fa-solid fa-utensils"></i>
                </div>
                <div class="min-w-0">
                    <h3 class="font-bold brand-font text-lg text-gray-800 truncate pr-2" id="recipe-title">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π</h3>
                    <p class="text-[10px] text-gray-400" id="recipe-category">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</p>
                </div>
            </div>
            <button onclick="closeModal('recipe-modal')" class="bg-gray-100 hover:bg-gray-200 rounded-full w-8 h-8 flex items-center justify-center text-gray-500 shrink-0"><i class="fa-solid fa-xmark"></i></button>
        </div>

        <!-- Scrollable Content -->
        <div class="overflow-y-auto flex-1 p-0 bg-gray-50 overscroll-contain">
            
            <!-- 1. Recipe Details -->
            <div class="p-4 bg-white mb-2 shadow-sm">
                <h4 class="font-bold text-gray-700 text-sm mb-2"><i class="fa-solid fa-list-check text-green-500 mr-2"></i>‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏¢‡πà‡∏≠</h4>
                <div class="bg-green-50 rounded-xl p-3 border border-green-100">
                    <ul class="text-xs text-gray-700 space-y-2 leading-relaxed" id="recipe-steps">
                        <!-- JS Injected -->
                    </ul>
                </div>
            </div>

            <!-- 2. Ingredient Prices -->
            <div class="p-4 bg-white mb-2 shadow-sm">
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <h4 class="font-bold text-gray-700 text-sm"><i class="fa-solid fa-basket-shopping text-blue-500 mr-2"></i>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</h4>
                        <p class="text-[10px] text-gray-400 mt-0.5" id="price-update-date"><i class="fa-regular fa-clock mr-1"></i>‡∏£‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï...</p>
                    </div>
                    <button onclick="updateMarketPricesAI()" id="ai-update-btn" class="text-[10px] bg-blue-50 text-blue-600 border border-blue-100 px-2 py-1.5 rounded-lg active:bg-blue-200 transition flex items-center gap-1 shadow-sm select-none">
                        <i class="fa-solid fa-rotate"></i> ‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏ï‡∏•‡∏≤‡∏î (AI)
                    </button>
                </div>
                <div class="border rounded-xl overflow-hidden mb-2">
                    <table class="w-full text-xs">
                        <thead class="bg-gray-100 text-gray-500">
                            <tr>
                                <th class="px-3 py-2 text-left w-2/3">‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</th>
                                <th class="px-3 py-2 text-right">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100 bg-white" id="recipe-ingredients">
                            <!-- JS Injected -->
                        </tbody>
                        <tfoot class="bg-blue-50 text-blue-800 font-bold border-t border-blue-100">
                            <tr>
                                <td class="px-3 py-2 text-left">‡∏£‡∏ß‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</td>
                                <td class="px-3 py-2 text-right whitespace-nowrap" id="ingredients-total-cost">0 ‡∏ö‡∏≤‡∏ó</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <p class="text-[10px] text-gray-400 text-right">*‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡∏•‡∏≤‡∏î‡∏Å‡∏•‡∏≤‡∏á‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</p>
            </div>

            <!-- 3. Simple Calculator -->
            <div class="p-4 bg-white shadow-sm pb-8">
                <h4 class="font-bold text-gray-700 text-sm mb-3"><i class="fa-solid fa-calculator text-orange-500 mr-2"></i>‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ï‡πà‡∏≠‡∏ä‡∏¥‡πâ‡∏ô</h4>
                
                <div class="bg-orange-50 p-3 rounded-xl border border-orange-100 mb-3 space-y-3">
                    <div>
                        <label class="block text-[10px] text-gray-500 mb-1">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ö‡∏≤‡∏ó)</label>
                        <input type="number" id="calc-total-input" class="w-full bg-white border border-gray-200 rounded-lg px-3 py-2 font-bold text-gray-700 focus:outline-none focus:border-orange-300 placeholder-gray-300" placeholder="‡πÄ‡∏ä‡πà‡∏ô 150" inputmode="decimal" oninput="liveCalculate()">
                    </div>
                    <div>
                        <label class="block text-[10px] text-gray-500 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÑ‡∏î‡πâ (‡∏ä‡∏¥‡πâ‡∏ô/‡∏ñ‡∏∏‡∏á)</label>
                        <input type="number" id="calc-units" class="w-full bg-white border border-gray-200 rounded-lg px-3 py-2 font-bold text-gray-700 focus:outline-none focus:border-orange-300 placeholder-gray-300" placeholder="‡πÄ‡∏ä‡πà‡∏ô 100" inputmode="numeric" oninput="liveCalculate()">
                    </div>
                </div>

                <div class="bg-green-100 rounded-xl p-3 text-center border border-green-200 shadow-inner">
                    <p class="text-[10px] text-green-700 font-bold uppercase tracking-wider">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ï‡∏Å‡∏ä‡∏¥‡πâ‡∏ô‡∏•‡∏∞</p>
                    <div class="flex items-baseline justify-center gap-1 mt-1">
                        <p class="text-3xl font-extrabold text-green-600" id="cost-per-unit">0.00</p>
                        <p class="text-xs text-green-500 font-medium">‡∏ö‡∏≤‡∏ó</p>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- 2. Calendar Modal -->
<div id="calendar-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/50" onclick="closeModal('calendar-modal')"></div>
    <div class="glass-panel w-full max-w-md bg-white rounded-2xl p-0 relative overflow-hidden">
        <div class="bg-blue-500 p-4 flex justify-between items-center text-white">
            <h3 class="font-bold brand-font"><i class="fa-regular fa-calendar-days mr-2"></i>‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</h3>
            <button onclick="closeModal('calendar-modal')" class="hover:bg-white/20 rounded-full w-8 h-8 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="p-6">
            <div class="flex justify-between items-end mb-4 border-b pb-2">
                <div>
                    <p class="text-sm text-gray-400">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</p>
                    <h2 class="text-3xl font-bold text-gray-800 brand-font" id="calendar-month-display">-</h2>
                </div>
                <div class="text-5xl opacity-20"><i class="fa-solid fa-cloud-sun"></i></div>
            </div>
            <h4 class="font-bold text-gray-700 mb-3 text-sm flex items-center gap-2">
                <span>üåæ ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏ô‡πà‡∏≤‡πÅ‡∏õ‡∏£‡∏£‡∏π‡∏õ</span>
                <span class="text-[10px] bg-blue-100 text-blue-600 px-2 rounded-full">‡∏ï‡∏•‡∏≤‡∏î‡∏Å‡∏•‡∏≤‡∏á</span>
            </h4>
            <div class="grid grid-cols-2 gap-3" id="seasonal-items"></div>
        </div>
    </div>
</div>

<!-- 3. Chatbot Modal -->
<div id="chatbot-modal" class="fixed inset-0 z-[60] hidden flex items-end sm:items-center justify-center pointer-events-none">
  <div class="absolute inset-0 bg-black/40 transition-opacity opacity-0" id="chat-backdrop"></div>
  <div class="bg-white w-full sm:w-[450px] h-[85vh] sm:h-[600px] rounded-t-3xl sm:rounded-2xl shadow-2xl flex flex-col transform transition-transform translate-y-full pointer-events-auto" id="chat-card">
    <div class="bg-gradient-to-r from-orange-400 to-orange-500 p-4 rounded-t-3xl sm:rounded-t-2xl flex justify-between items-center text-white shadow-md">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-md border border-white/30">
            <i class="fa-solid fa-robot text-xl"></i>
        </div>
        <div>
          <h3 class="font-bold brand-font text-lg leading-tight">‡∏ô‡πâ‡∏≠‡∏á‡πÅ‡∏õ‡∏£‡∏£‡∏π‡∏õ AI</h3>
          <p class="text-[10px] text-orange-100 bg-orange-600/30 px-2 py-0.5 rounded-full inline-block">Online</p>
        </div>
      </div>
      <div class="flex gap-2">
         <button id="new-chat-btn" class="p-2 hover:bg-white/20 rounded-lg transition" title="‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏ä‡∏ó"><i class="fa-solid fa-rotate-right"></i></button>
         <button id="chatbot-close-btn" class="p-2 hover:bg-white/20 rounded-lg transition" title="‡∏õ‡∏¥‡∏î"><i class="fa-solid fa-chevron-down"></i></button>
      </div>
    </div>
    <div id="chat-history" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50 overscroll-contain">
        <div class="flex items-start gap-2">
            <div class="w-8 h-8 rounded-full bg-orange-100 flex items-center justify-center text-lg border border-orange-200">ü§ñ</div>
            <div class="bg-white p-3 rounded-2xl rounded-tl-none border border-gray-100 text-sm shadow-sm text-gray-700 max-w-[85%]">
                ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö! ü•ó ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏≤‡∏Å‡∏•‡∏≠‡∏á‡πÅ‡∏õ‡∏£‡∏£‡∏π‡∏õ‡∏≠‡∏∞‡πÑ‡∏£‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö?
            </div>
        </div>
    </div>
    <div id="thinking-indicator" class="hidden px-4 pb-2 bg-slate-50 text-xs text-gray-400 flex items-center gap-2">
        <span class="flex h-2 w-2 relative">
          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-orange-400 opacity-75"></span>
          <span class="relative inline-flex rounded-full h-2 w-2 bg-orange-500"></span>
        </span>
        ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏¥‡∏î‡∏™‡∏π‡∏ï‡∏£...
    </div>
    <div class="p-3 bg-white border-t border-gray-100 pb-6 sm:pb-3">
      <div class="flex gap-2 items-end">
        <textarea id="user-input" rows="1" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°..." 
               class="flex-1 bg-gray-100 text-gray-700 border-0 rounded-2xl px-4 py-3 focus:ring-2 focus:ring-orange-400 outline-none transition text-sm resize-none overflow-hidden" style="min-height:44px; max-height:100px;"></textarea>
        <button id="send-btn" class="bg-orange-500 hover:bg-orange-600 text-white rounded-full w-11 h-11 flex items-center justify-center shadow-lg shadow-orange-200 transition mb-0.5 transform active:scale-90 shrink-0">
          <i class="fa-solid fa-paper-plane text-sm"></i>
        </button>
      </div>
    </div>
  </div>
</div>

<script>
/* ================= 1. DATABASE ================= */
const foodCategories = {
    "ü•© ‡πÅ‡∏õ‡∏£‡∏£‡∏π‡∏õ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå": [ "‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏Ñ‡πá‡∏°", "‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå", "‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÅ‡∏ú‡πà‡∏ô", "‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏¢‡∏≠‡∏á", "‡πÑ‡∏Å‡πà‡∏´‡∏¢‡∏≠‡∏á", "‡∏´‡∏°‡∏π‡∏´‡∏¢‡∏≠‡∏á", "‡πÅ‡∏´‡∏ô‡∏°", "‡πÑ‡∏™‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏õ‡∏£‡∏µ‡πâ‡∏¢‡∏ß", "‡∏Å‡∏∏‡∏ô‡πÄ‡∏ä‡∏µ‡∏¢‡∏á", "‡∏õ‡∏•‡∏≤‡∏´‡∏ß‡∏≤‡∏ô", "‡∏õ‡∏•‡∏≤‡∏¢‡∏≠" ],
    "üå∂Ô∏è ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∏‡∏á & ‡∏ô‡πâ‡∏≥‡∏û‡∏£‡∏¥‡∏Å": [ "‡∏ô‡πâ‡∏≥‡∏û‡∏£‡∏¥‡∏Å‡∏ô‡∏£‡∏Å", "‡∏ô‡πâ‡∏≥‡∏û‡∏£‡∏¥‡∏Å‡πÄ‡∏ú‡∏≤", "‡∏ã‡∏≠‡∏™‡∏û‡∏£‡∏¥‡∏Å", "‡∏ã‡∏≠‡∏™‡∏°‡∏∞‡πÄ‡∏Ç‡∏∑‡∏≠‡πÄ‡∏ó‡∏®", "‡∏ô‡πâ‡∏≥‡∏õ‡∏•‡∏≤", "‡∏õ‡∏•‡∏≤‡∏£‡πâ‡∏≤", "‡∏õ‡∏•‡∏≤‡πÄ‡∏à‡πà‡∏≤" ],
    "ü•¨ ‡∏ú‡∏±‡∏Å & ‡∏ú‡∏•‡πÑ‡∏°‡πâ‡∏î‡∏≠‡∏á": [ "‡∏Ç‡∏¥‡∏á‡∏î‡∏≠‡∏á", "‡∏ú‡∏±‡∏Å‡∏î‡∏≠‡∏á‡∏ú‡∏™‡∏°", "‡∏°‡∏∞‡∏´‡∏ô‡∏≤‡∏ß‡∏î‡∏≠‡∏á‡πÄ‡∏Ñ‡πá‡∏°", "‡∏°‡∏∞‡∏°‡πà‡∏ß‡∏á‡∏î‡∏≠‡∏á", "‡πÄ‡∏´‡πá‡∏î‡∏ü‡∏≤‡∏á‡∏î‡∏≠‡∏á‡∏™‡∏≤‡∏°‡∏£‡∏™", "‡∏ï‡∏±‡πâ‡∏á‡∏â‡πà‡∏≤‡∏¢" ],
    "üçå ‡∏Ç‡∏ô‡∏° & ‡∏Ç‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á": [ "‡∏Ç‡πâ‡∏≤‡∏ß‡πÄ‡∏Å‡∏£‡∏µ‡∏¢‡∏ö‡∏ü‡∏±‡∏Å‡∏ó‡∏≠‡∏á", "‡∏Ç‡πâ‡∏≤‡∏ß‡πÄ‡∏Å‡∏£‡∏µ‡∏¢‡∏ö‡∏Å‡∏∏‡πâ‡∏á", "‡∏Å‡∏•‡πâ‡∏ß‡∏¢‡∏≠‡∏ö‡πÄ‡∏ô‡∏¢", "‡∏Å‡∏•‡πâ‡∏ß‡∏¢‡∏â‡∏≤‡∏ö", "‡∏Ç‡∏ô‡∏∏‡∏ô‡∏ó‡∏≠‡∏î‡∏Å‡∏£‡∏≠‡∏ö", "‡∏°‡∏∞‡∏Ç‡∏≤‡∏°‡πÅ‡∏Å‡πâ‡∏ß", "‡∏™‡∏±‡∏õ‡∏õ‡∏∞‡∏£‡∏î‡∏Å‡∏ß‡∏ô", "‡πÄ‡∏ú‡∏∑‡∏≠‡∏Å‡∏Å‡∏ß‡∏ô", "‡∏ñ‡∏±‡πà‡∏ß‡πÄ‡∏Ñ‡∏•‡∏∑‡∏≠‡∏ö‡πÇ‡∏≠‡∏ß‡∏±‡∏•‡∏ï‡∏¥‡∏ô", "‡πÄ‡∏¢‡∏•‡∏•‡∏µ‡πà‡πÄ‡∏´‡πá‡∏î" ],
    "ü•§ ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏° & ‡πÅ‡∏õ‡πâ‡∏á": [ "‡πÑ‡∏ß‡∏ô‡πå‡∏™‡∏±‡∏õ‡∏õ‡∏∞‡∏£‡∏î", "‡πÑ‡∏ß‡∏ô‡πå‡∏Å‡∏£‡∏∞‡πÄ‡∏à‡∏µ‡πä‡∏¢‡∏ö", "‡πÅ‡∏õ‡πâ‡∏á‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏Ç‡πâ‡∏≤‡∏ß‡∏´‡∏°‡∏≤‡∏Å", "‡∏ô‡πâ‡∏≥‡πÄ‡∏ï‡πâ‡∏≤‡∏´‡∏π‡πâ", "‡πÄ‡∏ï‡πâ‡∏≤‡∏Æ‡∏ß‡∏¢", "‡∏ô‡πâ‡∏≥‡∏°‡∏∞‡∏Ç‡∏≤‡∏°‡πÄ‡∏õ‡∏µ‡∏¢‡∏Å" ]
};

const recipeDB = {
    "‡∏Å‡∏•‡πâ‡∏ß‡∏¢‡∏â‡∏≤‡∏ö": { steps: ["1. ‡∏õ‡∏≠‡∏Å‡πÄ‡∏õ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡πâ‡∏ß‡∏¢ ‡πÅ‡∏ä‡πà‡∏ô‡πâ‡∏≥‡∏ú‡∏™‡∏°‡∏ô‡πâ‡∏≥‡∏°‡∏∞‡∏ô‡∏≤‡∏ß (‡∏Å‡∏±‡∏ô‡∏î‡∏≥)", "2. ‡∏ù‡∏≤‡∏ô‡∏Å‡∏•‡πâ‡∏ß‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ú‡πà‡∏ô‡∏ö‡∏≤‡∏á‡∏ï‡∏≤‡∏°‡∏¢‡∏≤‡∏ß", "3. ‡∏ó‡∏≠‡∏î‡πÑ‡∏ü‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏ô‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏ö", "4. ‡∏Ñ‡∏•‡∏∏‡∏Å‡∏ô‡πâ‡∏≥‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÅ‡∏•‡∏∞‡πÄ‡∏ô‡∏¢ ‡∏û‡∏±‡∏Å‡πÉ‡∏´‡πâ‡πÄ‡∏¢‡πá‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏™‡πà‡∏ñ‡∏∏‡∏á"], ingredients: [{name: "‡∏Å‡∏•‡πâ‡∏ß‡∏¢‡∏ô‡πâ‡∏≥‡∏ß‡πâ‡∏≤‡∏î‡∏¥‡∏ö", price: "15 ‡∏ö./‡∏´‡∏ß‡∏µ"}, {name: "‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡∏ó‡∏£‡∏≤‡∏¢", price: "24 ‡∏ö./kg"}, {name: "‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏û‡∏∑‡∏ä", price: "48 ‡∏ö./‡∏•‡∏¥‡∏ï‡∏£"}, {name: "‡πÄ‡∏ô‡∏¢/‡∏°‡∏≤‡∏Å‡∏≤‡∏£‡∏µ‡∏ô", price: "35 ‡∏ö./‡∏ñ‡∏∏‡∏á"}] },
    "‡πÅ‡∏´‡∏ô‡∏°": { steps: ["1. ‡∏ö‡∏î‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏°‡∏π‡πÅ‡∏•‡∏∞‡∏´‡∏ô‡∏±‡∏á‡∏´‡∏°‡∏π‡πÉ‡∏´‡πâ‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î", "2. ‡∏ú‡∏™‡∏°‡∏Å‡∏£‡∏∞‡πÄ‡∏ó‡∏µ‡∏¢‡∏° ‡πÄ‡∏Å‡∏•‡∏∑‡∏≠ ‡∏Ç‡πâ‡∏≤‡∏ß‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß‡∏™‡∏∏‡∏Å ‡∏ô‡∏ß‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ô", "3. ‡πÉ‡∏™‡πà‡∏î‡∏¥‡∏ô‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ß‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ (‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ)", "4. ‡∏´‡πà‡∏≠‡∏î‡πâ‡∏ß‡∏¢‡πÉ‡∏ö‡∏ï‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡∏∏‡∏á‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å ‡∏°‡∏±‡∏î‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡∏ô", "5. ‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏ß‡πâ 2-3 ‡∏ß‡∏±‡∏ô‡∏à‡∏ô‡∏°‡∏µ‡∏£‡∏™‡πÄ‡∏õ‡∏£‡∏µ‡πâ‡∏¢‡∏ß"], ingredients: [{name: "‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏°‡∏π‡∏ö‡∏î", price: "140 ‡∏ö./kg"}, {name: "‡∏´‡∏ô‡∏±‡∏á‡∏´‡∏°‡∏π", price: "60 ‡∏ö./kg"}, {name: "‡∏Å‡∏£‡∏∞‡πÄ‡∏ó‡∏µ‡∏¢‡∏°", price: "80 ‡∏ö./kg"}, {name: "‡πÄ‡∏Å‡∏•‡∏∑‡∏≠", price: "12 ‡∏ö./‡∏´‡πà‡∏≠"}] },
    "‡∏°‡∏∞‡∏°‡πà‡∏ß‡∏á‡∏î‡∏≠‡∏á": { steps: ["1. ‡∏õ‡∏≠‡∏Å‡πÄ‡∏õ‡∏•‡∏∑‡∏≠‡∏Å‡∏°‡∏∞‡∏°‡πà‡∏ß‡∏á ‡∏•‡πâ‡∏≤‡∏á‡∏¢‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏™‡∏∞‡∏≠‡∏≤‡∏î", "2. ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÉ‡∏™‡πà‡πÇ‡∏´‡∏•‡πÅ‡∏Å‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡∏±‡∏á‡∏´‡∏°‡∏±‡∏Å", "3. ‡∏ï‡πâ‡∏°‡∏ô‡πâ‡∏≥‡πÄ‡∏Å‡∏•‡∏∑‡∏≠ (‡πÄ‡∏Å‡∏•‡∏∑‡∏≠ 1 ‡∏™‡πà‡∏ß‡∏ô ‡∏ô‡πâ‡∏≥ 10 ‡∏™‡πà‡∏ß‡∏ô) ‡∏û‡∏±‡∏Å‡πÉ‡∏´‡πâ‡πÄ‡∏¢‡πá‡∏ô", "4. ‡πÄ‡∏ó‡∏ô‡πâ‡∏≥‡πÄ‡∏Å‡∏•‡∏∑‡∏≠‡πÉ‡∏™‡πà‡∏à‡∏ô‡∏ó‡πà‡∏ß‡∏° ‡∏Å‡∏î‡πÉ‡∏´‡πâ‡∏à‡∏°", "5. ‡∏î‡∏≠‡∏á‡πÑ‡∏ß‡πâ 15-30 ‡∏ß‡∏±‡∏ô"], ingredients: [{name: "‡∏°‡∏∞‡∏°‡πà‡∏ß‡∏á‡πÅ‡∏Å‡πâ‡∏ß‡∏î‡∏¥‡∏ö", price: "10-20 ‡∏ö./kg"}, {name: "‡πÄ‡∏Å‡∏•‡∏∑‡∏≠‡πÅ‡∏Å‡∏á", price: "12 ‡∏ö./‡∏´‡πà‡∏≠"}, {name: "‡πÇ‡∏´‡∏•/‡∏ñ‡∏±‡∏á", price: "40-100 ‡∏ö."}] }
};

const seasonalData = { 0: ["‡∏°‡∏∞‡∏Ç‡∏≤‡∏°", "‡∏™‡∏ï‡∏£‡∏≠‡∏ß‡πå‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏µ"], 1: ["‡∏≠‡∏á‡∏∏‡πà‡∏ô", "‡∏Å‡∏•‡πâ‡∏ß‡∏¢‡∏´‡∏≠‡∏°"], 2: ["‡∏°‡∏∞‡∏¢‡∏á‡∏ä‡∏¥‡∏î", "‡∏°‡∏∞‡∏°‡πà‡∏ß‡∏á‡∏î‡∏¥‡∏ö"], 3: ["‡∏°‡∏∞‡∏°‡πà‡∏ß‡∏á‡∏™‡∏∏‡∏Å", "‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô"], 4: ["‡πÄ‡∏á‡∏≤‡∏∞", "‡∏™‡∏•‡∏∞"], 5: ["‡∏°‡∏±‡∏á‡∏Ñ‡∏∏‡∏î", "‡∏´‡∏ô‡πà‡∏≠‡πÑ‡∏°‡πâ"], 6: ["‡∏•‡∏≥‡πÑ‡∏¢", "‡∏Ç‡πâ‡∏≤‡∏ß‡πÇ‡∏û‡∏î"], 7: ["‡∏™‡πâ‡∏°‡πÇ‡∏≠", "‡∏•‡∏≠‡∏á‡∏Å‡∏≠‡∏á"], 8: ["‡∏™‡πâ‡∏°‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏´‡∏ß‡∏≤‡∏ô", "‡∏ù‡∏£‡∏±‡πà‡∏á"], 9: ["‡∏Å‡∏£‡∏∞‡πÄ‡∏à‡∏µ‡πä‡∏¢‡∏ö‡πÅ‡∏î‡∏á", "‡∏°‡∏∞‡∏Ç‡∏≤‡∏°‡∏õ‡πâ‡∏≠‡∏°"], 10: ["‡πÄ‡∏ú‡∏∑‡∏≠‡∏Å", "‡∏°‡∏±‡∏ô‡πÄ‡∏ó‡∏®"], 11: ["‡∏û‡∏∏‡∏ó‡∏£‡∏≤", "‡∏ú‡∏±‡∏Å‡∏Å‡∏≤‡∏î‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß"] };
const monthNames = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];

/* ================= 2. CORE LOGIC ================= */
function initApp() {
    renderCategories();
    updateDate();
}

function updateDate() {
    const d = new Date();
    // Optimized date string creation
    document.getElementById('price-update-date').innerHTML = `<i class="fa-regular fa-clock mr-1"></i>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï: ${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()+543} ${d.getHours()}:${d.getMinutes().toString().padStart(2,'0')}`;
}

function getRecipeData(name, categoryKey) {
    if (recipeDB[name]) return recipeDB[name];
    // Fallback data generation
    let steps = [], ingredients = [];
    if (categoryKey.includes("‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå")) {
        steps = ["1. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå ‡∏•‡πâ‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏™‡∏∞‡∏≠‡∏≤‡∏î ‡∏´‡∏±‡πà‡∏ô‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£", "2. ‡∏´‡∏°‡∏±‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏Å‡∏•‡∏∑‡∏≠ ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏• ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏® 1-2 ‡∏ä‡∏°.", "3. ‡∏ô‡∏≥‡πÑ‡∏õ‡∏ï‡∏≤‡∏Å‡πÅ‡∏î‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏ö‡πÅ‡∏´‡πâ‡∏á‡∏à‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà", "4. ‡∏ô‡∏≥‡πÑ‡∏õ‡∏ó‡∏≠‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏™‡∏∏‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏£‡∏£‡∏à‡∏∏"];
        ingredients = [{name: "‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏´‡∏•‡∏±‡∏Å", price: "150 ‡∏ö./kg"}, {name: "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∏‡∏á‡∏£‡∏™", price: "30 ‡∏ö./‡∏ä‡∏∏‡∏î"}, {name: "‡πÅ‡∏û‡πá‡∏Ñ‡πÄ‡∏Å‡∏à", price: "2 ‡∏ö./‡πÉ‡∏ö"}];
    } else if (categoryKey.includes("‡∏î‡∏≠‡∏á")) {
        steps = ["1. ‡∏•‡πâ‡∏≤‡∏á‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÅ‡∏•‡∏∞‡∏õ‡∏≠‡∏Å‡πÄ‡∏õ‡∏•‡∏∑‡∏≠‡∏Å", "2. ‡πÄ‡∏Ñ‡∏•‡πâ‡∏≤‡πÄ‡∏Å‡∏•‡∏∑‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏•‡πà‡∏ô‡πâ‡∏≥‡∏≠‡∏≠‡∏Å ‡∏û‡∏±‡∏Å‡πÑ‡∏ß‡πâ 1 ‡∏Ñ‡∏∑‡∏ô", "3. ‡∏ï‡πâ‡∏°‡∏ô‡πâ‡∏≥‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°/‡∏ô‡πâ‡∏≥‡∏î‡∏≠‡∏á ‡∏û‡∏±‡∏Å‡πÉ‡∏´‡πâ‡πÄ‡∏¢‡πá‡∏ô", "4. ‡πÄ‡∏ó‡πÉ‡∏™‡πà‡∏†‡∏≤‡∏ä‡∏ô‡∏∞ ‡∏õ‡∏¥‡∏î‡∏ù‡∏≤‡πÉ‡∏´‡πâ‡∏™‡∏ô‡∏¥‡∏ó ‡∏î‡∏≠‡∏á‡πÑ‡∏ß‡πâ 7-14 ‡∏ß‡∏±‡∏ô"];
        ingredients = [{name: "‡∏ú‡∏±‡∏Å/‡∏ú‡∏•‡πÑ‡∏°‡πâ‡∏™‡∏î", price: "20 ‡∏ö./kg"}, {name: "‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•/‡πÄ‡∏Å‡∏•‡∏∑‡∏≠", price: "20 ‡∏ö./kg"}, {name: "‡πÇ‡∏´‡∏•‡πÅ‡∏Å‡πâ‡∏ß", price: "45 ‡∏ö."}];
    } else if (categoryKey.includes("‡∏Ç‡∏ô‡∏°")) {
        steps = ["1. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÅ‡∏õ‡πâ‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏´‡∏•‡∏±‡∏Å", "2. ‡∏ú‡∏™‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏™‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏ô‡∏ß‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ô", "3. ‡∏Ç‡∏∂‡πâ‡∏ô‡∏£‡∏π‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡∏ô‡∏≥‡πÑ‡∏õ‡∏ó‡∏≠‡∏î/‡∏≠‡∏ö", "4. ‡∏û‡∏±‡∏Å‡πÉ‡∏´‡πâ‡πÄ‡∏¢‡πá‡∏ô‡∏™‡∏ô‡∏¥‡∏ó ‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏™‡πà‡∏†‡∏≤‡∏ä‡∏ô‡∏∞‡∏õ‡∏¥‡∏î‡∏°‡∏¥‡∏î‡∏ä‡∏¥‡∏î"];
        ingredients = [{name: "‡πÅ‡∏õ‡πâ‡∏á/‡∏ò‡∏±‡∏ç‡∏û‡∏∑‡∏ä", price: "35 ‡∏ö./kg"}, {name: "‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•/‡∏Å‡∏∞‡∏ó‡∏¥", price: "40 ‡∏ö./‡∏ä‡∏∏‡∏î"}, {name: "‡πÅ‡∏Å‡πä‡∏™", price: "10 ‡∏ö."}];
    } else {
        steps = ["1. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏´‡∏•‡∏±‡∏Å ‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î", "2. ‡∏õ‡∏£‡∏∏‡∏á‡∏£‡∏™‡∏ï‡∏≤‡∏°‡∏™‡∏π‡∏ï‡∏£‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô", "3. ‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πâ‡∏≠‡∏ô (‡∏ï‡πâ‡∏°/‡∏ô‡∏∂‡πà‡∏á/‡∏ó‡∏≠‡∏î)", "4. ‡∏ö‡∏£‡∏£‡∏à‡∏∏‡πÉ‡∏™‡πà‡∏†‡∏≤‡∏ä‡∏ô‡∏∞‡∏Ç‡∏ì‡∏∞‡∏£‡πâ‡∏≠‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏¢‡πá‡∏ô‡∏ï‡∏≤‡∏°‡∏ä‡∏ô‡∏¥‡∏î"];
        ingredients = [{name: "‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏´‡∏•‡∏±‡∏Å", price: "50 ‡∏ö./kg"}, {name: "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∏‡∏á", price: "15 ‡∏ö."}, {name: "‡∏ö‡∏£‡∏£‡∏à‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå", price: "3 ‡∏ö."}];
    }
    return { steps, ingredients };
}

function openRecipeModal(name) {
    let category = "‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ";
    for (const [cat, items] of Object.entries(foodCategories)) {
        if (items.includes(name)) { category = cat; break; }
    }
    const data = getRecipeData(name, category);
    document.getElementById('recipe-title').innerText = name;
    document.getElementById('recipe-category').innerText = category;
    document.getElementById('recipe-steps').innerHTML = data.steps.map(s => `<li>${s}</li>`).join('');
    renderIngredientsTable(data.ingredients);
    
    // Reset Calculator
    document.getElementById('calc-total-input').value = '';
    document.getElementById('calc-units').value = '';
    document.getElementById('cost-per-unit').innerText = '0.00';
    openModal('recipe-modal');
}

function renderIngredientsTable(ingredients) {
    let total = 0;
    const html = ingredients.map((ing) => {
        const match = ing.price.match(/(\d+(\.\d+)?)/);
        const val = match ? parseFloat(match[0]) : 0;
        total += val;
        return `<tr><td class="px-3 py-2 text-gray-600">${ing.name}</td><td class="px-3 py-2 text-right font-medium text-gray-800 price-cell" data-original="${val}" data-suffix="${ing.price.replace(match[0], '')}">${ing.price}</td></tr>`;
    }).join('');
    document.getElementById('recipe-ingredients').innerHTML = html;
    document.getElementById('ingredients-total-cost').innerText = `~${Math.ceil(total)} ‡∏ö‡∏≤‡∏ó`;
}

function updateMarketPricesAI() {
    const btnIcon = document.querySelector('#ai-update-btn i');
    if(btnIcon.classList.contains('fa-spin')) return; // Prevent double click

    btnIcon.classList.add('fa-spin');
    updateDate();
    
    // Optimize: Batch DOM updates handled by browser, but we minimize reflows by calculating first
    const cells = document.querySelectorAll('.price-cell');
    let newTotal = 0;
    
    cells.forEach(cell => {
        const originalVal = parseFloat(cell.dataset.original);
        const fluctuation = (Math.random() * 0.25) - 0.10;
        const newVal = Math.ceil(originalVal * (1 + fluctuation));
        cell.innerText = `${newVal}${cell.dataset.suffix}`;
        newTotal += newVal;
        cell.classList.add('text-green-600');
    });
    
    document.getElementById('ingredients-total-cost').innerText = `~${newTotal} ‡∏ö‡∏≤‡∏ó`;
    setTimeout(() => {
        btnIcon.classList.remove('fa-spin');
        cells.forEach(cell => cell.classList.remove('text-green-600'));
    }, 600);
}

function liveCalculate() {
    const total = parseFloat(document.getElementById('calc-total-input').value) || 0;
    const units = parseFloat(document.getElementById('calc-units').value) || 1;
    const perUnit = units > 0 ? (total / units) : 0;
    document.getElementById('cost-per-unit').innerText = perUnit.toFixed(2);
}

/* ================= 3. RENDER UI ================= */
function renderCategories(filterText = "") {
    const container = document.getElementById('category-container');
    container.innerHTML = "";
    let html = "";
    let hasResult = false;

    for (const [category, items] of Object.entries(foodCategories)) {
        const filteredItems = items.filter(item => item.includes(filterText));
        if (filteredItems.length > 0) {
            hasResult = true;
            const isOpen = filterText || category.includes("‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå") ? "open" : "";
            const itemsHtml = filteredItems.map(item => `
                <div class="food-card p-3 flex flex-col gap-2 items-center text-center cursor-pointer hover:border-orange-300 group select-none" onclick="openRecipeModal('${item}')">
                    <div class="w-10 h-10 rounded-full bg-orange-50 text-orange-500 flex items-center justify-center group-active:scale-90 transition">
                        <i class="fa-solid fa-utensils text-sm"></i>
                    </div>
                    <span class="text-sm font-medium text-gray-600 line-clamp-2 leading-tight">${item}</span>
                </div>
            `).join('');

            html += `
                <details class="group bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden" ${isOpen}>
                    <summary class="px-5 py-4 flex justify-between items-center font-bold text-gray-700 bg-gray-50/50 hover:bg-gray-100 transition select-none">
                        <span class="flex items-center gap-2 text-base">${category} <span class="bg-white px-2 py-0.5 rounded-full text-xs border text-gray-400 font-normal">${filteredItems.length}</span></span>
                        <i class="fa-solid fa-chevron-down text-gray-400 chevron text-sm"></i>
                    </summary>
                    <div class="p-4 grid grid-cols-2 md:grid-cols-3 gap-3 bg-white">${itemsHtml}</div>
                </details>`;
        }
    }
    
    if (!hasResult) html = `<div class="text-center py-10 text-gray-400"><i class="fa-solid fa-box-open text-4xl mb-2 opacity-50"></i><br>‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</div>`;
    container.innerHTML = html;
}

document.getElementById('searchInput').addEventListener('input', (e) => renderCategories(e.target.value.trim()));

/* ================= 4. UTILS ================= */
function openModal(id) {
    document.getElementById(id).classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    if(id === 'calendar-modal') initCalendar();
}
function closeModal(id) {
    document.getElementById(id).classList.add('hidden');
    document.body.style.overflow = '';
}
function initCalendar() {
    const d = new Date();
    const monthIdx = d.getMonth();
    document.getElementById('calendar-month-display').innerText = monthNames[monthIdx];
    const items = seasonalData[monthIdx] || ["‡∏ú‡∏±‡∏Å‡∏ï‡∏≤‡∏°‡∏§‡∏î‡∏π‡∏Å‡∏≤‡∏•", "‡∏ú‡∏•‡πÑ‡∏°‡πâ‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô"];
    const html = items.map(item => `<div class="bg-blue-50 text-blue-800 px-3 py-2 rounded-lg text-center font-bold text-sm border border-blue-100">${item}</div>`).join('');
    document.getElementById('seasonal-items').innerHTML = html;
}

// Ensure DOM is ready (Stability)
document.addEventListener('DOMContentLoaded', initApp);

/* ================= 5. CHATBOT ================= */
const BACKEND_URL = 'https://us-central1-law-ai-14740.cloudfunctions.net/api/chat';
let chatHistory = [];
const SYSTEM_PROMPT = { role: "user", parts: [{ text: "System Instruction: ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ '‡∏ô‡πâ‡∏≠‡∏á‡πÅ‡∏õ‡∏£‡∏£‡∏π‡∏õ' AI ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ñ‡∏ô‡∏≠‡∏°‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ‡∏£‡πà‡∏≤‡πÄ‡∏£‡∏¥‡∏á ‡∏™‡∏∏‡∏†‡∏≤‡∏û ‡∏ï‡∏≠‡∏ö‡∏™‡∏±‡πâ‡∏ô‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö ‡πÄ‡∏ô‡πâ‡∏ô‡∏™‡∏π‡∏ï‡∏£‡∏ó‡∏≥‡∏Å‡∏¥‡∏ô‡∏ó‡∏≥‡∏Ç‡∏≤‡∏¢" }] };

const fab = document.getElementById('fab-chat-toggle');
const chatModal = document.getElementById('chatbot-modal');
const chatBackdrop = document.getElementById('chat-backdrop');
const chatCard = document.getElementById('chat-card');
const chatClose = document.getElementById('chatbot-close-btn');
const chatList = document.getElementById('chat-history');
const userInput = document.getElementById('user-input');
const sendBtn = document.getElementById('send-btn');
const thinking = document.getElementById('thinking-indicator');

fab.addEventListener('click', () => {
    chatModal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    requestAnimationFrame(() => { chatBackdrop.classList.remove('opacity-0'); chatCard.classList.remove('translate-y-full'); });
    fab.classList.add('scale-0');
    if(chatHistory.length === 0) chatHistory = [SYSTEM_PROMPT];
});

function closeChat() {
    chatBackdrop.classList.add('opacity-0'); chatCard.classList.add('translate-y-full');
    setTimeout(() => { chatModal.classList.add('hidden'); document.body.style.overflow = ''; }, 300);
    fab.classList.remove('scale-0');
}
chatClose.addEventListener('click', closeChat);
chatBackdrop.addEventListener('click', closeChat);

function appendMsg(text, sender) {
    const isUser = sender === 'user';
    const div = document.createElement('div');
    div.className = `flex items-start gap-2 ${isUser ? 'flex-row-reverse' : ''} mb-2 fade-in`;
    div.innerHTML = `<div class="w-8 h-8 rounded-full flex items-center justify-center text-sm border ${isUser ? 'bg-gray-200' : 'bg-orange-100 border-orange-200'} shrink-0">${isUser ? 'üë§' : 'ü§ñ'}</div><div class="${isUser ? 'bg-orange-500 text-white' : 'bg-white border border-gray-100 text-gray-700'} p-3 rounded-2xl ${isUser ? 'rounded-tr-none' : 'rounded-tl-none'} text-sm shadow-sm max-w-[85%] leading-relaxed">${text.replace(/\n/g, '<br>')}</div>`;
    chatList.appendChild(div);
    chatList.scrollTop = chatList.scrollHeight;
}

async function sendMessage() {
    const text = userInput.value.trim();
    if (!text) return;
    userInput.value = ''; userInput.style.height = '44px';
    appendMsg(text, 'user');
    chatHistory.push({ role: "user", parts: [{ text: text }] });
    thinking.classList.remove('hidden'); chatList.scrollTop = chatList.scrollHeight;

    try {
        const res = await fetch(BACKEND_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ history: chatHistory }) });
        const data = await res.json();
        const reply = data.reply || "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß";
        chatHistory.push({ role: "model", parts: [{ text: reply }] });
        appendMsg(reply, 'model');
    } catch (e) { appendMsg("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö üòì", 'model'); } 
    finally { thinking.classList.add('hidden'); }
}

sendBtn.addEventListener('click', sendMessage);
userInput.addEventListener('input', function() { this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px'; });
document.getElementById('new-chat-btn').addEventListener('click', () => { chatList.innerHTML = `<div class="text-center text-xs text-gray-300 py-4">-- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÉ‡∏´‡∏°‡πà --</div>`; chatHistory = [SYSTEM_PROMPT]; });
</script>

<style>
.fade-in { animation: fadeIn 0.3s ease-out forwards; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
</style>

</body>
</html>
