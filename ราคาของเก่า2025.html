<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡πÄ‡∏ä‡πá‡∏Ñ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏¢‡∏∞‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏• (EcoPrice AI)</title>

<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.tailwindcss.com"></script>

<script>
tailwind.config = {
  theme: {
    extend: {
      fontFamily: { sans: ['Prompt', 'sans-serif'] },
      colors: {
        primary: '#10B981', secondary: '#065F46'
      }
    }
  }
}
</script>

<style>
body { background:#f0fdf4; font-family:'Prompt',sans-serif }
.price-flash { animation: flash 1s }
@keyframes flash {
  0%{background:#d1fae5}
  100%{background:#fff}
}
</style>
</head>

<body class="pb-24">

<!-- ================= HEADER ================= -->
<header class="bg-gradient-to-r from-primary to-secondary text-white p-6 rounded-b-3xl">
  <div class="flex justify-between items-start">
    <div>
      <h1 class="text-2xl font-bold"><i class="fa-solid fa-recycle mr-2"></i>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h1>
      <p id="currentDate" class="text-sm text-emerald-100"></p>
    </div>
    <button onclick="updatePricesWithAI()"
      class="bg-white/20 px-3 py-2 rounded-lg text-xs border border-white/30">
      <i class="fa-solid fa-sync mr-1"></i>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    </button>
  </div>
</header>

<!-- ================= PRICE LIST ================= -->
<div class="px-4 mt-4">
  <div class="flex justify-between items-center mb-2">
    <h2 class="font-semibold">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó/‡∏Å‡∏Å.)</h2>
    <span class="text-xs bg-white px-2 py-1 rounded border flex items-center">
      <span id="statusDot" class="w-2 h-2 bg-gray-300 rounded-full mr-2"></span>
      <span id="updateTime">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï...</span>
    </span>
  </div>
  <div id="priceList" class="space-y-3"></div>
</div>

<!-- ================= CHAT FLOAT ================= -->
<button id="fab-chat-toggle"
class="fixed bottom-24 right-4 w-14 h-14 rounded-full bg-primary text-white text-2xl shadow">
üí¨
</button>

<div id="chatbot-modal" class="fixed inset-0 bg-gray-100 hidden z-50">
  <div class="flex flex-col h-full">
    <header class="bg-primary text-white p-3 flex justify-between">
      <b>AI ‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•</b>
      <button onclick="closeChat()">‚úñ</button>
    </header>

    <main id="chat-history" class="flex-1 overflow-y-auto p-3 space-y-3">
      <div class="bg-white p-3 rounded shadow">
        ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ñ‡∏≤‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏¢‡∏∞‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö
      </div>
    </main>

    <footer class="p-3 bg-white flex gap-2">
      <input id="user-input" class="flex-1 border rounded p-2"
        placeholder="‡∏ñ‡∏≤‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤ ‡πÄ‡∏ä‡πà‡∏ô ‡∏ó‡∏≠‡∏á‡πÅ‡∏î‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ">
      <button onclick="handleChatSend()"
        class="bg-primary text-white px-4 rounded">‡∏™‡πà‡∏á</button>
    </footer>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const BACKEND_URL = 'https://odd-night-9879.tontakankeawpang321.workers.dev';

// ‚≠ê NEW: cooldown ‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤
let lastAIUpdate = 0;
const AI_COOLDOWN = 30 * 60 * 1000;

/* ================= DATA ================= */
let wasteData = [
              { id: 1, name: '‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏Ç‡∏≤‡∏ß‡∏î‡∏≥', category: 'paper', price: 4, trend: 'stable', icon: 'fa-file-alt', color: 'text-gray-500' },
  { id: 2, name: '‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏•‡∏π‡∏Å‡∏ü‡∏π‡∏Å (‡∏•‡∏±‡∏á)', category: 'paper', price: 3, trend: 'stable', icon: 'fa-box-open', color: 'text-yellow-700' },
  { id: 3, name: '‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå', category: 'paper', price: 2.5, trend: 'stable', icon: 'fa-newspaper', color: 'text-gray-600' },
  { id: 4, name: '‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÄ‡∏•‡πà‡∏°/‡∏™‡∏°‡∏∏‡∏î', category: 'paper', price: 2, trend: 'stable', icon: 'fa-book', color: 'text-blue-800' },

  { id: 5, name: '‡∏Ç‡∏ß‡∏î PET (‡πÉ‡∏™)', category: 'plastic', price: 14, trend: 'stable', icon: 'fa-bottle-water', color: 'text-blue-400' },
  { id: 6, name: '‡∏Ç‡∏ß‡∏î PET (‡∏™‡∏µ)', category: 'plastic', price: 8, trend: 'stable', icon: 'fa-bottle-water', color: 'text-green-500' },
  { id: 7, name: '‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å HDPE', category: 'plastic', price: 18, trend: 'stable', icon: 'fa-jug-detergent', color: 'text-gray-300' },
  { id: 8, name: '‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å PP', category: 'plastic', price: 10, trend: 'stable', icon: 'fa-chair', color: 'text-red-400' },
  { id: 9, name: '‡∏ó‡πà‡∏≠ PVC (‡∏ü‡πâ‡∏≤)', category: 'plastic', price: 6, trend: 'stable', icon: 'fa-circle-notch', color: 'text-blue-600' },

  { id: 10, name: '‡∏ó‡∏≠‡∏á‡πÅ‡∏î‡∏á (‡∏™‡∏≤‡∏¢‡πÑ‡∏ü‡∏õ‡∏≠‡∏Å)', category: 'metal', price: 280, trend: 'up', icon: 'fa-bolt', color: 'text-orange-600' },
  { id: 11, name: '‡∏ó‡∏≠‡∏á‡πÅ‡∏î‡∏á (‡πÄ‡∏ú‡∏≤)', category: 'metal', price: 240, trend: 'stable', icon: 'fa-fire', color: 'text-red-700' },
  { id: 12, name: '‡∏≠‡∏•‡∏π‡∏°‡∏¥‡πÄ‡∏ô‡∏µ‡∏¢‡∏° (‡∏Å‡∏£‡∏∞‡∏õ‡πã‡∏≠‡∏á)', category: 'metal', price: 70, trend: 'stable', icon: 'fa-can-food', color: 'text-gray-400' },
  { id: 13, name: '‡∏≠‡∏•‡∏π‡∏°‡∏¥‡πÄ‡∏ô‡∏µ‡∏¢‡∏° (‡∏´‡∏ô‡∏≤)', category: 'metal', price: 85, trend: 'stable', icon: 'fa-layer-group', color: 'text-gray-500' },
  { id: 14, name: '‡πÄ‡∏´‡∏•‡πá‡∏Å‡∏´‡∏ô‡∏≤', category: 'metal', price: 9, trend: 'stable', icon: 'fa-weight-hanging', color: 'text-gray-700' },
  { id: 15, name: '‡πÄ‡∏´‡∏•‡πá‡∏Å‡∏ö‡∏≤‡∏á/‡∏™‡∏±‡∏á‡∏Å‡∏∞‡∏™‡∏µ', category: 'metal', price: 7, trend: 'stable', icon: 'fa-sheet-plastic', color: 'text-gray-400' },
  { id: 16, name: '‡∏™‡πÅ‡∏ï‡∏ô‡πÄ‡∏•‡∏™ 304', category: 'metal', price: 45, trend: 'stable', icon: 'fa-utensils', color: 'text-gray-400' },

  { id: 17, name: '‡∏Ç‡∏ß‡∏î‡πÅ‡∏Å‡πâ‡∏ß (‡∏£‡∏ß‡∏°)', category: 'glass', price: 1, trend: 'stable', icon: 'fa-wine-bottle', color: 'text-amber-800' },
  { id: 18, name: '‡∏Ç‡∏ß‡∏î‡πÅ‡∏Å‡πâ‡∏ß (‡πÉ‡∏™)', category: 'glass', price: 2, trend: 'stable', icon: 'fa-wine-glass', color: 'text-blue-200' },
  { id: 19, name: '‡∏Ç‡∏ß‡∏î‡πÅ‡∏Å‡πâ‡∏ß (‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß)', category: 'glass', price: 1.5, trend: 'stable', icon: 'fa-wine-glass', color: 'text-green-700' },
  { id: 20, name: '‡∏Ç‡∏ß‡∏î‡πÅ‡∏Å‡πâ‡∏ß (‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•)', category: 'glass', price: 1.2, trend: 'stable', icon: 'fa-wine-glass', color: 'text-amber-700' },

  { id: 21, name: '‡πÄ‡∏®‡∏©‡∏Å‡∏£‡∏∞‡∏à‡∏Å‡πÅ‡∏ï‡∏Å', category: 'glass', price: 0.5, trend: 'down', icon: 'fa-triangle-exclamation', color: 'text-red-600' },

  { id: 22, name: '‡∏™‡∏≤‡∏¢‡πÑ‡∏ü‡∏£‡∏ß‡∏°', category: 'electronic', price: 35, trend: 'stable', icon: 'fa-plug', color: 'text-yellow-500' },
  { id: 23, name: '‡πÅ‡∏ú‡∏á‡∏ß‡∏á‡∏à‡∏£ PCB', category: 'electronic', price: 120, trend: 'up', icon: 'fa-microchip', color: 'text-green-600' },
  { id: 24, name: '‡∏≠‡∏∞‡πÅ‡∏î‡∏õ‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÑ‡∏ü', category: 'electronic', price: 15, trend: 'stable', icon: 'fa-charging-station', color: 'text-gray-500' },
  { id: 25, name: '‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà‡πÅ‡∏´‡πâ‡∏á', category: 'electronic', price: 10, trend: 'stable', icon: 'fa-battery-half', color: 'text-red-500' },
  { id: 26, name: '‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà‡∏•‡∏¥‡πÄ‡∏ò‡∏µ‡∏¢‡∏°', category: 'electronic', price: 60, trend: 'up', icon: 'fa-battery-full', color: 'text-green-500' },

  { id: 27, name: '‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÄ‡∏Å‡πà‡∏≤', category: 'electronic', price: 40, trend: 'up', icon: 'fa-mobile-screen', color: 'text-blue-500' },
  { id: 28, name: '‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÄ‡∏Å‡πà‡∏≤', category: 'electronic', price: 18, trend: 'stable', icon: 'fa-desktop', color: 'text-gray-600' },
  { id: 29, name: '‡∏à‡∏≠ LCD', category: 'electronic', price: 25, trend: 'stable', icon: 'fa-tv', color: 'text-black' },
  { id: 30, name: '‡∏™‡∏≤‡∏¢‡∏ä‡∏≤‡∏£‡πå‡∏à', category: 'electronic', price: 12, trend: 'stable', icon: 'fa-cable-car', color: 'text-gray-400' },

  { id: 31, name: '‡∏ñ‡∏∏‡∏á‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å‡πÉ‡∏™', category: 'plastic', price: 2, trend: 'down', icon: 'fa-bag-shopping', color: 'text-gray-300' },
  { id: 32, name: '‡∏ü‡∏¥‡∏•‡πå‡∏°‡∏¢‡∏∑‡∏î', category: 'plastic', price: 5, trend: 'stable', icon: 'fa-scroll', color: 'text-blue-300' },
  { id: 33, name: '‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÇ‡∏ü‡∏°', category: 'plastic', price: 1, trend: 'down', icon: 'fa-cube', color: 'text-gray-200' },
  { id: 34, name: '‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å‡πÅ‡∏Ç‡πá‡∏á‡∏ú‡∏™‡∏°', category: 'plastic', price: 6, trend: 'stable', icon: 'fa-puzzle-piece', color: 'text-purple-400' },
  { id: 35, name: '‡∏ù‡∏≤‡∏Ç‡∏ß‡∏î‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å', category: 'plastic', price: 7, trend: 'stable', icon: 'fa-circle', color: 'text-red-500' },

  { id: 36, name: '‡∏ó‡∏≠‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á', category: 'metal', price: 160, trend: 'up', icon: 'fa-ring', color: 'text-yellow-600' },
  { id: 37, name: '‡∏ï‡∏∞‡∏Å‡∏±‡πà‡∏ß', category: 'metal', price: 55, trend: 'stable', icon: 'fa-weight-scale', color: 'text-gray-800' },
  { id: 38, name: '‡∏™‡∏≤‡∏¢‡∏ó‡∏≠‡∏á‡πÅ‡∏î‡∏á‡πÑ‡∏°‡πà‡∏õ‡∏≠‡∏Å', category: 'metal', price: 180, trend: 'stable', icon: 'fa-wave-square', color: 'text-orange-500' },
  { id: 39, name: '‡πÄ‡∏®‡∏©‡πÄ‡∏´‡∏•‡πá‡∏Å‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå', category: 'metal', price: 10, trend: 'up', icon: 'fa-car', color: 'text-gray-700' },
  { id: 40, name: '‡∏•‡∏ß‡∏î‡πÄ‡∏´‡∏•‡πá‡∏Å', category: 'metal', price: 8, trend: 'stable', icon: 'fa-grip-lines', color: 'text-gray-500' },

  { id: 41, name: '‡∏¢‡∏≤‡∏á‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå', category: 'other', price: 3, trend: 'stable', icon: 'fa-circle-dot', color: 'text-black' },
  { id: 42, name: '‡πÄ‡∏®‡∏©‡∏ú‡πâ‡∏≤', category: 'other', price: 4, trend: 'stable', icon: 'fa-shirt', color: 'text-indigo-400' },
  { id: 43, name: '‡πÑ‡∏°‡πâ‡∏û‡∏≤‡πÄ‡∏•‡∏ó', category: 'other', price: 2, trend: 'stable', icon: 'fa-tree', color: 'text-green-700' },
  { id: 44, name: '‡πÄ‡∏®‡∏©‡πÑ‡∏°‡πâ', category: 'other', price: 1.5, trend: 'stable', icon: 'fa-tree-city', color: 'text-brown-600' },

  { id: 45, name: '‡∏´‡∏•‡∏≠‡∏î LED', category: 'electronic', price: 30, trend: 'up', icon: 'fa-lightbulb', color: 'text-green-400' },
  { id: 46, name: '‡∏´‡∏•‡∏≠‡∏î‡πÑ‡∏ü‡πÄ‡∏Å‡πà‡∏≤', category: 'electronic', price: 5, trend: 'stable', icon: 'fa-lightbulb', color: 'text-yellow-400' },

  { id: 47, name: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡πÄ‡∏Å‡πà‡∏≤', category: 'electronic', price: 15, trend: 'stable', icon: 'fa-blender', color: 'text-gray-500' },
  { id: 48, name: '‡∏ï‡∏π‡πâ‡πÄ‡∏¢‡πá‡∏ô‡πÄ‡∏Å‡πà‡∏≤', category: 'electronic', price: 12, trend: 'stable', icon: 'fa-snowflake', color: 'text-cyan-400' },
  { id: 49, name: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ã‡∏±‡∏Å‡∏ú‡πâ‡∏≤‡πÄ‡∏Å‡πà‡∏≤', category: 'electronic', price: 14, trend: 'stable', icon: 'fa-water', color: 'text-blue-500' },
  { id: 50, name: '‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÄ‡∏ß‡∏ü‡πÄ‡∏Å‡πà‡∏≤', category: 'electronic', price: 10, trend: 'stable', icon: 'fa-box', color: 'text-gray-500' }
        ];


/* ================= INIT ================= */
document.getElementById('currentDate').innerText =
 new Date().toLocaleDateString('th-TH',{dateStyle:'full'});
renderItems();

/* ================= RENDER ================= */
function renderItems(animate=false){
 const box=document.getElementById('priceList');
 box.innerHTML='';
 wasteData.forEach((i,idx)=>{
  const el=document.createElement('div');
  el.className=`bg-white p-4 rounded shadow flex justify-between ${animate?'price-flash':''}`;
  el.innerHTML=`
   <div>
    <b>${i.name}</b>
    <div class="text-xs text-gray-400">${i.trend}</div>
   </div>
   <div class="font-bold text-primary">${i.price.toFixed(2)}</div>
  `;
  box.appendChild(el);
 });
}

/* ================= AI UPDATE ================= */
async function updatePricesWithAI(){
 const now=Date.now();
 if(now-lastAIUpdate<AI_COOLDOWN){
  alert('‡∏ï‡∏•‡∏≤‡∏î‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö');
  return;
 }
 lastAIUpdate=now;

 const items=wasteData.map(i=>({
  id:i.id,name:i.name,current_price:i.price
 }));

 const systemPrompt=`
You are a recycling price analyst in Thailand.
Rules:
- Use current_price as baseline
- Change ONLY 10‚Äì20% of items
- Typical movement +/- 3‚Äì8%
- Most items stay unchanged
- Return ONLY JSON
`;

 const response=await fetch(BACKEND_URL,{
  method:'POST',
  headers:{'Content-Type':'application/json'},
  body:JSON.stringify({
    history:[{role:'user',parts:[{text:systemPrompt+JSON.stringify(items)}]}]
  })
 });

 const data=await response.json();
 const json=JSON.parse(data.reply.replace(/```json|```/g,''));

 let changed=0;
 wasteData=wasteData.map(it=>{
  const u=json.find(x=>x.id===it.id);
  if(!u) return it;
  if(Number(u.price)===Number(it.price)) return it;
  changed++;
  return {...it,price:u.price,trend:u.trend};
 });

 renderItems(true);
 updateTime(changed);
}

/* ================= TIME ================= */
function updateTime(changed){
 document.getElementById('statusDot').className=
  'w-2 h-2 bg-green-500 rounded-full mr-2';
 document.getElementById('updateTime').innerText=
  changed===0?'‡∏ï‡∏•‡∏≤‡∏î‡∏ó‡∏£‡∏á‡∏ï‡∏±‡∏ß':
  '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï '+new Date().toLocaleTimeString('th-TH',{hour:'2-digit',minute:'2-digit'});
}

/* ================= CHAT ================= */
function getPriceContext(){
 return wasteData.map(i=>`- ${i.name}: ${i.price} ‡∏ö‡∏≤‡∏ó/‡∏Å‡∏Å.`).join('\n');
}

async function handleChatSend(){
 const q=document.getElementById('user-input').value.trim();
 if(!q) return;
 addChat(q,true);

 const prompt=`‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:\n${getPriceContext()}\n\n‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°:${q}`;

 const res=await fetch(BACKEND_URL,{
  method:'POST',
  headers:{'Content-Type':'application/json'},
  body:JSON.stringify({history:[{role:'user',parts:[{text:prompt}]}]})
 });

 const data=await res.json();
 addChat(data.reply,false);
 document.getElementById('user-input').value='';
}

function addChat(text,isUser){
 const box=document.getElementById('chat-history');
 const div=document.createElement('div');
 div.className=`p-3 rounded shadow ${isUser?'bg-primary text-white ml-auto':'bg-white'}`;
 div.innerHTML=text;
 box.appendChild(div);
 box.scrollTop=box.scrollHeight;
}

/* ================= CHAT UI ================= */
const chat=document.getElementById('chatbot-modal');
document.getElementById('fab-chat-toggle').onclick=()=>chat.classList.remove('hidden');
function closeChat(){chat.classList.add('hidden')}
</script>
</body>
</html>
