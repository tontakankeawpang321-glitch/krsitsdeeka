<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>เช็คราคาขยะรีไซเคิล (EcoPrice AI)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Prompt', 'sans-serif'] },
                    colors: {
                        primary: '#10B981', secondary: '#065F46', accent: '#F59E0B',
                        paper: '#F3F4F6', metal: '#9CA3AF', plastic: '#60A5FA', glass: '#A78BFA'
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f0fdf4; font-family: 'Prompt', sans-serif; -webkit-tap-highlight-color: transparent; }
        .price-item { transition: all 0.3s ease; }
        .price-flash { animation: flashHighlight 1s ease-out; }
        @keyframes flashHighlight {
            0% { background-color: #d1fae5; transform: scale(1.02); }
            100% { background-color: white; transform: scale(1); }
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Chatbot Custom Styles */
        .chat-bubble::before { content: ''; position: absolute; width: 0; height: 0; border-style: solid; }
        .chat-bubble-user::before { border-width: 0 12px 12px 12px; border-color: transparent transparent #10B981 transparent; top: -10px; right: 12px; }
        .chat-bubble-model::before { border-width: 0 12px 12px 12px; border-color: transparent transparent #e5e7eb transparent; top: -10px; left: 12px; }
        
        .gemini-thinking-bar { position: relative; width: 100%; height: 4px; background-color: #e0e0e0; border-radius: 2px; overflow: hidden; }
        .gemini-thinking-bar::before { content: ''; position: absolute; top: 0; left: 0; height: 100%; width: 100%; background: linear-gradient(90deg, #10B981, #34D399, #10B981); background-size: 200% 100%; animation: thinking-gradient 2s linear infinite; }
        @keyframes thinking-gradient { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        /* FAB Position Adjusted for Bottom Nav */
        #fab-chat-toggle { 
            position: fixed; 
            bottom: 90px; /* Raised to clear nav bar */
            right: 20px; 
            width: 56px; 
            height: 56px; 
            background-color: #10B981; 
            color: white; 
            border-radius: 50%; 
            font-size: 24px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4); 
            cursor: pointer; 
            z-index: 45; 
            transition: all 0.3s; 
        }
        #chatbot-modal.chatbot-hidden { opacity: 0; transform: translateY(100%); pointer-events: none; }
        #chatbot-modal { position: fixed; inset: 0; z-index: 1000; transition: all 0.3s; }

        /* FB Container Styling */
        .fb-container {
            width: 100%;
            background: white;
            border-radius: 1.25rem;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
            border: 1px solid #f0f0f0;
        }
        .fb-display-wrapper {
            width: 100%;
            height: calc(100vh - 220px); /* Adjust height dynamically */
            min-height: 400px;
            display: block;
            background: white;
            position: relative;
        }
        .fb-display-wrapper iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Bottom Nav Styles */
        .nav-item { transition: color 0.2s; position: relative; }
        .nav-item.active { color: #10B981; }
        .nav-item.active::after {
            content: ''; position: absolute; top: -12px; left: 50%; transform: translateX(-50%);
            width: 40px; height: 4px; background-color: #10B981; border-radius: 0 0 4px 4px;
        }

        /* Animation for View Switching */
        .view-content { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="text-gray-800 pb-24 bg-gray-50">
    
    <!-- โหลด SDK ของ Facebook -->
    <div id="fb-root"></div>
    <script async defer crossorigin="anonymous" 
        src="https://connect.facebook.net/th_TH/sdk.js#xfbml=1&version=v19.0" nonce="abc123">
    </script>

    <!-- Header (Global) -->
    <header class="bg-gradient-to-r from-primary to-secondary text-white p-6 pb-8 shadow-lg rounded-b-[2rem] relative overflow-hidden z-10">
        <div class="relative z-10 flex justify-between items-start">
            <div>
                <h1 class="text-2xl font-bold mb-1 flex items-center gap-2"><i class="fa-solid fa-recycle"></i> EcoPrice AI</h1>
                <p class="text-emerald-100 text-sm opacity-90" id="currentDate">กำลังโหลดวันที่...</p>
            </div>
            <!-- Update button visible only on Price view (handled by JS) -->
            <button id="updateBtn" onclick="updatePricesWithAI()" class="hidden bg-white/20 hover:bg-white/30 backdrop-blur-md text-white text-xs px-4 py-2 rounded-xl border border-white/20 flex items-center transition-all active:scale-95">
                <i class="fa-solid fa-rotate mr-2"></i> อัปเดตราคา
            </button>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="relative -mt-4 z-20 px-4 pb-20">

        <!-- VIEW 1: Community (Default) -->
        <div id="view-community" class="view-content">
            <div class="fb-container bg-white">
                <div class="bg-[#1877F2] text-white px-5 py-4 flex items-center justify-between">
                    <div class="flex items-center text-sm font-bold">
                        <i class="fa-brands fa-facebook mr-3 text-xl"></i> ชุมชนราคากลางขยะ
                    </div>
                    <!-- ปุ่มลิงก์เว็บเดิม -->
                    <a href="https://www.facebook.com/groups/2367668163390612/" target="_blank" class="text-[10px] bg-white/20 hover:bg-white/30 px-3 py-1.5 rounded-full font-medium backdrop-blur-sm transition-colors flex items-center">
                        เปิดในแอป <i class="fa-solid fa-arrow-up-right-from-square ml-1"></i>
                    </a>
                </div>
                <!-- FB Plugin Code -->
                <div class="fb-display-wrapper">
                    <div class="fb-page" 
                        data-href="https://www.facebook.com/p/%E0%B8%A7%E0%B8%87%E0%B8%A9%E0%B9%8C%E0%B8%9E%E0%B8%B2%E0%B8%93%E0%B8%B4%E0%B8%8A%E0%B8%A2%E0%B9%8C%E0%B8%A3%E0%B8%B1%E0%B8%9A%E0%B8%8B%E0%B8%B7%E0%B9%89%E0%B8%AD%E0%B8%82%E0%B8%AD%E0%B8%87%E0%B9%80%E0%B8%81%E0%B9%88%E0%B8%B2-100064175737067/" 
                        data-tabs="timeline" 
                        data-width="500" 
                        data-height="500" 
                        data-small-header="false" 
                        data-adapt-container-width="true" 
                        data-hide-cover="false" 
                        data-show-facepile="true">
                        <blockquote cite="https://www.facebook.com/p/%E0%B8%A7%E0%B8%87%E0%B8%A9%E0%B9%8C%E0%B8%9E%E0%B8%B2%E0%B8%93%E0%B8%B4%E0%B8%8A%E0%B8%A2%E0%B9%8C%E0%B8%A3%E0%B8%B1%E0%B8%9A%E0%B8%8B%E0%B8%B7%E0%B9%89%E0%B8%AD%E0%B8%82%E0%B8%AD%E0%B8%87%E0%B9%80%E0%B8%81%E0%B9%88%E0%B8%B2-100064175737067/" class="fb-xfbml-parse-ignore">
                            <a href="https://www.facebook.com/p/%E0%B8%A7%E0%B8%87%E0%B8%A9%E0%B9%8C%E0%B8%9E%E0%B8%B2%E0%B8%93%E0%B8%B4%E0%B8%8A%E0%B8%A2%E0%B9%8C%E0%B8%A3%E0%B8%B1%E0%B8%9A%E0%B8%8B%E0%B8%B7%E0%B9%89%E0%B8%AD%E0%B8%82%E0%B8%AD%E0%B8%87%E0%B9%80%E0%B8%81%E0%B9%88%E0%B8%B2-100064175737067/">กำลังโหลดชุมชน...</a>
                        </blockquote>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW 2: Search & Price List (Hidden by default) -->
        <div id="view-prices" class="view-content hidden space-y-4">
            
            <!-- Search Bar -->
            <div class="bg-white p-2 rounded-2xl shadow-sm border border-gray-100">
                <div class="relative">
                    <i class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    <input type="text" id="searchInput" oninput="handleSearch()" placeholder="ค้นหาชื่อขยะ (เช่น ทองแดง, ขวดใส)..." class="w-full pl-11 pr-4 py-3 bg-gray-50 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all text-gray-700 placeholder-gray-400">
                </div>
            </div>

            <!-- Categories -->
            <div class="flex overflow-x-auto space-x-2 hide-scrollbar pb-1" id="categoryContainer">
                <button onclick="filterCategory('all')" class="cat-btn bg-gray-800 text-white px-4 py-2 rounded-full whitespace-nowrap text-sm shadow-sm transition-transform active:scale-95">ทั้งหมด</button>
                <button onclick="filterCategory('paper')" class="cat-btn bg-white text-gray-600 px-4 py-2 rounded-full whitespace-nowrap text-sm border border-gray-200 shadow-sm transition-transform active:scale-95"><i class="fa-solid fa-newspaper mr-1 text-gray-400"></i> กระดาษ</button>
                <button onclick="filterCategory('plastic')" class="cat-btn bg-white text-gray-600 px-4 py-2 rounded-full whitespace-nowrap text-sm border border-gray-200 shadow-sm transition-transform active:scale-95"><i class="fa-solid fa-bottle-water mr-1 text-blue-400"></i> พลาสติก</button>
                <button onclick="filterCategory('metal')" class="cat-btn bg-white text-gray-600 px-4 py-2 rounded-full whitespace-nowrap text-sm border border-gray-200 shadow-sm transition-transform active:scale-95"><i class="fa-solid fa-gavel mr-1 text-orange-400"></i> โลหะ</button>
                <button onclick="filterCategory('glass')" class="cat-btn bg-white text-gray-600 px-4 py-2 rounded-full whitespace-nowrap text-sm border border-gray-200 shadow-sm transition-transform active:scale-95"><i class="fa-solid fa-wine-bottle mr-1 text-purple-400"></i> แก้ว</button>
                <button onclick="filterCategory('electronic')" class="cat-btn bg-white text-gray-600 px-4 py-2 rounded-full whitespace-nowrap text-sm border border-gray-200 shadow-sm transition-transform active:scale-95"><i class="fa-solid fa-plug mr-1 text-yellow-500"></i> อิเล็กทรอนิกส์</button>
                <button onclick="filterCategory('other')" class="cat-btn bg-white text-gray-600 px-4 py-2 rounded-full whitespace-nowrap text-sm border border-gray-200 shadow-sm transition-transform active:scale-95"><i class="fa-solid fa-ellipsis mr-1 text-gray-400"></i> อื่นๆ</button>
            </div>

            <!-- List Header -->
            <div class="flex justify-between items-center px-1">
                <h2 class="font-bold text-gray-700">รายการรับซื้อวันนี้</h2>
                <div id="statusIndicator" class="flex items-center text-[10px] text-gray-500 bg-white px-2 py-1 rounded-lg border border-gray-100 shadow-sm">
                    <div id="statusDot" class="w-1.5 h-1.5 rounded-full bg-green-500 mr-1.5 animate-pulse"></div>
                    <span id="updateTimeText">Live Update</span>
                </div>
            </div>

            <!-- Price List Items -->
            <div id="priceList" class="space-y-3 pb-24">
                <!-- Items injected by JS -->
            </div>
            
            <div id="noResults" class="hidden py-12 text-center text-gray-400">
                <div class="bg-gray-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="fa-solid fa-box-open text-2xl"></i>
                </div>
                <p>ไม่พบรายการที่ค้นหา</p>
            </div>
        </div>

    </main>

    <!-- Bottom Navigation Bar -->
    <nav class="fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 shadow-[0_-4px_20px_rgba(0,0,0,0.05)] z-50 h-[70px] flex justify-around items-center px-2 pb-1">
        <button onclick="switchTab('community')" id="nav-community" class="nav-item active flex-1 flex flex-col items-center justify-center h-full text-gray-400 hover:bg-gray-50 active:bg-gray-100 rounded-xl mx-1">
            <i class="fa-solid fa-users text-xl mb-1"></i>
            <span class="text-[10px] font-medium">ชุมชน</span>
        </button>
        <button onclick="switchTab('prices')" id="nav-prices" class="nav-item flex-1 flex flex-col items-center justify-center h-full text-gray-400 hover:bg-gray-50 active:bg-gray-100 rounded-xl mx-1">
            <i class="fa-solid fa-magnifying-glass-dollar text-xl mb-1"></i>
            <span class="text-[10px] font-medium">เช็คราคา</span>
        </button>
    </nav>

    <!-- Loading Overlay -->
    <div id="aiLoadingOverlay" class="fixed inset-0 bg-black/60 z-[100] hidden flex flex-col items-center justify-center backdrop-blur-md">
        <div class="relative w-24 h-24 mb-4 flex items-center justify-center">
            <div class="absolute inset-0 border-4 border-emerald-500/20 rounded-full"></div>
            <div class="absolute inset-0 border-4 border-emerald-500 rounded-full border-t-transparent animate-spin"></div>
            <i class="fa-solid fa-robot text-4xl text-white"></i>
        </div>
        <h3 class="text-white text-xl font-bold mb-2">Eco AI กำลังดึงข้อมูล...</h3>
        <p class="text-emerald-200 text-sm animate-pulse" id="aiLoadingText">สแกนแหล่งรับซื้อทั่วประเทศ</p>
    </div>

    <!-- Calculator Modal -->
    <div id="calculatorModal" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-end sm:items-center justify-center">
        <div class="bg-white w-full sm:w-96 rounded-t-3xl sm:rounded-2xl p-6 shadow-2xl animate-fade-in-up">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">คำนวณราคา</h3>
                <button onclick="closeCalculator()" class="text-gray-400 p-2 hover:bg-gray-100 rounded-full transition-colors"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <div class="bg-emerald-50 p-4 rounded-2xl mb-4 flex items-center">
                <div id="calcIcon" class="w-12 h-12 rounded-full bg-white flex items-center justify-center text-xl shadow-sm mr-3"></div>
                <div>
                    <h4 id="calcItemName" class="font-bold text-gray-800">ชื่อขยะ</h4>
                    <p class="text-sm text-gray-500">ราคา <span id="calcItemPrice" class="font-bold text-primary">0</span> บาท/กก.</p>
                </div>
            </div>
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-600 mb-2">ใส่น้ำหนัก (กก.)</label>
                <div class="flex items-center border-2 border-gray-100 rounded-2xl overflow-hidden focus-within:border-primary transition-all">
                    <input type="number" id="weightInput" class="w-full p-4 outline-none text-2xl font-bold" placeholder="0.00" oninput="calculateTotal()">
                    <span class="bg-gray-50 px-6 py-4 text-gray-500 font-bold border-l">กก.</span>
                </div>
            </div>
            <div class="flex justify-between items-center border-t border-dashed pt-4 mb-6">
                <span class="text-gray-500 font-medium">รวมเป็นเงิน</span>
                <span class="text-3xl font-black text-primary" id="totalValue">0.00 ฿</span>
            </div>
            <button onclick="addToBasket()" class="w-full bg-primary hover:bg-secondary text-white font-bold py-4 rounded-2xl shadow-lg transition-transform active:scale-95">
                <i class="fa-solid fa-cart-plus mr-2"></i> เพิ่มลงรายการ
            </button>
        </div>
    </div>

    <!-- Bottom Basket Summary (Positioned ABOVE Nav) -->
    <div id="basketSummary" class="fixed bottom-[70px] left-0 w-full bg-white shadow-[0_-4px_20px_rgba(0,0,0,0.1)] p-4 rounded-t-3xl transform translate-y-[150%] transition-transform duration-500 z-40 border-t border-gray-100">
        <div class="max-w-3xl mx-auto flex justify-between items-center">
            <div class="flex items-center">
                <div class="bg-primary/10 p-3 rounded-xl mr-3 relative">
                    <i class="fa-solid fa-basket-shopping text-primary text-xl"></i>
                    <span id="basketBadge" class="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] w-4 h-4 rounded-full flex items-center justify-center font-bold">0</span>
                </div>
                <div>
                    <p class="text-[10px] uppercase tracking-wider text-gray-400 font-bold">ยอดรวมประเมิน</p>
                    <h3 class="text-2xl font-black text-primary" id="basketTotal">0.00 ฿</h3>
                </div>
            </div>
            <div class="flex space-x-2">
                <button onclick="resetBasket()" class="text-gray-400 px-3 py-2 font-bold text-xs hover:text-red-500 transition-colors">ล้าง</button>
                <button class="bg-gray-900 text-white px-5 py-2.5 rounded-xl font-bold text-sm shadow-md hover:bg-black transition-colors">สรุปรายการ</button>
            </div>
        </div>
    </div>

    <!-- FAB AI Toggle -->
    <button id="fab-chat-toggle">
        <i class="fa-solid fa-robot"></i>
    </button>

    <!-- Chatbot Modal -->
    <div id="chatbot-modal" class="chatbot-hidden">
        <div class="flex flex-col h-screen bg-gray-100">
            <header class="bg-primary text-white p-4 flex justify-between items-center shadow-md">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center"><i class="fa-solid fa-robot"></i></div>
                    <div>
                        <h1 class="text-sm font-bold m-0">Eco AI Assistant</h1>
                        <p class="text-[10px] text-emerald-100 opacity-80">ผู้ช่วยส่วนตัวเรื่องขยะ</p>
                    </div>
                </div>
                <button id="chatbot-close-btn" class="bg-black/20 hover:bg-black/30 w-8 h-8 rounded-full"><i class="fa-solid fa-times"></i></button>
            </header>

            <main id="chat-history" class="flex-1 overflow-y-auto p-4 space-y-4">
                <div class="flex items-start space-x-2">
                    <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center text-white text-xs"><i class="fa-solid fa-robot"></i></div>
                    <div class="chat-bubble chat-bubble-model bg-white text-gray-800 p-3 rounded-2xl max-w-[80%] relative shadow-sm border border-gray-100">
                        <p class="text-sm">สวัสดีครับ! สอบถามราคาขยะ หรือวิธีคัดแยกได้เลยนะครับ</p>
                    </div>
                </div>
            </main>

            <div id="thinking-indicator" class="p-4 hidden">
                <div class="flex items-center space-x-2">
                    <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center text-white text-xs"><i class="fa-solid fa-robot"></i></div>
                    <div class="chat-bubble chat-bubble-model bg-white p-4 rounded-2xl w-32 shadow-sm border border-gray-100">
                        <div class="gemini-thinking-bar"></div>
                    </div>
                </div>
            </div>

            <footer class="bg-white p-4 border-t border-gray-100">
                <div class="flex space-x-2">
                    <input id="user-input" type="text" placeholder="พิมพ์ข้อความ..." class="flex-1 p-3 bg-gray-50 border border-gray-100 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary">
                    <button id="send-btn" class="bg-primary text-white w-12 h-12 rounded-xl flex items-center justify-center shadow-lg"><i class="fa-solid fa-paper-plane"></i></button>
                </div>
            </footer>
        </div>
    </div>

    <script>
        // --- ⚙️ CONFIGURATION: เชื่อมต่อ Backend ---
        // ใช้ URL ที่คุณระบุ
        const BACKEND_URL = "https://winter-sun-5411.tontakankeawpang.workers.dev";

        // --- Tab Switching Logic ---
        function switchTab(tabName) {
            // Hide all views
            document.getElementById('view-community').classList.add('hidden');
            document.getElementById('view-prices').classList.add('hidden');
            
            // Deactivate all nav items
            document.getElementById('nav-community').classList.remove('active', 'text-primary');
            document.getElementById('nav-prices').classList.remove('active', 'text-primary');
            document.getElementById('nav-community').classList.add('text-gray-400');
            document.getElementById('nav-prices').classList.add('text-gray-400');

            // Show selected view and activate nav item
            if (tabName === 'community') {
                document.getElementById('view-community').classList.remove('hidden');
                document.getElementById('nav-community').classList.add('active');
                document.getElementById('nav-community').classList.replace('text-gray-400', 'text-primary');
                document.getElementById('updateBtn').classList.add('hidden');
            } else {
                document.getElementById('view-prices').classList.remove('hidden');
                document.getElementById('nav-prices').classList.add('active');
                document.getElementById('nav-prices').classList.replace('text-gray-400', 'text-primary');
                document.getElementById('updateBtn').classList.remove('hidden');
            }
        }

        // --- Data Mockup & Existing Logic ---
       let wasteData = [
              { id: 1, name: 'กระดาษขาวดำ', category: 'paper', price: 4, trend: 'stable', icon: 'fa-file-alt', color: 'text-gray-500' },
  { id: 2, name: 'กระดาษลูกฟูก (ลัง)', category: 'paper', price: 3, trend: 'stable', icon: 'fa-box-open', color: 'text-yellow-700' },
  { id: 3, name: 'กระดาษหนังสือพิมพ์', category: 'paper', price: 2.5, trend: 'stable', icon: 'fa-newspaper', color: 'text-gray-600' },
  { id: 4, name: 'กระดาษเล่ม/สมุด', category: 'paper', price: 2, trend: 'stable', icon: 'fa-book', color: 'text-blue-800' },

  { id: 5, name: 'ขวด PET (ใส)', category: 'plastic', price: 14, trend: 'stable', icon: 'fa-bottle-water', color: 'text-blue-400' },
  { id: 6, name: 'ขวด PET (สี)', category: 'plastic', price: 8, trend: 'stable', icon: 'fa-bottle-water', color: 'text-green-500' },
  { id: 7, name: 'พลาสติก HDPE', category: 'plastic', price: 18, trend: 'stable', icon: 'fa-jug-detergent', color: 'text-gray-300' },
  { id: 8, name: 'พลาสติก PP', category: 'plastic', price: 10, trend: 'stable', icon: 'fa-chair', color: 'text-red-400' },
  { id: 9, name: 'ท่อ PVC (ฟ้า)', category: 'plastic', price: 6, trend: 'stable', icon: 'fa-circle-notch', color: 'text-blue-600' },

  { id: 10, name: 'ทองแดง (สายไฟปอก)', category: 'metal', price: 280, trend: 'up', icon: 'fa-bolt', color: 'text-orange-600' },
  { id: 11, name: 'ทองแดง (เผา)', category: 'metal', price: 240, trend: 'stable', icon: 'fa-fire', color: 'text-red-700' },
  { id: 12, name: 'อลูมิเนียม (กระป๋อง)', category: 'metal', price: 70, trend: 'stable', icon: 'fa-can-food', color: 'text-gray-400' },
  { id: 13, name: 'อลูมิเนียม (หนา)', category: 'metal', price: 85, trend: 'stable', icon: 'fa-layer-group', color: 'text-gray-500' },
  { id: 14, name: 'เหล็กหนา', category: 'metal', price: 9, trend: 'stable', icon: 'fa-weight-hanging', color: 'text-gray-700' },
  { id: 15, name: 'เหล็กบาง/สังกะสี', category: 'metal', price: 7, trend: 'stable', icon: 'fa-sheet-plastic', color: 'text-gray-400' },
  { id: 16, name: 'สแตนเลส 304', category: 'metal', price: 45, trend: 'stable', icon: 'fa-utensils', color: 'text-gray-400' },

  { id: 17, name: 'ขวดแก้ว (รวม)', category: 'glass', price: 1, trend: 'stable', icon: 'fa-wine-bottle', color: 'text-amber-800' },
  { id: 18, name: 'ขวดแก้ว (ใส)', category: 'glass', price: 2, trend: 'stable', icon: 'fa-wine-glass', color: 'text-blue-200' },
  { id: 19, name: 'ขวดแก้ว (เขียว)', category: 'glass', price: 1.5, trend: 'stable', icon: 'fa-wine-glass', color: 'text-green-700' },
  { id: 20, name: 'ขวดแก้ว (น้ำตาล)', category: 'glass', price: 1.2, trend: 'stable', icon: 'fa-wine-glass', color: 'text-amber-700' },

  { id: 21, name: 'เศษกระจกแตก', category: 'glass', price: 0.5, trend: 'down', icon: 'fa-triangle-exclamation', color: 'text-red-600' },

  { id: 22, name: 'สายไฟรวม', category: 'electronic', price: 35, trend: 'stable', icon: 'fa-plug', color: 'text-yellow-500' },
  { id: 23, name: 'แผงวงจร PCB', category: 'electronic', price: 120, trend: 'up', icon: 'fa-microchip', color: 'text-green-600' },
  { id: 24, name: 'อะแดปเตอร์ไฟ', category: 'electronic', price: 15, trend: 'stable', icon: 'fa-charging-station', color: 'text-gray-500' },
  { id: 25, name: 'แบตเตอรี่แห้ง', category: 'electronic', price: 10, trend: 'stable', icon: 'fa-battery-half', color: 'text-red-500' },
  { id: 26, name: 'แบตเตอรี่ลิเธียม', category: 'electronic', price: 60, trend: 'up', icon: 'fa-battery-full', color: 'text-green-500' },

  { id: 27, name: 'โทรศัพท์มือถือเก่า', category: 'electronic', price: 40, trend: 'up', icon: 'fa-mobile-screen', color: 'text-blue-500' },
  { id: 28, name: 'คอมพิวเตอร์เก่า', category: 'electronic', price: 18, trend: 'stable', icon: 'fa-desktop', color: 'text-gray-600' },
  { id: 29, name: 'จอ LCD', category: 'electronic', price: 25, trend: 'stable', icon: 'fa-tv', color: 'text-black' },
  { id: 30, name: 'สายชาร์จ', category: 'electronic', price: 12, trend: 'stable', icon: 'fa-cable-car', color: 'text-gray-400' },

  { id: 31, name: 'ถุงพลาสติกใส', category: 'plastic', price: 2, trend: 'down', icon: 'fa-bag-shopping', color: 'text-gray-300' },
  { id: 32, name: 'ฟิล์มยืด', category: 'plastic', price: 5, trend: 'stable', icon: 'fa-scroll', color: 'text-blue-300' },
  { id: 33, name: 'กล่องโฟม', category: 'plastic', price: 1, trend: 'down', icon: 'fa-cube', color: 'text-gray-200' },
  { id: 34, name: 'พลาสติกแข็งผสม', category: 'plastic', price: 6, trend: 'stable', icon: 'fa-puzzle-piece', color: 'text-purple-400' },
  { id: 35, name: 'ฝาขวดพลาสติก', category: 'plastic', price: 7, trend: 'stable', icon: 'fa-circle', color: 'text-red-500' },

  { id: 36, name: 'ทองเหลือง', category: 'metal', price: 160, trend: 'up', icon: 'fa-ring', color: 'text-yellow-600' },
  { id: 37, name: 'ตะกั่ว', category: 'metal', price: 55, trend: 'stable', icon: 'fa-weight-scale', color: 'text-gray-800' },
  { id: 38, name: 'สายทองแดงไม่ปอก', category: 'metal', price: 180, trend: 'stable', icon: 'fa-wave-square', color: 'text-orange-500' },
  { id: 39, name: 'เศษเหล็กรถยนต์', category: 'metal', price: 10, trend: 'up', icon: 'fa-car', color: 'text-gray-700' },
  { id: 40, name: 'ลวดเหล็ก', category: 'metal', price: 8, trend: 'stable', icon: 'fa-grip-lines', color: 'text-gray-500' },

  { id: 41, name: 'ยางรถยนต์', category: 'other', price: 3, trend: 'stable', icon: 'fa-circle-dot', color: 'text-black' },
  { id: 42, name: 'เศษผ้า', category: 'other', price: 4, trend: 'stable', icon: 'fa-shirt', color: 'text-indigo-400' },
  { id: 43, name: 'ไม้พาเลท', category: 'other', price: 2, trend: 'stable', icon: 'fa-tree', color: 'text-green-700' },
  { id: 44, name: 'เศษไม้', category: 'other', price: 1.5, trend: 'stable', icon: 'fa-tree-city', color: 'text-brown-600' },

  { id: 45, name: 'หลอด LED', category: 'electronic', price: 30, trend: 'up', icon: 'fa-lightbulb', color: 'text-green-400' },
  { id: 46, name: 'หลอดไฟเก่า', category: 'electronic', price: 5, trend: 'stable', icon: 'fa-lightbulb', color: 'text-yellow-400' },

  { id: 47, name: 'เครื่องใช้ไฟฟ้าเก่า', category: 'electronic', price: 15, trend: 'stable', icon: 'fa-blender', color: 'text-gray-500' },
  { id: 48, name: 'ตู้เย็นเก่า', category: 'electronic', price: 12, trend: 'stable', icon: 'fa-snowflake', color: 'text-cyan-400' },
  { id: 49, name: 'เครื่องซักผ้าเก่า', category: 'electronic', price: 14, trend: 'stable', icon: 'fa-water', color: 'text-blue-500' },
  { id: 50, name: 'ไมโครเวฟเก่า', category: 'electronic', price: 10, trend: 'stable', icon: 'fa-box', color: 'text-gray-500' }
        ];


        let currentCategory = 'all';
        let searchQuery = '';
        let basket = [];
        let selectedItem = null;

        document.addEventListener('DOMContentLoaded', () => {
            renderDate();
            filterItems();
            switchTab('community'); // Default tab
        });

        function renderDate() {
            const date = new Date();
            document.getElementById('currentDate').innerText = date.toLocaleDateString('th-TH', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
        }

        function handleSearch() {
            searchQuery = document.getElementById('searchInput').value.trim().toLowerCase();
            filterItems();
        }

        function filterCategory(category) {
            currentCategory = category;
            const buttons = document.querySelectorAll('.cat-btn');
            buttons.forEach(btn => {
                const clickAttr = btn.getAttribute('onclick');
                if (clickAttr.includes(`'${category}'`)) {
                    btn.className = "cat-btn bg-gray-800 text-white px-4 py-2 rounded-full whitespace-nowrap text-sm shadow-sm transition-transform active:scale-95";
                } else {
                    btn.className = "cat-btn bg-white text-gray-600 px-4 py-2 rounded-full whitespace-nowrap text-sm border border-gray-200 shadow-sm transition-transform active:scale-95";
                }
            });
            filterItems();
        }

        function filterItems(animate = false) {
            const filtered = wasteData.filter(item => {
                const matchCategory = currentCategory === 'all' || item.category === currentCategory;
                const matchSearch = item.name.toLowerCase().includes(searchQuery);
                return matchCategory && matchSearch;
            });
            renderItems(filtered, animate);
            const noRes = document.getElementById('noResults');
            if (filtered.length === 0) noRes.classList.remove('hidden');
            else noRes.classList.add('hidden');
        }

        function renderItems(items, animate = false) {
            const container = document.getElementById('priceList');
            container.innerHTML = '';
            items.forEach((item, index) => {
                const trendIcon = item.trend === 'up' ? '<i class="fa-solid fa-arrow-trend-up text-green-500"></i>' : 
                                  item.trend === 'down' ? '<i class="fa-solid fa-arrow-trend-down text-red-400"></i>' : 
                                  '<i class="fa-solid fa-minus text-gray-300"></i>';
                const card = document.createElement('div');
                card.className = `price-item bg-white p-4 rounded-2xl shadow-sm border border-gray-50 flex justify-between items-center cursor-pointer hover:shadow-md transition-all ${animate ? 'price-flash' : ''}`;
                if (animate) card.style.animationDelay = `${index * 50}ms`;
                card.onclick = () => openCalculator(item);
                card.innerHTML = `
                    <div class="flex items-center">
                        <div class="w-12 h-12 rounded-xl bg-gray-50 flex items-center justify-center mr-4 text-xl ${item.color}"><i class="fa-solid ${item.icon}"></i></div>
                        <div><h3 class="font-bold text-gray-800">${item.name}</h3><div class="flex items-center text-[10px] text-gray-400 font-bold uppercase">ตลาดกลาง ${trendIcon}</div></div>
                    </div>
                    <div class="text-right"><div class="text-xl font-black text-primary">${item.price.toFixed(2)}</div><div class="text-[10px] text-gray-400 font-bold">บาท/กก.</div></div>
                `;
                container.appendChild(card);
            });
        }

        async function updatePricesWithAI() {
            const overlay = document.getElementById('aiLoadingOverlay');
            overlay.classList.remove('hidden');
            
            try {
                // ถ้ามี Backend URL ให้ดึงราคาจริงมาแสดง
                if (BACKEND_URL) {
                     const response = await fetch(`${BACKEND_URL}/prices`); 
                     if (response.ok) {
                        const data = await response.json();
                        wasteData = data; // อัปเดตข้อมูลจริง
                     }
                } else {
                    // Demo Mode Logic
                    await new Promise(r => setTimeout(r, 1200));
                    wasteData = wasteData.map(item => ({ ...item, price: item.price + (Math.random() * 2 - 1), trend: Math.random() > 0.5 ? 'up' : 'down' }));
                }
            } catch (e) { console.error("Update Error:", e); }

            filterItems(true);
            overlay.classList.add('hidden');
        }

        function openCalculator(item) {
            selectedItem = item;
            document.getElementById('calcItemName').innerText = item.name;
            document.getElementById('calcItemPrice').innerText = item.price.toFixed(2);
            document.getElementById('calcIcon').innerHTML = `<i class="fa-solid ${item.icon} ${item.color}"></i>`;
            document.getElementById('weightInput').value = '';
            document.getElementById('totalValue').innerText = '0.00 ฿';
            document.getElementById('calculatorModal').classList.remove('hidden');
            document.getElementById('weightInput').focus();
        }

        function closeCalculator() { document.getElementById('calculatorModal').classList.add('hidden'); selectedItem = null; }

        function calculateTotal() {
            const weight = parseFloat(document.getElementById('weightInput').value) || 0;
            document.getElementById('totalValue').innerText = (weight * selectedItem.price).toLocaleString('th-TH', { minimumFractionDigits: 2 }) + ' ฿';
        }

        function addToBasket() {
            const weight = parseFloat(document.getElementById('weightInput').value) || 0;
            if (weight > 0) basket.push({ ...selectedItem, weight, total: weight * selectedItem.price });
            updateBasketUI();
            closeCalculator();
        }

        function updateBasketUI() {
            const bar = document.getElementById('basketSummary');
            const badge = document.getElementById('basketBadge');
            if (basket.length > 0) bar.classList.remove('translate-y-[150%]');
            else bar.classList.add('translate-y-[150%]');
            const total = basket.reduce((sum, item) => sum + item.total, 0);
            badge.innerText = basket.length;
            document.getElementById('basketTotal').innerText = total.toLocaleString('th-TH', { minimumFractionDigits: 2 }) + ' ฿';
        }

        function resetBasket() { basket = []; updateBasketUI(); }

        // --- Chatbot Logic (Backend Connected) ---
        const chatToggle = document.getElementById('fab-chat-toggle');
        const chatModal = document.getElementById('chatbot-modal');
        const chatClose = document.getElementById('chatbot-close-btn');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const chatHistory = document.getElementById('chat-history');

        chatToggle.onclick = () => { chatModal.classList.remove('chatbot-hidden'); chatToggle.style.opacity = '0'; };
        chatClose.onclick = () => { chatModal.classList.add('chatbot-hidden'); chatToggle.style.opacity = '1'; };

        async function handleChat() {
            const msg = userInput.value.trim();
            if (!msg) return;

            // 1. แสดงข้อความผู้ใช้
            const uDiv = document.createElement('div');
            uDiv.className = "flex justify-end mb-4";
            uDiv.innerHTML = `<div class="chat-bubble chat-bubble-user bg-primary text-white p-3 rounded-2xl max-w-[80%] shadow-md text-sm relative">${msg}</div>`;
            chatHistory.appendChild(uDiv);
            
            userInput.value = '';
            userInput.disabled = true; // ล็อคช่องพิมพ์
            chatHistory.scrollTop = chatHistory.scrollHeight;

            // 2. แสดงสถานะกำลังคิด
            const thinkingDiv = document.createElement('div');
            thinkingDiv.id = "thinking-loader";
            thinkingDiv.className = "flex items-start space-x-2 mb-4 animate-pulse";
            thinkingDiv.innerHTML = `
                <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center text-white text-xs"><i class="fa-solid fa-robot"></i></div>
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                    <div class="gemini-thinking-bar w-16"></div>
                </div>
            `;
            chatHistory.appendChild(thinkingDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;

            let replyText = "";

            try {
                if (BACKEND_URL) {
                    // --- กรณี 1: ต่อ Backend จริง ---
                    const response = await fetch(BACKEND_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: msg })
                    });

                    if (!response.ok) throw new Error('Network error');
                    const data = await response.json();
                    replyText = data.reply || data.message || JSON.stringify(data);
                } else {
                    // --- กรณี 2: Demo Mode (ไม่มี Backend) ---
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    
                    if (msg.includes("ราคา") || msg.includes("เท่าไหร่")) {
                        replyText = "ตรวจสอบราคาล่าสุดได้ที่ตาราง 'เช็คราคา' ด้านล่างได้เลยครับ มีอัปเดตแบบ Real-time ครับ";
                    } else if (msg.includes("พลาสติก")) {
                        replyText = "พลาสติกใส (PET) ตอนนี้ราคาดีครับ ประมาณ 14-15 บาท/กก. แนะนำให้แยกฝาออกก่อนขายนะครับ";
                    } else {
                        replyText = "รับทราบครับ! ผมกำลังเรียนรู้ข้อมูลเพิ่มเติมเพื่อตอบคำถามของคุณให้ดียิ่งขึ้น";
                    }
                }
            } catch (error) {
                console.error('Chat Error:', error);
                replyText = "ขออภัย ไม่สามารถเชื่อมต่อเซิร์ฟเวอร์ได้ (กรุณาตรวจสอบการตั้งค่า BACKEND_URL)";
            }

            // 3. แสดงคำตอบ AI
            document.getElementById("thinking-loader").remove();
            
            const aiDiv = document.createElement('div');
            aiDiv.className = "flex items-start space-x-2 mb-4";
            aiDiv.innerHTML = `
                <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center text-white text-xs"><i class="fa-solid fa-robot"></i></div>
                <div class="chat-bubble chat-bubble-model bg-white text-gray-800 p-3 rounded-2xl max-w-[80%] relative shadow-sm border border-gray-100">
                    <p class="text-sm">${replyText}</p>
                </div>
            `;
            chatHistory.appendChild(aiDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
            userInput.disabled = false;
            userInput.focus();
        }

        sendBtn.onclick = handleChat;
        userInput.onkeydown = (e) => { if(e.key === 'Enter') handleChat(); };
    </script>
</body>
</html>
