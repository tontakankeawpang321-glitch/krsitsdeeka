<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÇ‡∏£‡∏Ñ (AI Pharmacist & Health Check)</title>

<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&family=Kodchasan:wght@600;700&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<!-- Markdown Parser for AI response -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<style>
  :root{
    --bg:#fffdf7; --paper:#ffffff; --ink:#0f172a; --muted:#475569; --line:#e5e7eb;
    --brand:#50b5a5; --brand-2:#2f8f80; --chip:#e6fffb; --ring:#c7f5ef;
    --ok:#16a34a; --danger:#dc2626; --radius:16px;
    --shadow:0 10px 30px -18px rgba(2,8,23,.28);
  }
  *{box-sizing:border-box}
  html,body{margin:0; background:var(--bg); color:var(--ink); font-family:"Sarabun", system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans Thai", sans-serif;}
  a{color:#0ea5e9; text-decoration:none}
  a:hover{text-decoration:underline}

  /* ‡∏•‡πá‡∏≠‡∏Å‡∏™‡∏Å‡∏≠‡∏£‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ modal */
  body.no-scroll{ overflow:hidden; }

  .wrap{max-width:1100px; margin:auto; padding:24px 16px 80px}
  header.app{
    position:sticky; top:0; z-index:50; backdrop-filter:blur(10px);
    background:linear-gradient(180deg, rgba(255,253,247,.85), rgba(255,253,247,.65) 60%, rgba(255,253,247,0));
    padding:18px 16px 10px; margin:0 -16px; border-bottom:1px solid rgba(0,0,0,.04);
  }
  .title{
    font-family:"Kodchasan","Sarabun",sans-serif; font-weight:700; letter-spacing:.2px;
    display:flex; align-items:center; gap:12px; margin-bottom:10px; padding:0 16px; color:#0b3b34;
  }
  .badge{
    display:inline-flex; align-items:center; gap:6px;
    background:linear-gradient(145deg,var(--brand),#9fe7dc);
    color:#053c34; padding:6px 10px; border-radius:999px; font-weight:700; font-size:12px;
    box-shadow:inset 0 1px 0 #fff, 0 2px 10px rgba(2,143,128,.25);
  }

  /* Controls */
  .controls{ display:flex; gap:10px; align-items:center; padding:8px 16px 0; flex-wrap:wrap;}
  .controls .field{ position:relative; flex:1 1 240px; }
  .controls input[type="search"], .controls select{
    width:100%; height:42px; border-radius:12px; border:1px solid var(--line); background:var(--paper);
    padding:0 12px; font-size:15px; outline:none;
  }
  .controls button{
    height:42px; border-radius:12px; border:1px solid #67dacb; cursor:pointer;
    padding:0 14px; font-weight:800; letter-spacing:.2px;
    background:linear-gradient(145deg,#ddfff8,#baf3ea); color:#064e43;
    box-shadow:inset 0 1px 0 #fff, 0 10px 24px -14px rgba(2,143,128,.45);
    transition:transform .06s, background .18s;
  }
  .controls button:hover{ background:linear-gradient(145deg,#c9fbf0,#9eeadf); }
  .controls button:active{ transform:translateY(1px); }

  /* Grid */
  .grid{ display:grid; gap:14px; padding:14px 0; grid-template-columns: repeat(12,1fr); }
  .card{
    grid-column: span 4; background:var(--paper); border:1px solid var(--line); border-radius:var(--radius);
    padding:14px; box-shadow:var(--shadow); display:flex; flex-direction:column; gap:10px;
    transition:transform .18s ease, box-shadow .18s ease;
  }
  .card:hover{ transform:translateY(-2px); box-shadow:0 14px 40px -18px rgba(2,8,23,.36);}
  @media (max-width:1000px){ .card{grid-column: span 6;} }    /* 2 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå */
  @media (max-width:640px){ .card{grid-column: span 6;} }     /* ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡∏Ñ‡∏á 2 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå */
  @media (max-width:400px){ .card{grid-column: span 12;} }    /* ‡∏à‡∏≠‡πÄ‡∏•‡πá‡∏Å‡∏°‡∏≤‡∏Å ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 1 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå */

  .drug-name{ margin:0; font-size:18px; line-height:1.35; display:flex; gap:8px; align-items:center; font-weight:700;}
  .generic{ font-size:14px; color:#0b3b34; font-weight:700; }

  .meta{ display:flex; gap:8px; flex-wrap:wrap; font-size:12px;}
  .pill{ background:#f8fafc; border:1px solid var(--line); border-radius:999px; padding:4px 8px; }
  .tags{ display:flex; gap:6px; flex-wrap:wrap; }
  .tag{ font-size:12px; background:#ecfeff; color:#064e43; padding:4px 8px; border-radius:999px; border:1px solid #a5f3fc; }
  .excerpt{ color:#334155; font-size:14px; line-height:1.55; display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden; }

  .btn{
    align-self:flex-start; margin-top:auto; display:inline-flex; align-items:center; gap:8px; font-weight:800; letter-spacing:.2px;
    padding:10px 14px; border-radius:12px; border:1px solid #67dacb;
    background:linear-gradient(145deg,#ddfff8,#baf3ea); color:#064e43; cursor:pointer;
    transition:transform .06s, box-shadow .18s, background .2s; box-shadow:inset 0 1px 0 #fff, 0 10px 24px -14px rgba(2,143,128,.45);
  }
  .btn:hover{ background:linear-gradient(145deg,#c9fbf0,#9eeadf); }
  .btn:active{ transform:translateY(1px); }

  /* Pagination */
  .pager{ display:flex; align-items:center; gap:8px; justify-content:center; padding:12px 0 34px;}
  .pager button{ border:1px solid var(--line); background:var(--paper); border-radius:999px; padding:8px 12px; cursor:pointer; }
  .pager .info{ font-size:13px; color:var(--muted); padding:0 8px; }

  /* Modal (Drug Details) */
  .modal-backdrop{
    position:fixed; inset:0; background:rgba(0,0,0,.42); display:none; place-items:center; padding:16px; z-index:100;
    touch-action:none; /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏™‡∏Å‡∏≠‡∏£‡πå‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ï‡πâ modal ‡∏ö‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™ */
  }
  .modal{
    max-width:920px; width:100%; max-height:88vh; overflow:auto;
    background:var(--paper); border-radius:20px; border:1px solid var(--line); box-shadow:0 30px 80px rgba(0,0,0,.35);
  }
  .modal header{
    position:sticky; top:0; background:linear-gradient(180deg,#fff,rgba(255,255,255,.92));
    padding:16px 18px; border-bottom:1px solid var(--line); display:flex; justify-content:space-between; align-items:center; gap:10px; z-index: 10;
  }
  .modal .body{ padding:18px; }
  .modal h2{ margin:0 0 8px; font-size:22px; }
  .close{ border:none; background:#111; color:#fff; border-radius:12px; padding:8px 12px; cursor:pointer; }
  .srcs{ margin-top:14px; font-size:14px; color:#475569; }
  .srcs a{ word-break:break-all }

  .modal-backdrop.show{ display:grid; }
  .content-html img{ max-width:100%; height:auto; border-radius:12px; }
  .content-html table{ border-collapse:collapse; width:100%; }
  .content-html table, .content-html th, .content-html td{ border:1px solid #ddd; }
  .content-html th, .content-html td{ padding:8px; }

  .skeleton{ background:linear-gradient(90deg, #f6f7f9 25%, #eceff3 37%, #f6f7f9 63%); animation:shimmer 1.2s infinite; background-size: 200% 100%; }
  @keyframes shimmer{ 0%{background-position:200% 0} 100%{background-position:-200% 0} }

  /* ====== ‡∏™‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏¢‡∏≤ ====== */
  .cat-analgesic .drug-name{ color:#b45309 }      
  .cat-antipyretic .drug-name{ color:#2563eb }    
  .cat-antibiotic .drug-name{ color:#dc2626 }     
  .cat-antihistamine .drug-name{ color:#0f766e }  
  .cat-antacid .drug-name{ color:#7c3aed }        
  .cat-cough .drug-name{ color:#1e40af }          
  .cat-vitamin .drug-name{ color:#166534 }        

  /* ===== CSS ‡∏Ç‡∏≠‡∏á Chatbot UI (Pharmacist Theme) ===== */
  .chat-bubble::before { content: ''; position: absolute; width: 0; height: 0; border-style: solid; }
  .chat-bubble-user::before {
    border-width: 0 12px 12px 12px; border-color: transparent transparent #50b5a5 transparent; /* ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏°‡∏¥‡πâ‡∏ô‡∏ï‡πå */
    top: -10px; right: 12px;
  }
  .chat-bubble-model::before {
    border-width: 0 12px 12px 12px; border-color: transparent transparent #f3f4f6 transparent;
    top: -10px; left: 12px;
  }
  .gemini-thinking-bar {
    position: relative; width: 100%; height: 4px; background-color: #e0e0e0;
    border-radius: 2px; overflow: hidden;
  }
  .gemini-thinking-bar::before {
    content: ''; position: absolute; top: 0; left: 0; height: 100%; width: 100%;
    background: linear-gradient(90deg, #50b5a5, #2f8f80, #50b5a5);
    background-size: 200% 100%; animation: thinking-gradient 2s linear infinite;
  }
  @keyframes thinking-gradient { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
  
  #fab-chat-toggle {
    position: fixed; bottom: 25px; right: 25px;
    width: 60px; height: 60px;
    background-color: #064e43; /* ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÄ‡∏Ç‡πâ‡∏° */
    color: white;
    border: none; border-radius: 50%;
    font-size: 28px; line-height: 60px; text-align: center;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    cursor: pointer; z-index: 998;
    transition: transform 0.2s, opacity 0.3s;
    font-family: 'Kodchasan', sans-serif;
  }
  #fab-chat-toggle:hover { transform: scale(1.05); background-color: #50b5a5; }
  
  #chatbot-modal {
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    z-index: 1000; transition: opacity 0.3s, transform 0.3s;
    opacity: 1; transform: translateY(0); pointer-events: auto;
  }
  #chatbot-modal.chatbot-hidden {
    opacity: 0; transform: translateY(100%); pointer-events: none;
  }

  /* Health Form Specifics */
  .health-form-group { margin-bottom: 10px; }
  .health-form-label { display: block; font-size: 13px; color: #4b5563; margin-bottom: 3px; font-weight: 700; }
  .health-form-input {
    width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 8px; outline: none; transition: border-color 0.2s;
    background-color: #f9fafb; font-size: 14px;
  }
  .health-form-input:focus { border-color: #50b5a5; background-color: white; }

  /* Chips for diseases */
  .chip-group { display: flex; flex-wrap: wrap; gap: 8px; }
  .chip-option {
    cursor: pointer; padding: 6px 12px; border-radius: 999px; border: 1px solid #cbd5e1;
    background-color: #f1f5f9; color: #475569; font-size: 13px; transition: all 0.2s;
    user-select: none;
  }
  .chip-option:hover { background-color: #e2e8f0; }
  .chip-option.selected {
    background-color: #ccfbf1; border-color: #50b5a5; color: #0f766e; font-weight: 700;
  }

  /* Result Markdown */
  .result-markdown p { margin-bottom: 0.8em; line-height: 1.6; }
  .result-markdown h3 { font-size: 1.25rem; font-weight: 700; color: #064e43; margin-top: 1em; margin-bottom: 0.5em; }
  .result-markdown ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 0.8em; }
  .result-markdown li { margin-bottom: 0.2em; }
  .result-markdown strong { color: #0f172a; }

</style>
</head>
<body>
  <header class="app">
    <div class="wrap" style="padding:0">
      <div class="title">
        <span class="badge">‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
        <div style="font-size:20px">‡∏¢‡∏≤‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÇ‡∏£‡∏Ñ</div>
      </div>

      <div class="controls" aria-label="‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á">
        <div class="field"><input id="q" type="search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤ / ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç / ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£ ..."></div>
        <div class="field">
          <select id="cat" aria-label="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏¢‡∏≤">
            <option value="">‚Äî ‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î ‚Äî</option>
            <option value="analgesic">‡∏¢‡∏≤‡πÅ‡∏Å‡πâ‡∏õ‡∏ß‡∏î</option>
            <option value="antipyretic">‡∏¢‡∏≤‡∏•‡∏î‡πÑ‡∏Ç‡πâ</option>
            <option value="antibiotic">‡∏¢‡∏≤‡∏Ü‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πâ‡∏≠</option>
            <option value="antihistamine">‡∏¢‡∏≤‡πÅ‡∏Å‡πâ‡πÅ‡∏û‡πâ</option>
            <option value="antacid">‡∏¢‡∏≤‡∏•‡∏î‡∏Å‡∏£‡∏î/‡∏Å‡∏£‡∏∞‡πÄ‡∏û‡∏≤‡∏∞</option>
            <option value="cough">‡∏¢‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏≠/‡∏Ç‡∏±‡∏ö‡πÄ‡∏™‡∏°‡∏´‡∏∞</option>
            <option value="vitamin">‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô/‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏°</option>
          </select>
        </div>
        <button id="searchBtn">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
        <button id="clearBtn" title="‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á">‡∏•‡πâ‡∏≤‡∏á</button>
      </div>
    </div>
  </header>

  <main class="wrap" id="mainContent">
    <section id="grid" class="grid"></section>
    <div class="pager" role="navigation" aria-label="‡πÄ‡∏û‡∏à‡∏à‡∏¥‡πÄ‡∏ô‡∏ä‡∏±‡∏ô">
      <button id="prevBtn">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
      <span class="info" id="pageInfo"></span>
      <button id="nextBtn">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
    </div>
  </main>

  <!-- Modal ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏¢‡∏≤ -->
  <div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="mTitle">
    <div class="modal">
      <header>
        <h2 id="mTitle">‚Äî</h2>
        <button id="closeModal" class="close" aria-label="‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á">‡∏õ‡∏¥‡∏î</button>
      </header>
      <div class="body">
        <div class="meta" id="mMeta"></div>
        <div class="content-html" id="mContent"></div>
        <div class="srcs" id="mSources"></div>
      </div>
    </div>
  </div>

  <footer>
    <p class="footer-links" style="text-align: center; color: #475569; margin-top: 20px;">
      ¬© 2025 Crow Studio |
      <a href="https://sites.google.com/view/privacy-policy-pdpa-crow-studi/%E0%B8%AB%E0%B8%99%E0%B8%B2%E0%B9%81%E0%B8%A3%E0%B8%81">‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</a> |
      <a href="#">‡∏Ç‡πâ‡∏≠‡∏ï‡∏Å‡∏•‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</a>
    </p>
  </footer>

  <!-- FAB Button -->
  <button id="fab-chat-toggle" title="‡∏ñ‡∏≤‡∏°‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£ AI">Ai</button>

  <!-- Chatbot Modal -->
  <div id="chatbot-modal" class="chatbot-hidden">
    <div class="flex flex-col h-screen bg-gray-100">
      
      <!-- Header Chatbot -->
      <header class="bg-[#50b5a5] text-white p-3 md:p-4 flex justify-between items-center shadow-md">
        <div class="flex items-center gap-2">
            <span class="text-xl md:text-2xl">üíä</span>
            <div>
                <h1 class="text-base md:text-lg font-bold font-sans text-white m-0">AI ‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£</h1>
                <p class="text-xs text-green-100 hidden md:block">‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞ 24 ‡∏ä‡∏°.</p>
            </div>
        </div>
        <div class="flex items-center gap-2">
          <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û -->
          <button id="health-check-btn" class="bg-white hover:bg-green-50 text-[#064e43] font-bold py-1.5 px-3 rounded-lg text-sm flex items-center gap-1 shadow-sm transition-all animate-pulse">
             <span class="text-lg">ü©∫</span> <span class="hidden sm:inline">‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</span>
          </button>

          <button id="new-chat-btn" class="bg-[#ddfff8] hover:bg-[#baf3ea] text-[#064e43] font-bold py-1.5 px-3 rounded-lg text-sm transition-colors">
            ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
          </button>
          <button id="chatbot-close-btn" class="bg-gray-800 hover:bg-gray-900 text-white font-bold py-1.5 px-3 rounded-lg text-sm transition-colors">
            ‡∏õ‡∏¥‡∏î
          </button>
        </div>
      </header>

      <!-- Chat History -->
      <main id="chat-history" class="flex-1 overflow-y-auto p-4 space-y-4 bg-[#f0fdfa]">
        <div class="flex items-start space-x-2">
          <span class="text-2xl">ü§ñ</span>
          <div class="chat-bubble chat-bubble-model bg-white text-gray-800 p-3 rounded-lg max-w-lg relative border border-gray-200 shadow-sm">
            <p>‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ú‡∏°‡∏Ñ‡∏∑‡∏≠ AI ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£ ‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö<br><br>
            ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡πà‡∏ß‡∏¢ ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° <strong>"ü©∫ ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û"</strong> ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ú‡∏°‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö
            </p>
          </div>
        </div>
      </main>

      <!-- Thinking Indicator -->
      <div id="thinking-indicator" class="p-4 hidden bg-[#f0fdfa]">
        <div class="flex items-center space-x-2">
          <span class="text-2xl">ü§ñ</span>
          <div class="chat-bubble chat-bubble-model bg-white text-gray-800 p-3 rounded-lg max-w-lg relative border border-gray-200">
            <div class="gemini-thinking-bar"></div>
            <span class="text-xs text-gray-500 mt-1 block">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå...</span>
          </div>
        </div>
      </div>

      <!-- Input Area -->
      <footer class="bg-white p-3 shadow-inner border-t border-gray-200 m-0 w-full max-w-full z-10">
        <div class="flex space-x-2">
          <input id="user-input" type="text" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡πà‡∏ß‡∏¢..." class="flex-1 p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#50b5a5] font-sans text-base">
          <button id="send-btn" class="bg-[#50b5a5] hover:bg-[#2f8f80] text-white font-bold py-2 px-4 rounded-xl shadow-sm transition-colors">
            ‡∏™‡πà‡∏á
          </button>
        </div>
      </footer>
    </div>

    <!-- Health Assessment Dialog (Form) -->
    <div id="health-modal-overlay" class="absolute inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-lg shadow-2xl flex flex-col max-h-[90vh] overflow-hidden">
            <header class="p-3 border-b border-gray-100 flex justify-between items-center bg-[#50b5a5]">
                <div class="flex items-center gap-2 text-white font-bold text-lg">
                    <span>ü©∫</span> ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô
                </div>
                <button id="close-health-modal" class="text-white/80 hover:text-white text-2xl leading-none">&times;</button>
            </header>
            
            <div class="p-4 overflow-y-auto space-y-3 bg-slate-50">
                <!-- Row 1: Basic Info (Compact) -->
                <div class="grid grid-cols-4 gap-2">
                    <div class="col-span-2 sm:col-span-1">
                         <label class="health-form-label">‡πÄ‡∏û‡∏®</label>
                         <select id="hf-gender" class="health-form-input">
                            <option value="‡∏ä‡∏≤‡∏¢">‡∏ä‡∏≤‡∏¢</option>
                            <option value="‡∏´‡∏ç‡∏¥‡∏á">‡∏´‡∏ç‡∏¥‡∏á</option>
                        </select>
                    </div>
                    <div class="col-span-2 sm:col-span-1">
                        <label class="health-form-label">‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏õ‡∏µ)</label>
                        <input type="number" id="hf-age" class="health-form-input" placeholder="0">
                    </div>
                    <div class="col-span-2 sm:col-span-1">
                        <label class="health-form-label">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (kg)</label>
                        <input type="number" id="hf-weight" class="health-form-input" placeholder="0">
                    </div>
                    <div class="col-span-2 sm:col-span-1">
                        <label class="health-form-label">‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á (cm)</label>
                        <input type="number" id="hf-height" class="health-form-input" placeholder="0">
                    </div>
                </div>

                <!-- Row 2: Chronic Diseases (Chips) -->
                <div class="health-form-group">
                    <label class="health-form-label">‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 1)</label>
                    <div class="chip-group" id="disease-chips">
                        <div class="chip-option" data-val="‡πÑ‡∏°‡πà‡∏°‡∏µ">‡πÑ‡∏°‡πà‡∏°‡∏µ</div>
                        <div class="chip-option" data-val="‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï‡∏™‡∏π‡∏á">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï‡∏™‡∏π‡∏á</div>
                        <div class="chip-option" data-val="‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô">‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô</div>
                        <div class="chip-option" data-val="‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡πÉ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î">‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡πÉ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î</div>
                        <div class="chip-option" data-val="‡πÇ‡∏£‡∏Ñ‡∏´‡∏±‡∏ß‡πÉ‡∏à">‡πÇ‡∏£‡∏Ñ‡∏´‡∏±‡∏ß‡πÉ‡∏à</div>
                        <div class="chip-option" data-val="‡∏´‡∏≠‡∏ö‡∏´‡∏∑‡∏î">‡∏´‡∏≠‡∏ö‡∏´‡∏∑‡∏î</div>
                        <div class="chip-option" data-val="‡πÑ‡∏ï‡πÄ‡∏£‡∏∑‡πâ‡∏≠‡∏£‡∏±‡∏á">‡πÑ‡∏ï‡πÄ‡∏£‡∏∑‡πâ‡∏≠‡∏£‡∏±‡∏á</div>
                    </div>
                    <input type="text" id="hf-disease-other" class="health-form-input mt-2" placeholder="‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏£‡∏∞‡∏ö‡∏∏...">
                </div>

                <!-- Row 3: Allergy -->
                <div class="health-form-group">
                    <label class="health-form-label text-red-600">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏û‡πâ‡∏¢‡∏≤ / ‡∏≠‡∏≤‡∏´‡∏≤‡∏£ (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç)</label>
                    <input type="text" id="hf-allergy" class="health-form-input border-red-200 bg-red-50 focus:bg-white" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏û‡πâ ‡∏´‡∏£‡∏∑‡∏≠ '‡πÑ‡∏°‡πà‡∏°‡∏µ'">
                </div>

                <!-- Row 4: Symptoms (Focus) -->
                <div class="health-form-group">
                    <label class="health-form-label text-[#064e43] text-base">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤ (‡∏£‡∏∞‡∏ö‡∏∏‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î)</label>
                    <textarea id="hf-symptoms" rows="4" class="health-form-input border-[#50b5a5] shadow-sm text-base" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡∏ß‡∏î‡∏´‡∏±‡∏ß‡∏ï‡∏∏‡∏ö‡πÜ ‡∏Ç‡∏°‡∏±‡∏ö‡∏Ç‡∏ß‡∏≤ ‡∏°‡∏≤ 2 ‡∏ß‡∏±‡∏ô, ‡∏°‡∏µ‡πÑ‡∏Ç‡πâ‡∏ï‡πà‡∏≥‡πÜ, ‡πÄ‡∏à‡πá‡∏ö‡∏Ñ‡∏≠‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏•‡∏∑‡∏ô..."></textarea>
                </div>
            </div>

            <footer class="p-3 border-t border-gray-100 flex justify-end gap-3 bg-white">
                <button id="cancel-health-btn" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg text-sm font-bold">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button id="submit-health-btn" class="px-6 py-2 bg-[#50b5a5] hover:bg-[#2f8f80] text-white rounded-lg text-sm font-bold shadow-lg transition-all flex items-center gap-2">
                    <span>‚ö°</span> ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏≠‡∏≤‡∏Å‡∏≤‡∏£
                </button>
            </footer>
        </div>
    </div>

    <!-- Result Dialog (Popup) -->
    <div id="result-modal-overlay" class="absolute inset-0 bg-black/70 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-2xl shadow-2xl flex flex-col max-h-[85vh] overflow-hidden">
            <header class="p-4 border-b border-gray-100 flex justify-between items-center bg-white sticky top-0">
                <div class="flex items-center gap-2 text-[#064e43] font-bold text-xl">
                    <span>ü§ñ</span> ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå (AI)
                </div>
                <button id="close-result-modal" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
            </header>
            
            <div id="result-content-area" class="p-6 overflow-y-auto bg-[#fffdf7] text-gray-800 text-base leading-relaxed result-markdown">
                <!-- Loading State -->
                <div class="flex flex-col items-center justify-center py-10 space-y-4 text-gray-500">
                     <div class="w-10 h-10 border-4 border-gray-200 border-t-[#50b5a5] rounded-full animate-spin"></div>
                     <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...</p>
                </div>
            </div>

            <footer class="p-4 border-t border-gray-100 bg-gray-50 text-xs text-center text-gray-500">
                ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏≤‡∏Å AI ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå ‡πÇ‡∏õ‡∏£‡∏î‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏´‡∏≤‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á
            </footer>
        </div>
    </div>

  </div>

<script>
/** ================== CONFIG ================== **/
const API_JSON_URL = 'https://raw.githubusercontent.com/tontakankeawpang321-glitch/krsitsdeeka/main/drugs.json';
const PAGE_SIZE = 12;

/** =============== Utilities =============== **/
const $$ = (sel, el=document)=>el.querySelector(sel);
const escapeHtml = (s='') => String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
const stripHtml = (html='') => { const t=document.createElement('div'); t.innerHTML=html; return t.textContent||t.innerText||''; };

const CAT_TH_TO_KEY = {
  '‡∏¢‡∏≤‡πÅ‡∏Å‡πâ‡∏õ‡∏ß‡∏î': 'analgesic', '‡∏¢‡∏≤‡∏•‡∏î‡πÑ‡∏Ç‡πâ': 'antipyretic', '‡∏¢‡∏≤‡∏Ü‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πâ‡∏≠': 'antibiotic',
  '‡∏¢‡∏≤‡πÅ‡∏Å‡πâ‡πÅ‡∏û‡πâ': 'antihistamine', '‡∏¢‡∏≤‡∏•‡∏î‡∏Å‡∏£‡∏î/‡∏Å‡∏£‡∏∞‡πÄ‡∏û‡∏≤‡∏∞': 'antacid',
  '‡∏¢‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏≠/‡∏Ç‡∏±‡∏ö‡πÄ‡∏™‡∏°‡∏´‡∏∞': 'cough', '‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô/‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏°': 'vitamin'
};

function normalizeDrug(x={}){
  if (x.name || x.generic || x.category || x.contentHtml) {
    return {
      id: String(x.id || ''), name: String(x.name || ''), generic: String(x.generic || ''),
      category: String(x.category || ''), descHtml: String(x.contentHtml || ''),
      caution: String(x.caution || ''), sources: Array.isArray(x.sources) ? x.sources : String(x.sources||'').split(/[|,;]+/).map(s=>s.trim()).filter(Boolean),
      updatedAt: String(x.updatedAt || '')
    };
  }
  const thaiName = x['‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤']; const thaiCat = x['‡∏´‡∏°‡∏ß‡∏î'];
  const thaiDesc = x['‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏¢‡∏≤‡πÅ‡∏ö‡∏ö‡∏û‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à']; const thaiCaution = x['‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥'];
  const thaiSrc = x['‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á url'];
  const key = CAT_TH_TO_KEY[thaiCat] || (String(thaiCat||'').toLowerCase()) || '';
  return {
    id: String(x.id || ''), name: String(thaiName || ''), generic: '',
    category: key, descHtml: escapeHtml(String(thaiDesc || '')).replace(/\n/g, '<br>'),
    caution: String(thaiCaution || ''), sources: String(thaiSrc||'').split(/[|,;]+/).map(s=>s.trim()).filter(Boolean),
    updatedAt: ''
  };
}

/** =============== Fetch & Render =============== **/
async function fetchData(){
  const res = await fetch(API_JSON_URL, {cache:'no-store'});
  if(!res.ok) throw new Error(`‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (status: ${res.status})`);
  const json = await res.json();
  const arr = Array.isArray(json) ? json : (Array.isArray(json.data) ? json.data : []);
  return arr.map(normalizeDrug).filter(drug => drug.name && drug.name.trim() !== '');
}

let raw = []; let view = []; let page = 1;

function renderPage(){
  const total = view.length; const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
  page = Math.min(Math.max(1, page), totalPages);
  const start = (page-1)*PAGE_SIZE; const cur = view.slice(start, start+PAGE_SIZE);
  const g = document.getElementById('grid');
  if(!cur.length){
    g.innerHTML = `<div style="grid-column:1/-1; text-align:center; color:#475569; padding:24px">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤</div>`;
  }else{
    g.innerHTML = cur.map(it=>{
      const catClass = it.category ? ` cat-${escapeHtml(it.category)}` : '';
      const excerpt = stripHtml(it.descHtml || '').slice(0,180);
      const srcs = (it.sources||[]).length ? `<div class="tag">${escapeHtml(it.sources[0])}${it.sources.length>1?'‚Ä¶':''}</div>` : '';
      return `
        <article class="card${catClass}" data-id="${escapeHtml(it.id)}" data-name="${escapeHtml(it.name)}">
          <h3 class="drug-name">üíä ${escapeHtml(it.name || '(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠)')}</h3>
          ${it.generic ? `<div class="generic">(${escapeHtml(it.generic)})</div>`:''}
          <div class="meta">
            ${it.category ? `<span class="pill">‡∏´‡∏°‡∏ß‡∏î: ${escapeHtml(it.category)}</span>`:''}
            ${it.updatedAt ? `<span class="pill">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï: ${escapeHtml(it.updatedAt)}</span>`:''}
          </div>
          <div class="excerpt">${escapeHtml(excerpt)}${excerpt.length>=180?'‚Ä¶':''}</div>
          <div class="tags">${srcs}</div>
          <button class="btn" onclick="openDrugModal('${encodeURIComponent(it.id)}','${encodeURIComponent(it.name)}')">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
        </article>
      `;
    }).join('');
  }
  document.getElementById('pageInfo').textContent = `‡∏´‡∏ô‡πâ‡∏≤ ${page} / ${totalPages}`;
  document.getElementById('prevBtn').disabled = page<=1;
  document.getElementById('nextBtn').disabled = page>=totalPages;
}

/** =============== Modal Logic (Drug Info) =============== **/
let scrollY = 0;
function lockBody(){
  scrollY = window.scrollY || document.documentElement.scrollTop;
  document.body.classList.add('no-scroll'); document.body.style.position = 'fixed';
  document.body.style.top = `-${scrollY}px`; document.body.style.left = '0'; document.body.style.right = '0';
  document.getElementById('mainContent').setAttribute('inert','');
}
function unlockBody(){
  document.body.classList.remove('no-scroll'); document.body.style.position = '';
  document.body.style.top = ''; document.body.style.left = ''; document.body.style.right = '';
  window.scrollTo(0, scrollY); document.getElementById('mainContent').removeAttribute('inert');
}

function openDrugModal(encodedId, encodedName){
  const id = decodeURIComponent(encodedId || '');
  const name = decodeURIComponent(encodedName || '');
  const it = raw.find(x=> (x.id && x.id===id) || (x.name===name)) || {};
  document.getElementById('mTitle').textContent = it.name || '(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠)';
  document.getElementById('mMeta').innerHTML = `
    ${it.category ? `<span class="pill">‡∏´‡∏°‡∏ß‡∏î: ${escapeHtml(it.category)}</span>`:''}
    ${it.caution ? `<span class="pill" style="border-color:#fca5a5; background:#fff1f2; color:#991b1b;">‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ${escapeHtml(it.caution)}</span>`:''}
  `;
  document.getElementById('mContent').innerHTML = it.descHtml || '';
  const srcs = (it.sources||[]).map(s=>`<a href="${escapeHtml(s)}" target="_blank" rel="noopener nofollow">${escapeHtml(s)}</a>`).join('<br>');
  document.getElementById('mSources').innerHTML = srcs ? `<strong>‡πÅ‡∏´‡∏•‡πà‡∏á‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á:</strong><br>${srcs}` : '';
  document.getElementById('modalBackdrop').classList.add('show');
  lockBody();
}
function closeModal(){
  document.getElementById('modalBackdrop').classList.remove('show');
  unlockBody();
}
document.getElementById('closeModal').addEventListener('click', closeModal);
document.getElementById('modalBackdrop').addEventListener('click', (e)=>{ if(e.target.id==='modalBackdrop') closeModal(); });

/** =============== Search & Pager =============== **/
document.getElementById('prevBtn').addEventListener('click', ()=>{ page=Math.max(1,page-1); renderPage(); });
document.getElementById('nextBtn').addEventListener('click', ()=>{ page=page+1; renderPage(); });
function applySearch(){
  const q = document.getElementById('q').value.trim().toLowerCase();
  const category = document.getElementById('cat').value.trim().toLowerCase();
  view = raw.filter(it=>{
    const hitQ = !q || [it.name, it.generic, stripHtml(it.descHtml||''), it.caution, (it.sources||[]).join(' ')].join(' | ').toLowerCase().includes(q);
    const hitCat = !category || (String(it.category||'').toLowerCase() === category);
    return hitQ && hitCat;
  });
  page = 1; renderPage();
}
document.getElementById('searchBtn').addEventListener('click', applySearch);
document.getElementById('clearBtn').addEventListener('click', ()=>{
  document.getElementById('q').value=''; document.getElementById('cat').value='';
  view=raw.slice(0); page=1; renderPage();
});
document.getElementById('q').addEventListener('keydown', e=>{ if(e.key==='Enter') applySearch(); });
document.getElementById('cat').addEventListener('change', applySearch);

(async function init(){
  // skeleton
  document.getElementById('grid').innerHTML = Array.from({length:6}).map(()=>`
    <div class="card">
      <div class="skeleton" style="height:18px; width:70%; border-radius:8px; margin-bottom:8px"></div>
      <div class="skeleton" style="height:10px; width:50%; border-radius:8px; margin-bottom:12px"></div>
      <div class="skeleton" style="height:60px; border-radius:12px; margin-bottom:12px"></div>
      <div class="skeleton" style="height:36px; width:120px; border-radius:10px"></div>
    </div>
  `).join('');

  try{
    raw = await fetchData();
    view = raw.slice(0);
    renderPage();
  }catch(e){
    document.getElementById('grid').innerHTML =
      `<div style="grid-column:1/-1; text-align:center; padding:24px; color:#b91c1c">
        ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${escapeHtml(e.message||String(e))}
      </div>`;
  }
})();


/** =========================================
    3. ‡∏™‡πà‡∏ß‡∏ô Chatbot AI + Health Assessment Logic
    ========================================= */
const API_URL = 'https://app.ai-tontakan.online/api/generate';
const OLLAMA_MODEL = 'llama3.2:3b';

// Helper Function: ‡∏™‡∏£‡πâ‡∏≤‡∏á Prompt String ‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏ó
function constructPromptFromHistory(history) {
    // ‡πÅ‡∏õ‡∏•‡∏á role ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà AI ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢‡πÜ
    // model -> AI Pharmacist, user -> User
    return history.map(msg => {
        const roleName = msg.role === 'model' ? 'AI Pharmacist' : 'User';
        return `${roleName}: ${msg.parts[0].text}`;
    }).join('\n') + '\nAI Pharmacist:'; // ‡∏à‡∏ö‡∏î‡πâ‡∏ß‡∏¢ AI ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö
}

const SYSTEM_PROMPT = {
    role: "user",
    parts: [{ text: "‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ AI ‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£ ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≤‡πÄ‡∏ä‡∏¥‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ ‡πÑ‡∏°‡πà‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢‡πÇ‡∏£‡∏Ñ" }]
};
const SYSTEM_ACK = {
    role: "model",
    parts: [{ text: "‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ú‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≤‡πÅ‡∏•‡∏∞‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Ñ‡∏£‡∏±‡∏ö" }]
};

let chatHistory = [SYSTEM_PROMPT, SYSTEM_ACK];

// DOM Elements
const chatHistoryEl = document.getElementById('chat-history');
const userInput = document.getElementById('user-input');
const sendBtn = document.getElementById('send-btn');
const newChatBtn = document.getElementById('new-chat-btn');
const thinkingIndicator = document.getElementById('thinking-indicator');
const chatModal = document.getElementById('chatbot-modal');

// Health Modal Elements
const healthCheckBtn = document.getElementById('health-check-btn');
const healthModalOverlay = document.getElementById('health-modal-overlay');
const closeHealthModalBtn = document.getElementById('close-health-modal');
const cancelHealthBtn = document.getElementById('cancel-health-btn');
const submitHealthBtn = document.getElementById('submit-health-btn');

// Result Modal Elements
const resultModalOverlay = document.getElementById('result-modal-overlay');
const closeResultModalBtn = document.getElementById('close-result-modal');
const resultContentArea = document.getElementById('result-content-area');

// --- Helper Functions ---
function addChatBubble(message, isUser = true) {
    const bubbleType = isUser ? 'user' : 'model';
    const icon = isUser ? 'üë§' : 'ü§ñ';
    const bgClass = isUser ? 'bg-[#50b5a5] text-white' : 'bg-white text-gray-800 border border-gray-200';
    
    const wrap = document.createElement('div');
    wrap.className = `flex items-start space-x-2 ${isUser ? 'flex-row-reverse space-x-reverse' : ''}`;
    
    const bubble = document.createElement('div');
    bubble.className = `chat-bubble chat-bubble-${bubbleType} ${bgClass} p-3 rounded-lg max-w-lg relative shadow-sm`;
    bubble.innerHTML = `<p>${message.replace(/\n/g, '<br>')}</p>`;
    
    wrap.innerHTML = `<span class="text-2xl">${icon}</span>`;
    wrap.appendChild(bubble);
    
    chatHistoryEl.appendChild(wrap);
    chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
}

function setThinking(on) {
    thinkingIndicator.classList.toggle('hidden', !on);
    if (on) chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
}

// --- Chat Logic (Ollama Local) ---
async function handleSend() {
    const message = (userInput.value || '').trim();
    if (!message) return;

    addChatBubble(message, true);
    userInput.value = '';
    setThinking(true);
    
    sendBtn.disabled = true;
    setTimeout(() => sendBtn.disabled = false, 5000);

    chatHistory.push({ role: "user", parts: [{ text: message }] });

    // Limit History size locally before processing
    if (chatHistory.length > 8) { 
         // Keep system prompt + ack + last 6 messages
         chatHistory = [chatHistory[0], chatHistory[1], ...chatHistory.slice(2).slice(-6)];
    }

    // Convert array history to single string prompt for Ollama /api/generate
    const fullPrompt = constructPromptFromHistory(chatHistory);

    try {
        const response = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                model: OLLAMA_MODEL,
                prompt: fullPrompt,
                stream: false
            }) 
        });

        if (!response.ok) throw new Error("‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á");
        const data = await response.json();
        // Ollama returns response in 'response' field
        const aiReply = data.response || "(‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö)";

        chatHistory.push({ role: "model", parts: [{ text: aiReply }] });
        setThinking(false);
        addChatBubble(aiReply, false);

    } catch (err) {
        setThinking(false);
        addChatBubble(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${err.message}. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Ollama ‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà`, false);
        // Don't pop history so user can retry or see context
    } 
}

sendBtn.addEventListener('click', handleSend);
userInput.addEventListener('keydown', e => { if (e.key === 'Enter') handleSend(); });
newChatBtn.addEventListener('click', () => {
    chatHistory = [SYSTEM_PROMPT, SYSTEM_ACK]; 
    chatHistoryEl.innerHTML = `<div class="flex items-start space-x-2"><span class="text-2xl">ü§ñ</span><div class="chat-bubble chat-bubble-model bg-white text-gray-800 p-3 rounded-lg max-w-lg relative border border-gray-200 shadow-sm"><p>‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ú‡∏°‡∏Ñ‡∏∑‡∏≠ AI ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£ ‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö</p></div></div>`;
    userInput.value = '';
    setThinking(false);
});

// --- Chatbot Toggle ---
const fabToggle = document.getElementById('fab-chat-toggle');
fabToggle.addEventListener('click', () => { chatModal.classList.remove('chatbot-hidden'); fabToggle.style.opacity = '0'; });
document.getElementById('chatbot-close-btn').addEventListener('click', () => { chatModal.classList.add('chatbot-hidden'); fabToggle.style.opacity = '1'; });

/** ==========================================
 * HEALTH ASSESSMENT & RESULT DIALOG LOGIC
 * ========================================== */

// 1. Chips Logic
const diseaseChips = document.querySelectorAll('.chip-option');
diseaseChips.forEach(chip => {
    chip.addEventListener('click', () => {
        const val = chip.getAttribute('data-val');
        if (val === '‡πÑ‡∏°‡πà‡∏°‡∏µ') {
            diseaseChips.forEach(c => c.classList.remove('selected'));
            chip.classList.add('selected');
        } else {
            document.querySelector('.chip-option[data-val="‡πÑ‡∏°‡πà‡∏°‡∏µ"]').classList.remove('selected');
            chip.classList.toggle('selected');
        }
    });
});
document.querySelector('.chip-option[data-val="‡πÑ‡∏°‡πà‡∏°‡∏µ"]').classList.add('selected');

// 2. Modals Control
function toggleHealthModal(show) { healthModalOverlay.classList.toggle('hidden', !show); }
function toggleResultModal(show) { resultModalOverlay.classList.toggle('hidden', !show); }

healthCheckBtn.addEventListener('click', () => toggleHealthModal(true));
closeHealthModalBtn.addEventListener('click', () => toggleHealthModal(false));
cancelHealthBtn.addEventListener('click', () => toggleHealthModal(false));
closeResultModalBtn.addEventListener('click', () => toggleResultModal(false));

// 3. Submit & Analyze (Ollama Local)
submitHealthBtn.addEventListener('click', async () => {
    // Collect Data
    const age = document.getElementById('hf-age').value.trim() || '-';
    const gender = document.getElementById('hf-gender').value;
    const weight = document.getElementById('hf-weight').value.trim() || '-';
    const height = document.getElementById('hf-height').value.trim() || '-';
    const allergy = document.getElementById('hf-allergy').value.trim() || '‡πÑ‡∏°‡πà‡∏°‡∏µ';
    const symptoms = document.getElementById('hf-symptoms').value.trim();
    
    // Collect diseases
    let selectedDiseases = Array.from(document.querySelectorAll('.chip-option.selected')).map(c => c.getAttribute('data-val'));
    const otherDisease = document.getElementById('hf-disease-other').value.trim();
    if(otherDisease) selectedDiseases.push(otherDisease);
    if(selectedDiseases.length === 0) selectedDiseases = ['‡πÑ‡∏°‡πà‡∏°‡∏µ'];
    const diseaseStr = selectedDiseases.join(', ');

    if(!symptoms) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤");
        return;
    }

    // Close Form -> Open Result Loading
    toggleHealthModal(false);
    toggleResultModal(true);
    
    // Reset Result Content to Loading
    resultContentArea.innerHTML = `
        <div class="flex flex-col items-center justify-center py-10 space-y-4 text-gray-500">
             <div class="w-10 h-10 border-4 border-gray-200 border-t-[#50b5a5] rounded-full animate-spin"></div>
             <p>AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
        </div>`;

    // FIX 2: ‡∏õ‡∏£‡∏±‡∏ö Prompt ‡πÉ‡∏´‡πâ Soft ‡∏•‡∏á
    const prompt = `
    ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢):
    - ‡πÄ‡∏û‡∏®: ${gender} ‡∏≠‡∏≤‡∏¢‡∏∏ ${age}
    - ‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß: ${diseaseStr}
    - ‡πÅ‡∏û‡πâ‡∏¢‡∏≤: ${allergy}
    - ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πà‡∏≤: "${symptoms}"

    ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:
    1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏≠‡∏≤‡∏Å‡∏≤‡∏£
    2. ‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏î‡∏π‡πÅ‡∏•‡∏ï‡∏ô‡πÄ‡∏≠‡∏á‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
    3. ‡∏¢‡∏≤‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ö‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà "‡∏≠‡∏≤‡∏à" ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ
    4. ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡πÑ‡∏õ‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå
    `;

    // AI Call (Ollama Local)
    try {
        const response = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                model: OLLAMA_MODEL,
                prompt: prompt, // Use the prompt string directly
                stream: false
            }) 
        });

        if (!response.ok) throw new Error("‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á");
        const data = await response.json();
        // Ollama returns response in 'response' field
        const aiText = data.response || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ";

        // Display Result using Marked (Markdown Parser)
        resultContentArea.innerHTML = marked.parse(aiText);

    } catch (err) {
        resultContentArea.innerHTML = `
            <div class="text-center text-red-600 py-10">
                <p class="text-xl font-bold">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</p>
                <p>${err.message}</p>
                <p class="text-sm mt-2 text-gray-500">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡∏¥‡∏î Ollama (llama3.2:3b) ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á</p>
                <button onclick="toggleResultModal(false)" class="mt-4 text-sm underline text-gray-500">‡∏õ‡∏¥‡∏î</button>
            </div>`;
    }
});

</script>
</body>
</html>
