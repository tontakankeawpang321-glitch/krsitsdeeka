<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏û‡∏à‡∏ô‡∏≤‡∏ô‡∏∏‡∏Å‡∏£‡∏°‡∏†‡∏≤‡∏©‡∏≤‡∏°‡∏∑‡∏≠‡πÑ‡∏ó‡∏¢ (TSL) + AI</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://unpkg.com/lucide@latest"></script>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;600;700&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        body { font-family: 'Noto Sans Thai', sans-serif; }

        /* ==== 3D Card Effects ==== */
        .card-3d {
            background: linear-gradient(145deg, #ffffff, #e6e6e6);
            box-shadow: 8px 8px 20px #d1d1d1, -8px -8px 20px #ffffff;
            transition: 0.2s;
        }
        .card-3d:active {
            transform: scale(0.96);
            box-shadow: inset 5px 5px 15px #cfcfcf, inset -5px -5px 15px #ffffff;
        }
        .btn-3d {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            box-shadow: 4px 4px 12px rgba(99,102,241,0.4);
            transition: 0.2s;
        }
        .btn-3d:active {
            transform: scale(0.95);
            box-shadow: inset 4px 4px 10px rgba(0,0,0,0.2);
        }

        /* Glass */
        .glass {
            background: rgba(255,255,255,0.7);
            backdrop-filter: blur(10px);
        }

        /* Scrollbar Hide */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes zoomIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.25s ease-out forwards; }
        .animate-zoom-in { animation: zoomIn 0.25s ease-out forwards; }

        /* Consonant Card Style */
        .consonant-card {
            aspect-ratio: 3/4;
            background: linear-gradient(145deg, #ffffff, #e6e6e6);
            border-radius: 16px;
            box-shadow: 6px 6px 16px #d1d1d1, -6px -6px 16px #ffffff;
            overflow: hidden;
            transition: 0.2s;
        }
        .consonant-card:active {
            transform: scale(0.95);
        }

        /* ===== CSS ‡∏Ç‡∏≠‡∏á Chatbot UI (Indigo Theme) ===== */
        .chat-bubble::before { content: ''; position: absolute; width: 0; height: 0; border-style: solid; }
        .chat-bubble-user::before {
            border-width: 0 12px 12px 12px; border-color: transparent transparent #4f46e5 transparent; /* Indigo-600 */
            top: -10px; right: 12px;
        }
        .chat-bubble-model::before {
            border-width: 0 12px 12px 12px; border-color: transparent transparent #e5e7eb transparent;
            top: -10px; left: 12px;
        }
        .gemini-thinking-bar {
            position: relative; width: 100%; height: 4px; background-color: #e0e0e0;
            border-radius: 2px; overflow: hidden;
        }
        .gemini-thinking-bar::before {
            content: ''; position: absolute; top: 0; left: 0; height: 100%; width: 100%;
            background: linear-gradient(90deg, #4f46e5, #818cf8, #4f46e5);
            background-size: 200% 100%; animation: thinking-gradient 2s linear infinite;
        }
        @keyframes thinking-gradient { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        
        #fab-chat-toggle {
            position: fixed; bottom: 25px; right: 25px;
            width: 60px; height: 60px;
            background-color: #4f46e5; /* Indigo */
            color: white;
            border: none; border-radius: 50%;
            font-size: 28px; line-height: 60px; text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            cursor: pointer; z-index: 998;
            transition: transform 0.2s, opacity 0.3s;
        }
        #fab-chat-toggle:hover { transform: scale(1.05); background-color: #4338ca; }
        
        #chatbot-modal {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: 1000; transition: opacity 0.3s, transform 0.3s;
            opacity: 1; transform: translateY(0); pointer-events: auto;
        }
        #chatbot-modal.chatbot-hidden {
            opacity: 0; transform: translateY(100%); pointer-events: none;
        }
    </style>
</head>

<body class="bg-slate-100 text-slate-800 pb-10">

<header class="sticky top-0 z-40 shadow-xl bg-gradient-to-r from-blue-600 to-indigo-600 text-white">
    <div class="max-w-5xl mx-auto px-4 py-5 flex items-center gap-4">
        <div class="p-2 bg-white/20 rounded-xl shadow-inner">
            <i data-lucide="hand" class="w-8 h-8 text-yellow-300"></i>
        </div>
        <div>
            <h1 class="text-2xl font-bold drop-shadow">‡∏û‡∏à‡∏ô‡∏≤‡∏ô‡∏∏‡∏Å‡∏£‡∏°‡∏†‡∏≤‡∏©‡∏≤‡∏°‡∏∑‡∏≠‡πÑ‡∏ó‡∏¢ (TSL)</h1>
            <p class="text-blue-100 text-sm opacity-90">AI + ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏ó‡πà‡∏≤‡∏ó‡∏≤‡∏á</p>
        </div>
    </div>
</header>

<main class="max-w-5xl mx-auto px-4 py-6 space-y-6">

    <div class="sticky top-[72px] z-30 bg-slate-100/80 backdrop-blur-md py-4 px-2 -mx-4 border-b border-slate-200 shadow-sm">

        <div class="relative max-w-lg mx-auto md:mx-0">
            <div class="absolute left-3 top-0 bottom-0 flex items-center text-slate-400">
                <i data-lucide="search" class="w-5 h-5"></i>
            </div>
            <input
                id="searchInput"
                type="text"
                placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ , ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß , ‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå ‚Ä¶"
                class="w-full pl-10 pr-4 py-3 rounded-2xl border border-slate-200 shadow-md glass focus:ring-2 focus:ring-indigo-400 outline-none transition"
            />
        </div>

        <div class="flex items-center gap-2 overflow-x-auto scrollbar-hide mt-3 pb-1">
            <div id="categoryContainer" class="flex gap-2"></div>
        </div>
    </div>
    
    <div id="dataLoadingState" class="hidden py-10 text-center">
        <div class="animate-spin w-10 h-10 border-4 border-indigo-200 border-t-indigo-600 rounded-full mx-auto mb-3"></div>
        <p class="text-slate-500 text-sm">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Ä¶</p>
    </div>

    <div id="gridContainer" class="grid gap-4 min-h-[60vh]">
        </div>

    <div id="notFoundMessage" class="hidden py-12 text-center text-slate-400">
        <i data-lucide="search" class="w-12 h-12 mx-auto mb-3 opacity-20"></i>
        <p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</p>
    </div>
</main>

<div id="modalOverlay"
    class="hidden fixed inset-0 z-[60] bg-black/60 backdrop-blur-md flex items-center justify-center px-4 animate-fade-in"
    onclick="handleModalClick(event)">
    
    <div class="bg-white rounded-3xl shadow-2xl max-w-lg w-full overflow-hidden animate-zoom-in max-h-[90vh] flex flex-col border border-slate-200">

        <div class="relative w-full aspect-video bg-slate-200 flex items-center justify-center">
            <img id="modalImage" src="" class="w-full h-full object-cover hidden" />
            
            <div id="modalNoImage" class="text-slate-400 text-center">
                <i data-lucide="image-off" class="w-10 h-10 mx-auto opacity-50"></i>
                <p class="text-sm">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</p>
            </div>

            <span id="modalCategoryBadge"
                class="absolute bottom-3 left-3 px-3 py-1 rounded-full text-xs font-bold text-white shadow-lg">
            </span>

            <button onclick="closeModal()"
                class="absolute top-3 right-3 p-2 bg-black/40 hover:bg-black/60 text-white rounded-full backdrop-blur-sm transition">
                <i data-lucide="x"></i>
            </button>
        </div>

        <div class="p-6 space-y-6 overflow-y-auto">

            <div class="flex gap-4 items-center">
                <div id="modalIconContainer"
                    class="w-16 h-16 rounded-2xl flex items-center justify-center text-3xl font-bold text-white shadow-xl">
                </div>
                <div>
                    <h2 id="modalWord" class="text-2xl font-extrabold text-slate-800 mb-1"></h2>
                    <p class="text-sm text-slate-500">‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏≥‡∏ó‡πà‡∏≤‡∏†‡∏≤‡∏©‡∏≤‡∏°‡∏∑‡∏≠</p>
                </div>
            </div>

            <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 shadow-inner">
                <p id="modalDescription" class="text-slate-700 leading-relaxed"></p>
            </div>

            <div id="modalTipContainer"
                class="hidden bg-amber-50 border border-amber-200 p-4 rounded-xl flex gap-3 items-start shadow-inner">
                
                <i data-lucide="lightbulb" class="text-amber-500 w-6 h-6"></i>
                
                <div>
                    <span class="font-bold text-amber-700 text-sm block mb-1">‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏à‡∏≥‡∏á‡πà‡∏≤‡∏¢:</span>
                    <p id="modalTip" class="text-sm text-amber-800"></p>
                </div>
            </div>

        </div>

        <div class="p-5 border-t border-slate-200 bg-white">
            <a id="modalYoutubeLink" href="#" target="_blank"
                class="w-full py-3 text-center rounded-xl font-bold flex items-center justify-center gap-2 transition active:scale-95">
                <i data-lucide="youtube"></i>
                <span id="modalYoutubeText">‡∏î‡∏π‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠</span>
            </a>
        </div>

    </div>
</div>

<footer>
    <p class="footer-links" style="text-align:center; margin-top:40px; color:#64748b; font-size:0.9rem;">
      ¬© 2025 Crow Studio |
      <a href="https://sites.google.com/view/privacy-policy-pdpa-crow-studi/%E0%B8%AB%E0%B8%99%E0%B8%B2%E0%B9%81%E0%B8%A3%E0%B8%81">‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</a> |
      <a href="‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏Ç‡πâ‡∏≠‡∏ï‡∏Å‡∏•‡∏á">‡∏Ç‡πâ‡∏≠‡∏ï‡∏Å‡∏•‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</a>
    </p>
</footer>

<button id="fab-chat-toggle" title="‡∏ñ‡∏≤‡∏° AI ‡∏†‡∏≤‡∏©‡∏≤‡∏°‡∏∑‡∏≠">Ai</button>

<div id="chatbot-modal" class="chatbot-hidden">
  <div class="flex flex-col h-screen bg-gray-100">
    <header class="bg-[#4f46e5] text-white p-4 flex justify-between items-center shadow-md">
      <div class="flex items-center gap-2">
          <span class="text-2xl">üñêÔ∏è</span>
          <h1 class="text-lg font-bold font-sans text-white m-0">AI ‡∏†‡∏≤‡∏©‡∏≤‡∏°‡∏∑‡∏≠</h1>
      </div>
      <div>
        <button id="new-chat-btn" class="bg-[#e0e7ff] hover:bg-[#c7d2fe] text-[#4f46e5] font-bold py-1 px-3 rounded mr-2 text-sm">
          ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
        </button>
        <button id="chatbot-close-btn" class="bg-gray-700 hover:bg-gray-900 text-white font-bold py-1 px-3 rounded text-sm">
          ‡∏õ‡∏¥‡∏î
        </button>
      </div>
    </header>

    <main id="chat-history" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50">
      <div class="flex items-start space-x-2">
        <span class="text-2xl">ü§ñ</span>
        <div class="chat-bubble chat-bubble-model bg-white text-gray-800 p-3 rounded-lg max-w-lg relative border border-gray-200 shadow-sm">
          <p>‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ú‡∏°‡∏Ñ‡∏∑‡∏≠ AI ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏†‡∏≤‡∏©‡∏≤‡∏°‡∏∑‡∏≠‡πÑ‡∏ó‡∏¢ (TSL) ‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏≥‡∏ó‡πà‡∏≤‡∏ó‡∏≤‡∏á ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢ ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏ß‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö</p>
        </div>
      </div>
    </main>

    <div id="thinking-indicator" class="p-4 hidden bg-gray-50">
      <div class="flex items-center space-x-2">
        <span class="text-2xl">ü§ñ</span>
        <div class="chat-bubble chat-bubble-model bg-white text-gray-800 p-3 rounded-lg max-w-lg relative border border-gray-200">
          <div class="gemini-thinking-bar"></div>
        </div>
      </div>
    </div>

    <footer class="bg-white p-3 shadow-inner border-t border-gray-200 m-0 w-full max-w-full">
      <div class="flex space-x-2">
        <input id="user-input" type="text" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° (‡πÄ‡∏ä‡πà‡∏ô ‡∏ó‡πà‡∏≤‡∏£‡∏±‡∏Å‡∏ó‡∏≥‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£)..." class="flex-1 p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#4f46e5] font-sans text-base text-gray-800">
        <button id="send-btn" class="bg-[#4f46e5] hover:bg-[#4338ca] text-white font-bold py-2 px-4 rounded-xl shadow-sm">
          ‡∏™‡πà‡∏á
        </button>
      </div>
    </footer>
  </div>
</div>

<script>
/* =========================
    CONFIG & GLOBAL STATE
   ========================= */

// ‚ö†Ô∏è Note: The client-side translation feature (existing logic) still relies on client key.
// But the new Chatbot connects to the secure Backend.
const apiKey = "AIzaSyD_9mzuoLZT-tka_73IpHJWpSsBWLEM8b4"; // Key ‡πÄ‡∏î‡∏¥‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏• Gloss (‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏≠‡∏¢‡∏π‡πà)

let signData = [];
let searchTerm = "";
let activeCategory = "all";

/* ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà */
const categories = [
    { id: "all",          label: "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î",          icon: "book-open" },
    { id: "consonant",    label: "‡∏û‡∏¢‡∏±‡∏ç‡∏ä‡∏ô‡∏∞ (‡∏Å-‡∏Æ)",    icon: "type" },
    { id: "number",       label: "‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç",            icon: "hash" },
    { id: "daily",        label: "‡∏Ñ‡∏≥‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô",        icon: "heart" },
    { id: "daily_life",   label: "‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô",     icon: "sun" },
    { id: "family",       label: "‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß",         icon: "users" },
    { id: "emotion",      label: "‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå",            icon: "smile" },
    { id: "place",        label: "‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà",           icon: "map-pin" },
    { id: "object",       label: "‡∏™‡∏¥‡πà‡∏á‡∏Ç‡∏≠‡∏á",           icon: "box" },
    { id: "food",         label: "‡∏≠‡∏≤‡∏´‡∏≤‡∏£/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°", icon: "cup-soda" },
    { id: "action",       label: "‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥",         icon: "zap" },
    { id: "conversation", label: "‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤",          icon: "message-circle" },
];


/* =========================
    CATEGORY COLOR SYSTEM
   ========================= */
function getCategoryStyles(c) {
    switch (c) {
        case "consonant": return { badge: "bg-orange-500", cardColor: "bg-orange-400", text: "text-white" };
        case "number": return { badge: "bg-green-500", cardColor: "bg-green-400", text: "text-white" };
        case "daily": return { badge: "bg-purple-500", cardColor: "bg-purple-400", text: "text-white" };
        case "daily_life": return { badge: "bg-indigo-500", cardColor: "bg-indigo-400", text: "text-white" };
        case "family": return { badge: "bg-blue-500", cardColor: "bg-blue-400", text: "text-white" };
        case "emotion": return { badge: "bg-pink-500", cardColor: "bg-pink-400", text: "text-white" };
        case "place": return { badge: "bg-emerald-500", cardColor: "bg-emerald-400", text: "text-white" };
        case "object": return { badge: "bg-slate-500", cardColor: "bg-slate-400", text: "text-white" };
        case "food": return { badge: "bg-amber-500", cardColor: "bg-amber-400", text: "text-white" };
        case "action": return { badge: "bg-cyan-500", cardColor: "bg-cyan-400", text: "text-white" };
        case "conversation": return { badge: "bg-red-500", cardColor: "bg-red-400", text: "text-white" };
        default: return { badge: "bg-sky-500", cardColor: "bg-sky-400", text: "text-white" };
    }
}

/* =========================
    LOAD JSON DATA
   ========================= */
async function fetchSignData() {
    document.getElementById("dataLoadingState").classList.remove("hidden");
    document.getElementById("gridContainer").classList.add("hidden");

    try {
        const res = await fetch("signs500.json");
        signData = await res.json();
        renderGrid();
    } catch (err) {
        gridContainer.innerHTML =
            `<div class='text-center text-red-500 col-span-full'>‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå <b>signs500.json</b></div>`;
    }

    document.getElementById("dataLoadingState").classList.add("hidden");
    document.getElementById("gridContainer").classList.remove("hidden");
}


/* =========================
       CATEGORY BUTTON UI
   ========================= */
function renderCategories() {
    const ctn = document.getElementById("categoryContainer");
    ctn.innerHTML = categories.map(c => {
        const active = (activeCategory === c.id);

        return `
        <button onclick="setActiveCategory('${c.id}')"
            class="px-4 py-2 whitespace-nowrap rounded-full border shadow 
                   ${active ? "bg-indigo-600 text-white border-indigo-600 shadow-lg" : "bg-white text-slate-600 border-slate-300 hover:bg-slate-50"} 
                   flex items-center gap-2 transition">
            <i data-lucide="${c.icon}" class="w-4 h-4"></i>
            ${c.label}
        </button>`;
    }).join("");

    lucide.createIcons();
}

function setActiveCategory(id) {
    activeCategory = id;
    renderCategories();
    renderGrid();
}


/* =========================
        RENDER GRID
   ========================= */
function renderGrid() {
    const grid = document.getElementById("gridContainer");
    const term = searchTerm.toLowerCase();

    const filtered = signData.filter(item => {
        const w = (item.word || "").toLowerCase();
        const d = (item.description || "").toLowerCase();

        const matchSearch = w.includes(term) || d.includes(term);
        const matchCategory = activeCategory === "all" || item.category === activeCategory;

        return matchSearch && matchCategory;
    });

    /* Layout */
    grid.className =
        activeCategory === "consonant"
            ? "grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-3"
            : "grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 gap-4";

    if (!filtered.length) {
        notFoundMessage.classList.remove("hidden");
        grid.innerHTML = "";
        return;
    }

    notFoundMessage.classList.add("hidden");

    grid.innerHTML = filtered.map(item => {
        const styles = getCategoryStyles(item.category);
        const short = (item.word || "").split(" ")[0];

        /* ==============
            Consonant Card
           ============== */
        if (item.category === "consonant") {
            return `
            <div onclick="openModal('${item.id}')"
                class="consonant-card cursor-pointer group">
                
                <div class="w-full h-[75%] overflow-hidden bg-slate-200">
                    <img src="${item.imageUrl || ""}" 
                         class="w-full h-full object-cover group-hover:scale-110 transition">
                </div>

                <div class="h-[25%] flex items-center justify-center text-2xl font-bold text-slate-800">
                    ${short}
                </div>
            </div>`;
        }

        /* ==============
            Standard Card (3D Small)
           ============== */
        return `
        <div onclick="openModal('${item.id}')"
            class="card-3d cursor-pointer flex items-center gap-3 p-3 rounded-xl border border-slate-200 hover:shadow-xl transition">

            <div class="w-12 h-12 rounded-xl flex items-center justify-center text-xl font-bold ${styles.cardColor} ${styles.text} shadow">
                ${short}
            </div>

            <div class="flex-1 min-w-0">
                <h3 class="font-bold text-slate-800 truncate">${item.word}</h3>
                <p class="text-[11px] text-slate-500 truncate">${item.description || ""}</p>
            </div>
        </div>`;
    }).join("");
}


/* =========================
         OPEN MODAL
   ========================= */
function openModal(id) {
    const item = signData.find(i => i.id == id);
    if (!item) return;

    document.body.style.overflow = "hidden";
    modalOverlay.classList.remove("hidden");

    const img = document.getElementById("modalImage");
    const noImg = document.getElementById("modalNoImage");

    if (item.imageUrl) {
        img.src = item.imageUrl;
        img.classList.remove("hidden");
        noImg.classList.add("hidden");
    } else {
        img.classList.add("hidden");
        noImg.classList.remove("hidden");
    }

    const styles = getCategoryStyles(item.category);

    modalCategoryBadge.textContent = styles.badgeLabel;
    modalCategoryBadge.className = `px-3 py-1 rounded-full text-xs font-bold text-white shadow-lg ${styles.badge}`;

    modalIconContainer.textContent = (item.word || "").charAt(0);
    modalIconContainer.className = `w-16 h-16 rounded-2xl flex items-center justify-center text-3xl font-bold shadow-lg ${styles.cardColor} ${styles.text}`;

    modalWord.textContent = item.word;
    modalDescription.textContent = item.description || "";

    if (item.tip) {
        modalTipContainer.classList.remove("hidden");
        modalTip.textContent = item.tip;
    } else {
        modalTipContainer.classList.add("hidden");
    }

    /* Youtube Button */
    if (item.youtubeUrl) {
        modalYoutubeLink.href = item.youtubeUrl;
        modalYoutubeLink.className = "bg-red-600 hover:bg-red-700 text-white rounded-xl py-3 flex items-center justify-center gap-2 shadow-md";
        modalYoutubeText.textContent = "‡∏î‡∏π‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏™‡∏≤‡∏ò‡∏¥‡∏ï";
    } else {
        const q = encodeURIComponent("‡∏†‡∏≤‡∏©‡∏≤‡∏°‡∏∑‡∏≠‡πÑ‡∏ó‡∏¢ " + item.word);
        modalYoutubeLink.href = `https://www.youtube.com/results?search_query=${q}`;
        modalYoutubeLink.className = "bg-slate-100 hover:bg-slate-200 rounded-xl py-3 text-slate-700 flex items-center justify-center gap-2";
        modalYoutubeText.textContent = "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô YouTube";
    }

    lucide.createIcons();
}

function closeModal() {
    modalOverlay.classList.add("hidden");
    document.body.style.overflow = "";
}

function handleModalClick(e) {
    if (e.target.id === "modalOverlay") closeModal();
}

/* =========================
         SEARCH LISTENER
   ========================= */
document.getElementById("searchInput").addEventListener("input", e => {
    searchTerm = e.target.value;
    renderGrid();
});


/* =========================
            INIT
   ========================= */
renderCategories();
fetchSignData();
lucide.createIcons();


/* =========================================
    ‡∏™‡πà‡∏ß‡∏ô Chatbot AI (Backend)
   ========================================= */
const BACKEND_URL = 'https://us-central1-law-ai-14740.cloudfunctions.net/api/chat';

// System Prompt: ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏†‡∏≤‡∏©‡∏≤‡∏°‡∏∑‡∏≠‡πÑ‡∏ó‡∏¢
const SYSTEM_PROMPT = {
    role: "user",
    parts: [{ text: "System Instruction: ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ AI ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô '‡∏†‡∏≤‡∏©‡∏≤‡∏°‡∏∑‡∏≠‡πÑ‡∏ó‡∏¢ (TSL)' ‡∏°‡∏µ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏ó‡πà‡∏≤‡∏ó‡∏≤‡∏á ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢ ‡πÅ‡∏•‡∏∞‡πÑ‡∏ß‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå‡∏Ç‡∏≠‡∏á‡∏†‡∏≤‡∏©‡∏≤‡∏°‡∏∑‡∏≠‡πÑ‡∏ó‡∏¢ (Gloss) ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏ô‡∏´‡∏π‡∏´‡∏ô‡∏ß‡∏Å ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏õ‡∏•‡∏á‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏≥‡πÉ‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡∏°‡∏∑‡∏≠ (Gloss) ‡πÑ‡∏î‡πâ ‡∏ï‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏†‡∏≤‡∏©‡∏≤‡∏™‡∏∏‡∏†‡∏≤‡∏û ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏á" }]
};
const SYSTEM_ACK = {
    role: "model",
    parts: [{ text: "‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ú‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡πÅ‡∏õ‡∏•‡∏†‡∏≤‡∏©‡∏≤‡∏°‡∏∑‡∏≠‡πÑ‡∏ó‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö" }]
};

let chatHistory = [SYSTEM_PROMPT, SYSTEM_ACK];

const chatHistoryEl = document.getElementById('chat-history');
const userInput = document.getElementById('user-input');
const sendBtn = document.getElementById('send-btn');
const newChatBtn = document.getElementById('new-chat-btn');
const thinkingIndicator = document.getElementById('thinking-indicator');

function addChatBubble(message, isUser = true) {
    const bubbleType = isUser ? 'user' : 'model';
    const icon = isUser ? 'üë§' : 'ü§ñ';
    const bgClass = isUser ? 'bg-[#4f46e5] text-white' : 'bg-white text-gray-800 border border-gray-200';
    
    const wrap = document.createElement('div');
    wrap.className = `flex items-start space-x-2 ${isUser ? 'flex-row-reverse space-x-reverse' : ''}`;
    
    const bubble = document.createElement('div');
    bubble.className = `chat-bubble chat-bubble-${bubbleType} ${bgClass} p-3 rounded-lg max-w-lg relative shadow-sm`;
    bubble.innerHTML = `<p>${message.replace(/\n/g, '<br>')}</p>`;
    
    wrap.innerHTML = `<span class="text-2xl">${icon}</span>`;
    wrap.appendChild(bubble);
    
    chatHistoryEl.appendChild(wrap);
    chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
}

function addChatError(message) {
    const w = document.createElement('div');
    w.className = 'flex justify-center my-2';
    w.innerHTML = `<span class="bg-red-100 text-red-700 text-xs font-semibold px-3 py-1 rounded-full">${message}</span>`;
    chatHistoryEl.appendChild(w);
    chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
}

function setThinking(on) {
    thinkingIndicator.classList.toggle('hidden', !on);
    if (on) chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
}

async function handleSend() {
    const message = (userInput.value || '').trim();
    if (!message) return;

    addChatBubble(message, true);
    userInput.value = '';
    setThinking(true);
    sendBtn.disabled = true;

    chatHistory.push({ role: "user", parts: [{ text: message }] });

    try {
        const response = await fetch(BACKEND_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ history: chatHistory }) 
        });

        if (!response.ok) {
            const errData = await response.json();
            throw new Error(errData.error || `Server error: ${response.status}`);
        }

        const data = await response.json(); 
        const aiReply = data.reply;

        chatHistory.push({ role: "model", parts: [{ text: aiReply }] });
        setThinking(false);
        addChatBubble(aiReply, false);

    } catch (err) {
        console.error("Fetch Error:", err);
        setThinking(false);
        addChatError(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${err.message}`);
        chatHistory.pop();
    } finally {
        sendBtn.disabled = false;
    }
}

sendBtn.addEventListener('click', handleSend);
userInput.addEventListener('keydown', e => {
    if (e.key === 'Enter') handleSend();
});

// Reset Chat
newChatBtn.addEventListener('click', () => {
    chatHistory = [SYSTEM_PROMPT, SYSTEM_ACK];
    chatHistoryEl.innerHTML = `
        <div class="flex items-start space-x-2">
        <span class="text-2xl">ü§ñ</span>
        <div class="chat-bubble chat-bubble-model bg-white text-gray-800 p-3 rounded-lg max-w-lg relative border border-gray-200 shadow-sm">
            <p>‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏†‡∏≤‡∏©‡∏≤‡∏°‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö</p>
        </div>
        </div>`;
    userInput.value = '';
    setThinking(false);
});

// Modal Control
const fabToggle = document.getElementById('fab-chat-toggle');
const chatModal = document.getElementById('chatbot-modal');
const chatbotCloseBtn = document.getElementById('chatbot-close-btn');

fabToggle.addEventListener('click', () => {
    chatModal.classList.remove('chatbot-hidden');
    fabToggle.style.opacity = '0';
});
chatbotCloseBtn.addEventListener('click', () => {
    chatModal.classList.add('chatbot-hidden');
    fabToggle.style.opacity = '1';
});
</script>
</body>
</html>
