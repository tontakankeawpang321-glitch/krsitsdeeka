<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>üìà Candlestick Library ‚Äì ‡πÅ‡∏ó‡πà‡∏á‡πÄ‡∏ó‡∏µ‡∏¢‡∏ô + ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ (AI Analyst)</title>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
:root{
  --bg:#0f172a; --paper:#fff; --ink:#0f172a;
  --muted:#475569; --line:#e2e8f0; --brand:#0f766e;
  --radius:16px; --shadow:0 16px 40px -22px rgba(15,23,42,.25);
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:"Sarabun",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:linear-gradient(180deg,#0f172a 0%, #0f172a 180px, #f1f5f9 180px, #f1f5f9 100%);
  color:var(--ink);
}
body.modal-open{
  overflow:hidden;
}
/* header */
header{
  position:sticky; top:0; z-index:50;
  background:rgba(15,23,42,.9);
  backdrop-filter:blur(8px);
  color:#fff; padding:14px 16px;
  box-shadow:0 10px 30px -20px rgba(0,0,0,.4)
}
header .wrap{
  max-width:980px; margin:auto; display:flex; gap:12px; align-items:center; flex-wrap:wrap;
}
.title{font-weight:700; font-size:1.25rem}
.search{
  margin-left:auto; display:flex; align-items:center; gap:8px;
  background:rgba(255,255,255,.12); padding:6px 10px; border-radius:999px; width:min(460px,100%)
}
.search input{border:none; outline:none; background:transparent; color:#fff; width:100%}
.search ::placeholder{color:rgba(255,255,255,.75)}
.layout{max-width:980px; margin:14px auto 30px; padding:0 16px}

/* filter buttons */
#filters{display:flex; gap:8px; margin-bottom:10px; flex-wrap:wrap;}
.filter-btn{
  border:1px solid rgba(15,118,110,.2);
  background:#fff;
  color:#0f172a;
  border-radius:999px;
  padding:5px 12px;
  cursor:pointer;
  font-size:.78rem;
}
.filter-btn.active{
  background:#0f766e;
  color:#fff;
  border-color:transparent;
}

/* list */
#candles{
  background:var(--paper); border-radius:var(--radius); box-shadow:var(--shadow);
  border:1px solid rgba(15,118,110,.08); padding:14px;
}
.card{
  display:grid; grid-template-columns:76px 1fr; gap:12px;
  border:1px solid var(--line); border-radius:14px;
  margin:10px 0; background:#fff; cursor:pointer;
  transition:transform .12s ease, box-shadow .12s ease;
}
.card:hover{transform:translateY(-2px); box-shadow:0 16px 30px -20px rgba(15,23,42,.2)}

/* ‡πÄ‡∏£‡∏≤‡∏ß‡∏≤‡∏î‡πÄ‡∏ó‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô list ‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ */
.thumb{
  width:100%; height:70px; border-radius:12px; background:#e2e8f0;
  display:flex; align-items:center; justify-content:center; overflow:hidden;
}
.list-candle{
  position:relative;
  width:32px; height:56px;
  display:flex; align-items:center; justify-content:center;
}
.list-candle .wick-top,
.list-candle .wick-bottom{
  position:absolute;
  width:3px; background:#0f172a; left:50%; transform:translateX(-50%);
  border-radius:99px;
}
.list-candle .wick-top{top:4px; height:20px; background:#0f172a;}
.list-candle .wick-bottom{bottom:4px; height:14px; background:#0f172a;}
.list-candle .body{
  width:16px; height:32px; border-radius:6px; background:#10b981;
}

/* text */
.c-name{font-weight:700; color:#0f172a}
.c-meta{color:#475569; font-size:.75rem}
.tag{display:inline-block; background:#ecfdf3; border:1px solid #bbf7d0; color:#166534; font-size:.7rem; padding:3px 8px; border-radius:999px; margin-top:4px}
.tag.red{background:#fef2f2; border-color:#fecaca; color:#b91c1c}
.tag.blue{background:#eff6ff; border-color:#dbeafe; color:#1d4ed8}

/* pager */
.pager{display:flex; justify-content:center; gap:8px; margin-top:8px; align-items:center}
.pager .btn{border:1px solid var(--line); background:#fff; border-radius:10px; padding:5px 10px; cursor:pointer}
.pager .btn[disabled]{opacity:.5; cursor:not-allowed}
.pager .info{font-size:.85rem; color:#475569; padding:3px 0}

/* dialog */
dialog.candle-dialog{
  width:min(720px, 95vw);
  border:none;
  border-radius:20px;
  background:#0f172a;
  color:#fff;
  padding:0;
  overflow:hidden;
  box-shadow:0 30px 70px -20px rgba(0,0,0,.55);
}
.cd-head{
  display:flex; gap:12px; align-items:center;
  padding:16px 18px 6px;
}
.cd-title{font-size:1.2rem; font-weight:700;}
.cd-close{
  margin-left:auto; background:rgba(255,255,255,.07);
  border:none; color:#fff; border-radius:999px; padding:6px 14px; cursor:pointer; font-weight:600;
}
.cd-body{padding:14px 18px 16px;}
.cd-sub{color:rgba(255,255,255,.6);font-size:.76rem;margin-bottom:14px;}
.cd-row{display:flex;gap:20px;align-items:center;}
.cd-left{
  width:140px;height:140px;
  background:rgba(255,255,255,.02);
  border:1px solid rgba(255,255,255,.03);
  border-radius:16px;
  display:flex;align-items:center;justify-content:center;
}
.cd-candle{
  position:relative;
  width:52px; height:100px;
  display:flex; align-items:center; justify-content:center;
}
.cd-right{flex:1;}
.cd-right h4{margin:.2rem 0 .4rem;font-size:.8rem;text-transform:uppercase;}
.cd-right p{margin:0 0 .5rem;font-size:.78rem;color:rgba(255,255,255,.75);}
.cd-tip{background:rgba(15,118,110,.14);border:1px solid rgba(148,163,184,.16);border-radius:12px;padding:8px 10px;font-size:.72rem;white-space:pre-wrap;}
.cd-footer{padding:10px 18px 16px;border-top:1px solid rgba(255,255,255,.05);text-align:right;}
.cd-link{background:#0f766e;color:#fff;border:none;border-radius:10px;padding:6px 12px;font-weight:600;text-decoration:none;font-size:.72rem;}
@media(max-width:600px){
  .cd-row{flex-direction:column;align-items:flex-start;}
  .cd-left{width:100%;justify-content:flex-start;}
}

/* === CSS ‡∏Ç‡∏≠‡∏á Chatbot UI (Trading/Dark Theme) === */
.chat-bubble::before { content: ''; position: absolute; width: 0; height: 0; border-style: solid; }
.chat-bubble-user::before {
  border-width: 0 12px 12px 12px; border-color: transparent transparent #0f766e transparent; /* Teal */
  top: -10px; right: 12px;
}
.chat-bubble-model::before {
  border-width: 0 12px 12px 12px; border-color: transparent transparent #e5e7eb transparent;
  top: -10px; left: 12px;
}
.gemini-thinking-bar {
  position: relative; width: 100%; height: 4px; background-color: #e0e0e0;
  border-radius: 2px; overflow: hidden;
}
.gemini-thinking-bar::before {
  content: ''; position: absolute; top: 0; left: 0; height: 100%; width: 100%;
  background: linear-gradient(90deg, #0f766e, #14b8a6, #0f766e);
  background-size: 200% 100%; animation: thinking-gradient 2s linear infinite;
}
@keyframes thinking-gradient { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

#fab-chat-toggle {
  position: fixed; bottom: 25px; right: 25px;
  width: 60px; height: 60px;
  background-color: #0f766e; /* Teal */
  color: white;
  border: none; border-radius: 50%;
  font-size: 28px; line-height: 60px; text-align: center;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  cursor: pointer; z-index: 998;
  transition: transform 0.2s, opacity 0.3s;
  font-family: 'Sarabun', sans-serif;
}
#fab-chat-toggle:hover { transform: scale(1.05); background-color: #115e59; }

#chatbot-modal {
  position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
  z-index: 1000; transition: opacity 0.3s, transform 0.3s;
  opacity: 1; transform: translateY(0); pointer-events: auto;
}
#chatbot-modal.chatbot-hidden {
  opacity: 0; transform: translateY(100%); pointer-events: none;
}
</style>
</head>
<body>

<header>
  <div class="wrap">
    <div class="title">üìà Candlestick Library ‚Äì ‡πÅ‡∏ó‡πà‡∏á‡πÄ‡∏ó‡∏µ‡∏¢‡∏ô + ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ</div>
    <div class="search">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="white" stroke-width="2" stroke-linecap="round"/></svg>
      <input id="q" type="search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: bullish / bearish / hammer / ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ ...">
    </div>
  </div>
</header>

<div class="layout">
  <div id="filters">
    <button class="filter-btn active" data-filter="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    <button class="filter-btn" data-filter="bullish">‡∏Ç‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô</button>
    <button class="filter-btn" data-filter="bearish">‡∏Ç‡∏≤‡∏•‡∏á</button>
    <button class="filter-btn" data-filter="tech">‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ</button>
  </div>
  <section id="candles"></section>
  <div id="pager" class="pager"></div>
</div>

<dialog id="detailDialog" class="candle-dialog">
  <div class="cd-head">
    <div class="cd-title" id="dTitle">PATTERN</div>
    <button class="cd-close" id="dClose">‡∏õ‡∏¥‡∏î</button>
  </div>
  <div class="cd-body">
    <div class="cd-sub" id="dSubtitle"></div>
    <div class="cd-row">
      <div class="cd-left" id="dCandleBox"></div>
      <div class="cd-right">
        <h4>‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</h4>
        <p id="dSummary"></p>
        <h4>‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ</h4>
        <div id="dTip" class="cd-tip"></div>
      </div>
    </div>
  </div>
  <div class="cd-footer">
    <a id="dLink" class="cd-link" target="_blank" rel="noopener">‡∏î‡∏π‡πÅ‡∏´‡∏•‡πà‡∏á‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á</a>
  </div>
</dialog>

<footer>
  <p class="footer-links" style="text-align:center; color:#475569; margin-top:20px;">
    ¬© 2025 Crow Studio |
    <a href="https://sites.google.com/view/privacy-policy-pdpa-crow-studi/%E0%B8%AB%E0%B8%99%E0%B8%B2%E0%B9%81%E0%B8%A3%E0%B8%81">‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</a> |
    <a href="‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏Ç‡πâ‡∏≠‡∏ï‡∏Å‡∏•‡∏á">‡∏Ç‡πâ‡∏≠‡∏ï‡∏Å‡∏•‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</a>
  </p>
</footer>

<button id="fab-chat-toggle" title="‡∏ñ‡∏≤‡∏° AI ‡πÄ‡∏ó‡∏£‡∏î‡πÄ‡∏î‡∏≠‡∏£‡πå">Ai</button>

<div id="chatbot-modal" class="chatbot-hidden">
  <div class="flex flex-col h-screen bg-gray-100">
    <header class="bg-[#0f172a] text-white p-4 flex justify-between items-center shadow-md">
      <div class="flex items-center gap-2">
          <span class="text-2xl">üìà</span>
          <h1 class="text-lg font-bold font-sans text-white m-0">AI ‡πÄ‡∏ó‡∏£‡∏î‡πÄ‡∏î‡∏≠‡∏£‡πå</h1>
      </div>
      <div>
        <button id="new-chat-btn" class="bg-[#0f766e] hover:bg-[#115e59] text-white font-bold py-1 px-3 rounded mr-2 text-sm">
          ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
        </button>
        <button id="chatbot-close-btn" class="bg-gray-700 hover:bg-gray-900 text-white font-bold py-1 px-3 rounded text-sm">
          ‡∏õ‡∏¥‡∏î
        </button>
      </div>
    </header>

    <main id="chat-history" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50">
      <div class="flex items-start space-x-2">
        <span class="text-2xl">ü§ñ</span>
        <div class="chat-bubble chat-bubble-model bg-white text-gray-800 p-3 rounded-lg max-w-lg relative border border-gray-200 shadow-sm">
          <p>‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ú‡∏°‡∏Ñ‡∏∑‡∏≠ AI Technical Analyst ‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ó‡πà‡∏á‡πÄ‡∏ó‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î 

[Image of candlestick chart analysis]
 ‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á Pattern ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏ï‡∏•‡∏≤‡∏î‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö</p>
        </div>
      </div>
    </main>

    <div id="thinking-indicator" class="p-4 hidden bg-gray-50">
      <div class="flex items-center space-x-2">
        <span class="text-2xl">ü§ñ</span>
        <div class="chat-bubble chat-bubble-model bg-white text-gray-800 p-3 rounded-lg max-w-lg relative border border-gray-200">
          <div class="gemini-thinking-bar"></div>
        </div>
      </div>
    </div>

    <footer class="bg-white p-3 shadow-inner border-t border-gray-200 m-0 w-full max-w-full">
      <div class="flex space-x-2">
        <input id="user-input" type="text" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° (‡πÄ‡∏ä‡πà‡∏ô Hammer ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£)..." class="flex-1 p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#0f766e] font-sans text-base">
        <button id="send-btn" class="bg-[#0f766e] hover:bg-[#115e59] text-white font-bold py-2 px-4 rounded-xl shadow-sm">
          ‡∏™‡πà‡∏á
        </button>
      </div>
    </footer>
  </div>
</div>

<script>
const SHEET_CSV_URL = "candlestick_full_local_with_real_data.csv";
let RAW = [], CURRENT = [];
let page = 1;
const pageSize = 10;
let currentFilter = "all";
const detailDialog = document.getElementById('detailDialog');
const dClose = document.getElementById('dClose');

function makeCandleElement(side, name){
  const lower = (name||"").toLowerCase();
  const wrap = document.createElement('div');
  wrap.className = 'cd-candle';
  const wickTop = document.createElement('div');
  wickTop.style.position = "absolute"; wickTop.style.top = "6px"; wickTop.style.left = "50%"; wickTop.style.transform = "translateX(-50%)";
  wickTop.style.width = "4px"; wickTop.style.height = "36px"; wickTop.style.background = "#fff"; wickTop.style.borderRadius = "99px";
  const wickBottom = document.createElement('div');
  wickBottom.style.position = "absolute"; wickBottom.style.bottom = "6px"; wickBottom.style.left = "50%"; wickBottom.style.transform = "translateX(-50%)";
  wickBottom.style.width = "4px"; wickBottom.style.height = "22px"; wickBottom.style.background = "#fff"; wickBottom.style.borderRadius = "99px";
  const body = document.createElement('div');
  body.style.width = "20px"; body.style.height = "48px"; body.style.borderRadius = "7px";
  if (side === "Bearish") body.style.background = "#ef4444";
  else if (side === "Bullish") body.style.background = "#10b981";
  else body.style.background = "#94a3b8";
  if (lower.includes("hammer") && !lower.includes("inverted")){
    wickTop.style.height = "8px"; wickBottom.style.height = "42px"; body.style.height = "30px";
  } else if (lower.includes("inverted") || lower.includes("shooting star")){
    wickTop.style.height = "44px"; wickBottom.style.height = "6px"; body.style.height = "28px";
  } else if (lower.includes("engulf")){ body.style.height = "58px"; }
  wrap.append(wickTop, body, wickBottom);
  return wrap;
}

async function loadCSV(){
  return new Promise((resolve,reject)=>{
    Papa.parse(SHEET_CSV_URL,{ download:true, header:true, skipEmptyLines:true, complete:res=>resolve(res.data), error:reject });
  });
}

function applyFilters(){
  const q = document.getElementById('q').value.trim().toLowerCase();
  CURRENT = RAW.filter(r=>{
    if (currentFilter === 'bullish' && r.side !== 'Bullish') return false;
    if (currentFilter === 'bearish' && r.side !== 'Bearish') return false;
    if (currentFilter === 'tech' && r.grouping !== '‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ') return false;
    const hay = `${r.name||""} ${r.side||""} ${r.grouping||""} ${r.summary||""} ${r.tip||""}`.toLowerCase();
    return q === "" ? true : hay.includes(q);
  });
  page = 1; renderList();
}

function renderList(){
  const host = document.getElementById('candles');
  host.innerHTML = "";
  if (CURRENT.length === 0){ host.innerHTML = `<div style="padding:10px;color:#475569">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>`; document.getElementById('pager').innerHTML = ""; return; }
  const totalPages = Math.ceil(CURRENT.length / pageSize);
  const start = (page-1)*pageSize; const end = start + pageSize;
  const slice = CURRENT.slice(start, end);
  slice.forEach(r=>{
    const card = document.createElement('article'); card.className = 'card';
    const thumb = document.createElement('div'); thumb.className = 'thumb';
    const listCandle = makeCandleElement(r.side, r.name); listCandle.style.transform = "scale(.7)"; thumb.appendChild(listCandle);
    const right = document.createElement('div');
    const tagColor = r.side === "Bearish" ? " red" : "";
    right.innerHTML = `<div class="c-name">${r.name||""}</div><div class="c-meta">${r.grouping||""} ${r.side? "‚Ä¢ "+r.side:""} ${r.count? "‚Ä¢ "+r.count+" ‡πÅ‡∏ó‡πà‡∏á":""}</div><span class="tag${tagColor}">${r.side||"Pattern"}</span>${r.grouping ? `<span class="tag blue">${r.grouping}</span>` : ""}`;
    card.append(thumb, right); card.addEventListener('click', ()=>openDialogFromRecord(r)); host.append(card);
  });
  renderPager(totalPages);
}

function renderPager(totalPages){
  const pager = document.getElementById('pager'); pager.innerHTML = "";
  const prev = document.createElement('button'); prev.className = 'btn'; prev.textContent = '‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö'; prev.disabled = page === 1; prev.onclick = ()=>{ page--; renderList(); };
  const next = document.createElement('button'); next.className = 'btn'; next.textContent = '‡∏ñ‡∏±‡∏î‡πÑ‡∏õ'; next.disabled = page === totalPages; next.onclick = ()=>{ page++; renderList(); };
  const info = document.createElement('div'); info.className = 'info'; info.textContent = `‡∏´‡∏ô‡πâ‡∏≤ ${page} / ${totalPages} (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${CURRENT.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`;
  pager.append(prev, info, next);
}

function openDialogFromRecord(r){
  document.getElementById('dTitle').textContent = r.name || "PATTERN";
  document.getElementById('dSubtitle').textContent = r.grouping ? `${r.grouping} ‚Ä¢ ${r.side||""}` : (r.side||"");
  document.getElementById('dSummary').textContent = r.summary || "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢";
  document.getElementById('dTip').textContent = r.tip || "‡πÉ‡∏ä‡πâ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö‡πÅ‡∏ô‡∏ß‡∏£‡∏±‡∏ö‡πÅ‡∏ô‡∏ß‡∏ï‡πâ‡∏≤‡∏ô‡∏à‡∏∞‡∏ä‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô";
  const link = document.getElementById('dLink');
  if (r.source_url){ link.href = r.source_url; link.style.display = "inline-block"; } else { link.style.display = "none"; }
  const box = document.getElementById('dCandleBox'); box.innerHTML = "";
  const imgPath = r.image || r.img || r.img_path || r.picture || "";
  if (imgPath){
    const img = document.createElement('img'); img.src = imgPath; img.alt = r.name;
    img.style.maxWidth = "100%"; img.style.maxHeight = "100%"; img.style.borderRadius = "12px"; img.loading = "lazy";
    box.appendChild(img);
  } else { box.appendChild(makeCandleElement(r.side, r.name)); }
  if (typeof detailDialog.showModal === "function") { detailDialog.showModal(); } else { detailDialog.style.display = "block"; }
  document.body.classList.add('modal-open');
}

dClose.addEventListener('click', () => { detailDialog.close(); document.body.classList.remove('modal-open'); });
detailDialog.addEventListener('close', () => { document.body.classList.remove('modal-open'); });

document.getElementById('q').addEventListener('input', applyFilters);
document.querySelectorAll('#filters .filter-btn').forEach(btn=>{
  btn.onclick = () => {
    document.querySelectorAll('#filters .filter-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active'); currentFilter = btn.dataset.filter; applyFilters();
  }
});

(async function init(){ RAW = await loadCSV(); applyFilters(); })();


/* =========================================
    ‡∏™‡πà‡∏ß‡∏ô Chatbot AI (Backend)
   ========================================= */
const BACKEND_URL = 'https://us-central1-law-ai-14740.cloudfunctions.net/api/chat';

// System Prompt: ‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ
const SYSTEM_PROMPT = {
    role: "user",
    parts: [{ text: "System Instruction: ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ AI ‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ (Technical Analyst) ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á Candlestick Patterns, Price Action ‡πÅ‡∏•‡∏∞ Indicators ‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏£‡∏≤‡∏ü ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏ï‡∏•‡∏≤‡∏î ‡πÅ‡∏•‡∏∞‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î‡∏î‡πâ‡∏ß‡∏¢‡∏†‡∏≤‡∏©‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ó‡∏£‡∏î‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏°‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡∏∞‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏ö‡∏ö‡πÄ‡∏à‡∏≤‡∏∞‡∏à‡∏á (Financial Advice) ‡πÉ‡∏´‡πâ‡πÄ‡∏ô‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏ó‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ" }]
};
const SYSTEM_ACK = {
    role: "model",
    parts: [{ text: "‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ú‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö" }]
};

let chatHistory = [SYSTEM_PROMPT, SYSTEM_ACK];

const chatHistoryEl = document.getElementById('chat-history');
const userInput = document.getElementById('user-input');
const sendBtn = document.getElementById('send-btn');
const newChatBtn = document.getElementById('new-chat-btn');
const thinkingIndicator = document.getElementById('thinking-indicator');

function addChatBubble(message, isUser = true) {
    const bubbleType = isUser ? 'user' : 'model';
    const icon = isUser ? 'üë§' : 'ü§ñ';
    const bgClass = isUser ? 'bg-[#0f766e] text-white' : 'bg-white text-gray-800 border border-gray-200';
    
    const wrap = document.createElement('div');
    wrap.className = `flex items-start space-x-2 ${isUser ? 'flex-row-reverse space-x-reverse' : ''}`;
    
    const bubble = document.createElement('div');
    bubble.className = `chat-bubble chat-bubble-${bubbleType} ${bgClass} p-3 rounded-lg max-w-lg relative shadow-sm`;
    bubble.innerHTML = `<p>${message.replace(/\n/g, '<br>')}</p>`;
    
    wrap.innerHTML = `<span class="text-2xl">${icon}</span>`;
    wrap.appendChild(bubble);
    
    chatHistoryEl.appendChild(wrap);
    chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
}

function addChatError(message) {
    const w = document.createElement('div');
    w.className = 'flex justify-center my-2';
    w.innerHTML = `<span class="bg-red-100 text-red-700 text-xs font-semibold px-3 py-1 rounded-full">${message}</span>`;
    chatHistoryEl.appendChild(w);
    chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
}

function setThinking(on) {
    thinkingIndicator.classList.toggle('hidden', !on);
    if (on) chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
}

async function handleSend() {
    const message = (userInput.value || '').trim();
    if (!message) return;

    addChatBubble(message, true);
    userInput.value = '';
    setThinking(true);
    sendBtn.disabled = true;

    chatHistory.push({ role: "user", parts: [{ text: message }] });

    try {
        const response = await fetch(BACKEND_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ history: chatHistory }) 
        });

        if (!response.ok) {
            const errData = await response.json();
            throw new Error(errData.error || `Server error: ${response.status}`);
        }

        const data = await response.json(); 
        const aiReply = data.reply;

        chatHistory.push({ role: "model", parts: [{ text: aiReply }] });
        setThinking(false);
        addChatBubble(aiReply, false);

    } catch (err) {
        console.error("Fetch Error:", err);
        setThinking(false);
        addChatError(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${err.message}`);
        chatHistory.pop();
    } finally {
        sendBtn.disabled = false;
    }
}

sendBtn.addEventListener('click', handleSend);
userInput.addEventListener('keydown', e => {
    if (e.key === 'Enter') handleSend();
});

// Reset Chat
newChatBtn.addEventListener('click', () => {
    chatHistory = [SYSTEM_PROMPT, SYSTEM_ACK];
    chatHistoryEl.innerHTML = `
        <div class="flex items-start space-x-2">
        <span class="text-2xl">ü§ñ</span>
        <div class="chat-bubble chat-bubble-model bg-white text-gray-800 p-3 rounded-lg max-w-lg relative border border-gray-200 shadow-sm">
            <p>‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ú‡∏°‡∏Ñ‡∏∑‡∏≠ AI Technical Analyst ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏£‡∏≤‡∏ü‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö</p>
        </div>
        </div>`;
    userInput.value = '';
    setThinking(false);
});

// Modal Control
const fabToggle = document.getElementById('fab-chat-toggle');
const chatModal = document.getElementById('chatbot-modal');
const chatbotCloseBtn = document.getElementById('chatbot-close-btn');

fabToggle.addEventListener('click', () => {
    chatModal.classList.remove('chatbot-hidden');
    fabToggle.style.opacity = '0';
});
chatbotCloseBtn.addEventListener('click', () => {
    chatModal.classList.add('chatbot-hidden');
    fabToggle.style.opacity = '1';
});

</script>
</body>
</html>
