<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÇ‡∏£‡∏Ñ (AI Pharmacist)</title>

<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&family=Kodchasan:wght@600;700&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>

<style>
  :root{
    --bg:#fffdf7; --paper:#ffffff; --ink:#0f172a; --muted:#475569; --line:#e5e7eb;
    --brand:#50b5a5; --brand-2:#2f8f80; --chip:#e6fffb; --ring:#c7f5ef;
    --ok:#16a34a; --danger:#dc2626; --radius:16px;
    --shadow:0 10px 30px -18px rgba(2,8,23,.28);
  }
  *{box-sizing:border-box}
  html,body{margin:0; background:var(--bg); color:var(--ink); font-family:"Sarabun", system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans Thai", sans-serif;}
  a{color:#0ea5e9; text-decoration:none}
  a:hover{text-decoration:underline}

  /* ‡∏•‡πá‡∏≠‡∏Å‡∏™‡∏Å‡∏≠‡∏£‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ modal */
  body.no-scroll{ overflow:hidden; }

  .wrap{max-width:1100px; margin:auto; padding:24px 16px 80px}
  header.app{
    position:sticky; top:0; z-index:50; backdrop-filter:blur(10px);
    background:linear-gradient(180deg, rgba(255,253,247,.85), rgba(255,253,247,.65) 60%, rgba(255,253,247,0));
    padding:18px 16px 10px; margin:0 -16px; border-bottom:1px solid rgba(0,0,0,.04);
  }
  .title{
    font-family:"Kodchasan","Sarabun",sans-serif; font-weight:700; letter-spacing:.2px;
    display:flex; align-items:center; gap:12px; margin-bottom:10px; padding:0 16px; color:#0b3b34;
  }
  .badge{
    display:inline-flex; align-items:center; gap:6px;
    background:linear-gradient(145deg,var(--brand),#9fe7dc);
    color:#053c34; padding:6px 10px; border-radius:999px; font-weight:700; font-size:12px;
    box-shadow:inset 0 1px 0 #fff, 0 2px 10px rgba(2,143,128,.25);
  }

  /* Controls */
  .controls{ display:flex; gap:10px; align-items:center; padding:8px 16px 0; flex-wrap:wrap;}
  .controls .field{ position:relative; flex:1 1 240px; }
  .controls input[type="search"], .controls select{
    width:100%; height:42px; border-radius:12px; border:1px solid var(--line); background:var(--paper);
    padding:0 12px; font-size:15px; outline:none;
  }
  .controls button{
    height:42px; border-radius:12px; border:1px solid #67dacb; cursor:pointer;
    padding:0 14px; font-weight:800; letter-spacing:.2px;
    background:linear-gradient(145deg,#ddfff8,#baf3ea); color:#064e43;
    box-shadow:inset 0 1px 0 #fff, 0 10px 24px -14px rgba(2,143,128,.45);
    transition:transform .06s, background .18s;
  }
  .controls button:hover{ background:linear-gradient(145deg,#c9fbf0,#9eeadf); }
  .controls button:active{ transform:translateY(1px); }

  /* Grid */
  .grid{ display:grid; gap:14px; padding:14px 0; grid-template-columns: repeat(12,1fr); }
  .card{
    grid-column: span 4; background:var(--paper); border:1px solid var(--line); border-radius:var(--radius);
    padding:14px; box-shadow:var(--shadow); display:flex; flex-direction:column; gap:10px;
    transition:transform .18s ease, box-shadow .18s ease;
  }
  .card:hover{ transform:translateY(-2px); box-shadow:0 14px 40px -18px rgba(2,8,23,.36);}
  @media (max-width:1000px){ .card{grid-column: span 6;} }    /* 2 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå */
  @media (max-width:640px){ .card{grid-column: span 6;} }     /* ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡∏Ñ‡∏á 2 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå */
  @media (max-width:400px){ .card{grid-column: span 12;} }    /* ‡∏à‡∏≠‡πÄ‡∏•‡πá‡∏Å‡∏°‡∏≤‡∏Å ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 1 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå */

  .drug-name{ margin:0; font-size:18px; line-height:1.35; display:flex; gap:8px; align-items:center; font-weight:700;}
  .generic{ font-size:14px; color:#0b3b34; font-weight:700; }

  .meta{ display:flex; gap:8px; flex-wrap:wrap; font-size:12px;}
  .pill{ background:#f8fafc; border:1px solid var(--line); border-radius:999px; padding:4px 8px; }
  .tags{ display:flex; gap:6px; flex-wrap:wrap; }
  .tag{ font-size:12px; background:#ecfeff; color:#064e43; padding:4px 8px; border-radius:999px; border:1px solid #a5f3fc; }
  .excerpt{ color:#334155; font-size:14px; line-height:1.55; display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden; }

  .btn{
    align-self:flex-start; margin-top:auto; display:inline-flex; align-items:center; gap:8px; font-weight:800; letter-spacing:.2px;
    padding:10px 14px; border-radius:12px; border:1px solid #67dacb;
    background:linear-gradient(145deg,#ddfff8,#baf3ea); color:#064e43; cursor:pointer;
    transition:transform .06s, box-shadow .18s, background .2s; box-shadow:inset 0 1px 0 #fff, 0 10px 24px -14px rgba(2,143,128,.45);
  }
  .btn:hover{ background:linear-gradient(145deg,#c9fbf0,#9eeadf); }
  .btn:active{ transform:translateY(1px); }

  /* Pagination */
  .pager{ display:flex; align-items:center; gap:8px; justify-content:center; padding:12px 0 34px;}
  .pager button{ border:1px solid var(--line); background:var(--paper); border-radius:999px; padding:8px 12px; cursor:pointer; }
  .pager .info{ font-size:13px; color:var(--muted); padding:0 8px; }

  /* Modal (Drug Details) */
  .modal-backdrop{
    position:fixed; inset:0; background:rgba(0,0,0,.42); display:none; place-items:center; padding:16px; z-index:100;
    touch-action:none; /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏™‡∏Å‡∏≠‡∏£‡πå‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ï‡πâ modal ‡∏ö‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™ */
  }
  .modal{
    max-width:920px; width:100%; max-height:88vh; overflow:auto;
    background:var(--paper); border-radius:20px; border:1px solid var(--line); box-shadow:0 30px 80px rgba(0,0,0,.35);
  }
  .modal header{
    position:sticky; top:0; background:linear-gradient(180deg,#fff,rgba(255,255,255,.92));
    padding:16px 18px; border-bottom:1px solid var(--line); display:flex; justify-content:space-between; align-items:center; gap:10px;
  }
  .modal .body{ padding:18px; }
  .modal h2{ margin:0 0 8px; font-size:22px; }
  .close{ border:none; background:#111; color:#fff; border-radius:12px; padding:8px 12px; cursor:pointer; }
  .srcs{ margin-top:14px; font-size:14px; color:#475569; }
  .srcs a{ word-break:break-all }

  .modal-backdrop.show{ display:grid; }
  .content-html img{ max-width:100%; height:auto; border-radius:12px; }
  .content-html table{ border-collapse:collapse; width:100%; }
  .content-html table, .content-html th, .content-html td{ border:1px solid #ddd; }
  .content-html th, .content-html td{ padding:8px; }

  .skeleton{ background:linear-gradient(90deg, #f6f7f9 25%, #eceff3 37%, #f6f7f9 63%); animation:shimmer 1.2s infinite; }
  @keyframes shimmer{ 0%{background-position:-200px 0} 100%{background-position:200px 0} }

  /* ====== ‡∏™‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏¢‡∏≤ ====== */
  .cat-analgesic .drug-name{ color:#b45309 }      
  .cat-antipyretic .drug-name{ color:#2563eb }    
  .cat-antibiotic .drug-name{ color:#dc2626 }    
  .cat-antihistamine .drug-name{ color:#0f766e } 
  .cat-antacid .drug-name{ color:#7c3aed }        
  .cat-cough .drug-name{ color:#1e40af }          
  .cat-vitamin .drug-name{ color:#166534 }       

  /* ===== CSS ‡∏Ç‡∏≠‡∏á Chatbot UI (Pharmacist Theme) ===== */
  .chat-bubble::before { content: ''; position: absolute; width: 0; height: 0; border-style: solid; }
  .chat-bubble-user::before {
    border-width: 0 12px 12px 12px; border-color: transparent transparent #50b5a5 transparent; /* ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏°‡∏¥‡πâ‡∏ô‡∏ï‡πå */
    top: -10px; right: 12px;
  }
  .chat-bubble-model::before {
    border-width: 0 12px 12px 12px; border-color: transparent transparent #f3f4f6 transparent;
    top: -10px; left: 12px;
  }
  .gemini-thinking-bar {
    position: relative; width: 100%; height: 4px; background-color: #e0e0e0;
    border-radius: 2px; overflow: hidden;
  }
  .gemini-thinking-bar::before {
    content: ''; position: absolute; top: 0; left: 0; height: 100%; width: 100%;
    background: linear-gradient(90deg, #50b5a5, #2f8f80, #50b5a5);
    background-size: 200% 100%; animation: thinking-gradient 2s linear infinite;
  }
  @keyframes thinking-gradient { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
  
  #fab-chat-toggle {
    position: fixed; bottom: 25px; right: 25px;
    width: 60px; height: 60px;
    background-color: #064e43; /* ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÄ‡∏Ç‡πâ‡∏° */
    color: white;
    border: none; border-radius: 50%;
    font-size: 28px; line-height: 60px; text-align: center;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    cursor: pointer; z-index: 998;
    transition: transform 0.2s, opacity 0.3s;
    font-family: 'Kodchasan', sans-serif;
  }
  #fab-chat-toggle:hover { transform: scale(1.05); background-color: #50b5a5; }
  
  #chatbot-modal {
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    z-index: 1000; transition: opacity 0.3s, transform 0.3s;
    opacity: 1; transform: translateY(0); pointer-events: auto;
  }
  #chatbot-modal.chatbot-hidden {
    opacity: 0; transform: translateY(100%); pointer-events: none;
  }
</style>
</head>
<body>
  <header class="app">
    <div class="wrap" style="padding:0">
      <div class="title">
        <span class="badge">‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
        <div style="font-size:20px">‡∏¢‡∏≤‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÇ‡∏£‡∏Ñ</div>
      </div>

      <div class="controls" aria-label="‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á">
        <div class="field"><input id="q" type="search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤ / ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç / ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£ ..."></div>
        <div class="field">
          <select id="cat" aria-label="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏¢‡∏≤">
            <option value="">‚Äî ‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î ‚Äî</option>
            <option value="analgesic">‡∏¢‡∏≤‡πÅ‡∏Å‡πâ‡∏õ‡∏ß‡∏î</option>
            <option value="antipyretic">‡∏¢‡∏≤‡∏•‡∏î‡πÑ‡∏Ç‡πâ</option>
            <option value="antibiotic">‡∏¢‡∏≤‡∏Ü‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πâ‡∏≠</option>
            <option value="antihistamine">‡∏¢‡∏≤‡πÅ‡∏Å‡πâ‡πÅ‡∏û‡πâ</option>
            <option value="antacid">‡∏¢‡∏≤‡∏•‡∏î‡∏Å‡∏£‡∏î/‡∏Å‡∏£‡∏∞‡πÄ‡∏û‡∏≤‡∏∞</option>
            <option value="cough">‡∏¢‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏≠/‡∏Ç‡∏±‡∏ö‡πÄ‡∏™‡∏°‡∏´‡∏∞</option>
            <option value="vitamin">‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô/‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏°</option>
          </select>
        </div>
        <button id="searchBtn">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
        <button id="clearBtn" title="‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á">‡∏•‡πâ‡∏≤‡∏á</button>
      </div>
    </div>
  </header>

  <main class="wrap" id="mainContent">
    <section id="grid" class="grid"></section>
    <div class="pager" role="navigation" aria-label="‡πÄ‡∏û‡∏à‡∏à‡∏¥‡πÄ‡∏ô‡∏ä‡∏±‡∏ô">
      <button id="prevBtn">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
      <span class="info" id="pageInfo"></span>
      <button id="nextBtn">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
    </div>
  </main>

  <div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="mTitle">
    <div class="modal">
      <header>
        <h2 id="mTitle">‚Äî</h2>
        <button id="closeModal" class="close" aria-label="‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á">‡∏õ‡∏¥‡∏î</button>
      </header>
      <div class="body">
        <div class="meta" id="mMeta"></div>
        <div class="content-html" id="mContent"></div>
        <div class="srcs" id="mSources"></div>
      </div>
    </div>
  </div>

  <footer>
    <p class="footer-links" style="text-align: center; color: #475569; margin-top: 20px;">
      ¬© 2025 Crow Studio |
      <a href="https://sites.google.com/view/privacy-policy-pdpa-crow-studi/%E0%B8%AB%E0%B8%99%E0%B8%B2%E0%B9%81%E0%B8%A3%E0%B8%81">‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</a> |
      <a href="‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏Ç‡πâ‡∏≠‡∏ï‡∏Å‡∏•‡∏á">‡∏Ç‡πâ‡∏≠‡∏ï‡∏Å‡∏•‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</a>
    </p>
  </footer>

  <button id="fab-chat-toggle" title="‡∏ñ‡∏≤‡∏°‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£ AI">Ai</button>

  <div id="chatbot-modal" class="chatbot-hidden">
    <div class="flex flex-col h-screen bg-gray-100">
      <header class="bg-[#50b5a5] text-white p-4 flex justify-between items-center shadow-md">
        <div class="flex items-center gap-2">
            <span class="text-2xl">üíä</span>
            <h1 class="text-lg font-bold font-sans text-white m-0">AI ‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£</h1>
        </div>
        <div>
          <button id="new-chat-btn" class="bg-[#ddfff8] hover:bg-[#baf3ea] text-[#064e43] font-bold py-1 px-3 rounded mr-2 text-sm">
            ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
          </button>
          <button id="chatbot-close-btn" class="bg-gray-700 hover:bg-gray-900 text-white font-bold py-1 px-3 rounded text-sm">
            ‡∏õ‡∏¥‡∏î
          </button>
        </div>
      </header>

      <main id="chat-history" class="flex-1 overflow-y-auto p-4 space-y-4 bg-[#f0fdfa]">
        <div class="flex items-start space-x-2">
          <span class="text-2xl">ü§ñ</span>
          <div class="chat-bubble chat-bubble-model bg-white text-gray-800 p-3 rounded-lg max-w-lg relative border border-gray-200 shadow-sm">
            <p>‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ú‡∏°‡∏Ñ‡∏∑‡∏≠ AI ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£ ‡∏°‡∏µ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏¢‡∏≤‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÇ‡∏£‡∏Ñ ‡∏™‡∏£‡∏£‡∏û‡∏Ñ‡∏∏‡∏ì ‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö<br><br><small style="color:#d97706">*‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏î‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢‡∏Ç‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÑ‡∏î‡πâ ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á‡πÇ‡∏õ‡∏£‡∏î‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</small></p>
          </div>
        </div>
      </main>

      <div id="thinking-indicator" class="p-4 hidden bg-[#f0fdfa]">
        <div class="flex items-center space-x-2">
          <span class="text-2xl">ü§ñ</span>
          <div class="chat-bubble chat-bubble-model bg-white text-gray-800 p-3 rounded-lg max-w-lg relative border border-gray-200">
            <div class="gemini-thinking-bar"></div>
          </div>
        </div>
      </div>

      <footer class="bg-white p-3 shadow-inner border-t border-gray-200 m-0 w-full max-w-full">
        <div class="flex space-x-2">
          <input id="user-input" type="text" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡πà‡∏ß‡∏¢..." class="flex-1 p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#50b5a5] font-sans text-base">
          <button id="send-btn" class="bg-[#50b5a5] hover:bg-[#2f8f80] text-white font-bold py-2 px-4 rounded-xl shadow-sm">
            ‡∏™‡πà‡∏á
          </button>
        </div>
      </footer>
    </div>
  </div>

<script>
/** ================== CONFIG ================== **/
const API_JSON_URL = 'https://kodmai2025-github-io.vercel.app/api/chat'; 
const PAGE_SIZE = 12;

/** =============== Utilities =============== **/
const $$ = (sel, el=document)=>el.querySelector(sel);
const escapeHtml = (s='') => String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
const stripHtml = (html='') => { const t=document.createElement('div'); t.innerHTML=html; return t.textContent||t.innerText||''; };

const CAT_TH_TO_KEY = {
  '‡∏¢‡∏≤‡πÅ‡∏Å‡πâ‡∏õ‡∏ß‡∏î': 'analgesic', '‡∏¢‡∏≤‡∏•‡∏î‡πÑ‡∏Ç‡πâ': 'antipyretic', '‡∏¢‡∏≤‡∏Ü‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πâ‡∏≠': 'antibiotic',
  '‡∏¢‡∏≤‡πÅ‡∏Å‡πâ‡πÅ‡∏û‡πâ': 'antihistamine', '‡∏¢‡∏≤‡∏•‡∏î‡∏Å‡∏£‡∏î/‡∏Å‡∏£‡∏∞‡πÄ‡∏û‡∏≤‡∏∞': 'antacid',
  '‡∏¢‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏≠/‡∏Ç‡∏±‡∏ö‡πÄ‡∏™‡∏°‡∏´‡∏∞': 'cough', '‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô/‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏°': 'vitamin'
};

function normalizeDrug(x={}){
  if (x.name || x.generic || x.category || x.contentHtml) {
    return {
      id: String(x.id || ''), name: String(x.name || ''), generic: String(x.generic || ''),
      category: String(x.category || ''), descHtml: String(x.contentHtml || ''),
      caution: String(x.caution || ''), sources: Array.isArray(x.sources) ? x.sources : String(x.sources||'').split(/[|,;]+/).map(s=>s.trim()).filter(Boolean),
      updatedAt: String(x.updatedAt || '')
    };
  }
  const thaiName = x['‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤']; const thaiCat = x['‡∏´‡∏°‡∏ß‡∏î'];
  const thaiDesc = x['‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏¢‡∏≤‡πÅ‡∏ö‡∏ö‡∏û‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à']; const thaiCaution = x['‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥'];
  const thaiSrc = x['‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á url'];
  const key = CAT_TH_TO_KEY[thaiCat] || (String(thaiCat||'').toLowerCase()) || '';
  return {
    id: String(x.id || ''), name: String(thaiName || ''), generic: '',
    category: key, descHtml: escapeHtml(String(thaiDesc || '')).replace(/\n/g, '<br>'),
    caution: String(thaiCaution || ''), sources: String(thaiSrc||'').split(/[|,;]+/).map(s=>s.trim()).filter(Boolean),
    updatedAt: ''
  };
}

/** =============== Fetch & Render =============== **/
async function fetchData(){
  const res = await fetch(API_JSON_URL, {cache:'no-store'});
  if(!res.ok) throw new Error(`‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (status: ${res.status})`);
  const json = await res.json();
  const arr = Array.isArray(json) ? json : (Array.isArray(json.data) ? json.data : []);
  return arr.map(normalizeDrug).filter(drug => drug.name && drug.name.trim() !== '');
}

let raw = []; let view = []; let page = 1;

function renderPage(){
  const total = view.length; const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
  page = Math.min(Math.max(1, page), totalPages);
  const start = (page-1)*PAGE_SIZE; const cur = view.slice(start, start+PAGE_SIZE);
  const g = document.getElementById('grid');
  if(!cur.length){
    g.innerHTML = `<div style="grid-column:1/-1; text-align:center; color:#475569; padding:24px">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤</div>`;
  }else{
    g.innerHTML = cur.map(it=>{
      const catClass = it.category ? ` cat-${escapeHtml(it.category)}` : '';
      const excerpt = stripHtml(it.descHtml || '').slice(0,180);
      const srcs = (it.sources||[]).length ? `<div class="tag">${escapeHtml(it.sources[0])}${it.sources.length>1?'‚Ä¶':''}</div>` : '';
      return `
        <article class="card${catClass}" data-id="${escapeHtml(it.id)}" data-name="${escapeHtml(it.name)}">
          <h3 class="drug-name">üíä ${escapeHtml(it.name || '(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠)')}</h3>
          ${it.generic ? `<div class="generic">(${escapeHtml(it.generic)})</div>`:''}
          <div class="meta">
            ${it.category ? `<span class="pill">‡∏´‡∏°‡∏ß‡∏î: ${escapeHtml(it.category)}</span>`:''}
            ${it.updatedAt ? `<span class="pill">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï: ${escapeHtml(it.updatedAt)}</span>`:''}
          </div>
          <div class="excerpt">${escapeHtml(excerpt)}${excerpt.length>=180?'‚Ä¶':''}</div>
          <div class="tags">${srcs}</div>
          <button class="btn" onclick="openDrugModal('${encodeURIComponent(it.id)}','${encodeURIComponent(it.name)}')">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
        </article>
      `;
    }).join('');
  }
  document.getElementById('pageInfo').textContent = `‡∏´‡∏ô‡πâ‡∏≤ ${page} / ${totalPages}`;
  document.getElementById('prevBtn').disabled = page<=1;
  document.getElementById('nextBtn').disabled = page>=totalPages;
}

/** =============== Modal Logic =============== **/
let scrollY = 0;
function lockBody(){
  scrollY = window.scrollY || document.documentElement.scrollTop;
  document.body.classList.add('no-scroll'); document.body.style.position = 'fixed';
  document.body.style.top = `-${scrollY}px`; document.body.style.left = '0'; document.body.style.right = '0';
  document.getElementById('mainContent').setAttribute('inert','');
}
function unlockBody(){
  document.body.classList.remove('no-scroll'); document.body.style.position = '';
  document.body.style.top = ''; document.body.style.left = ''; document.body.style.right = '';
  window.scrollTo(0, scrollY); document.getElementById('mainContent').removeAttribute('inert');
}

// ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô openDrugModal ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ä‡∏ô‡∏Å‡∏±‡∏ö Chatbot
function openDrugModal(encodedId, encodedName){
  const id = decodeURIComponent(encodedId || '');
  const name = decodeURIComponent(encodedName || '');
  const it = raw.find(x=> (x.id && x.id===id) || (x.name===name)) || {};
  document.getElementById('mTitle').textContent = it.name || '(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠)';
  document.getElementById('mMeta').innerHTML = `
    ${it.category ? `<span class="pill">‡∏´‡∏°‡∏ß‡∏î: ${escapeHtml(it.category)}</span>`:''}
    ${it.caution ? `<span class="pill" style="border-color:#fca5a5; background:#fff1f2; color:#991b1b;">‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ${escapeHtml(it.caution)}</span>`:''}
  `;
  document.getElementById('mContent').innerHTML = it.descHtml || '';
  const srcs = (it.sources||[]).map(s=>`<a href="${escapeHtml(s)}" target="_blank" rel="noopener nofollow">${escapeHtml(s)}</a>`).join('<br>');
  document.getElementById('mSources').innerHTML = srcs ? `<strong>‡πÅ‡∏´‡∏•‡πà‡∏á‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á:</strong><br>${srcs}` : '';
  document.getElementById('modalBackdrop').classList.add('show');
  lockBody();
}
function closeModal(){
  document.getElementById('modalBackdrop').classList.remove('show');
  unlockBody();
}
document.getElementById('closeModal').addEventListener('click', closeModal);
document.getElementById('modalBackdrop').addEventListener('click', (e)=>{ if(e.target.id==='modalBackdrop') closeModal(); });

/** =============== Search & Pager =============== **/
document.getElementById('prevBtn').addEventListener('click', ()=>{ page=Math.max(1,page-1); renderPage(); });
document.getElementById('nextBtn').addEventListener('click', ()=>{ page=page+1; renderPage(); });
function applySearch(){
  const q = document.getElementById('q').value.trim().toLowerCase();
  const category = document.getElementById('cat').value.trim().toLowerCase();
  view = raw.filter(it=>{
    const hitQ = !q || [it.name, it.generic, stripHtml(it.descHtml||''), it.caution, (it.sources||[]).join(' ')].join(' | ').toLowerCase().includes(q);
    const hitCat = !category || (String(it.category||'').toLowerCase() === category);
    return hitQ && hitCat;
  });
  page = 1; renderPage();
}
document.getElementById('searchBtn').addEventListener('click', applySearch);
document.getElementById('clearBtn').addEventListener('click', ()=>{
  document.getElementById('q').value=''; document.getElementById('cat').value='';
  view=raw.slice(0); page=1; renderPage();
});
document.getElementById('q').addEventListener('keydown', e=>{ if(e.key==='Enter') applySearch(); });
document.getElementById('cat').addEventListener('change', applySearch);

(async function init(){
  try{ raw = await fetchData(); view = raw.slice(0); renderPage(); }
  catch(e){ document.getElementById('grid').innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:24px; color:#b91c1c">Error: ${escapeHtml(e.message)}</div>`; }
})();


/** =========================================
    3. ‡∏™‡πà‡∏ß‡∏ô Chatbot AI (Backend)
    ========================================= */
const BACKEND_URL = 'https://us-central1-law-ai-14740.cloudfunctions.net/api/chat';

// System Prompt: ‡∏õ‡∏£‡∏±‡∏ö‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£
const SYSTEM_PROMPT = {
    role: "user",
    parts: [{ text: "System Instruction: ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ AI ‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢ (Pharmacist AI) ‡∏°‡∏µ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏¢‡∏≤ ‡∏™‡∏£‡∏£‡∏û‡∏Ñ‡∏∏‡∏ì ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ ‡∏ú‡∏•‡∏Ç‡πâ‡∏≤‡∏á‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û ‡∏ï‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏†‡∏≤‡∏©‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏†‡∏≤‡∏û ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢ ‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏™‡∏°‡∏≠‡∏ß‡πà‡∏≤ '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô ‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏¢‡∏≤' ‡∏´‡πâ‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û" }]
};
const SYSTEM_ACK = {
    role: "model",
    parts: [{ text: "‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ú‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡∏≤‡πÅ‡∏•‡∏∞‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö" }]
};

let chatHistory = [SYSTEM_PROMPT, SYSTEM_ACK];

const chatHistoryEl = document.getElementById('chat-history');
const userInput = document.getElementById('user-input');
const sendBtn = document.getElementById('send-btn');
const newChatBtn = document.getElementById('new-chat-btn');
const thinkingIndicator = document.getElementById('thinking-indicator');

function addChatBubble(message, isUser = true) {
    const bubbleType = isUser ? 'user' : 'model';
    const icon = isUser ? 'üë§' : 'ü§ñ';
    const bgClass = isUser ? 'bg-[#50b5a5] text-white' : 'bg-white text-gray-800 border border-gray-200'; // ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏°‡∏¥‡πâ‡∏ô‡∏ï‡πå
    
    const wrap = document.createElement('div');
    wrap.className = `flex items-start space-x-2 ${isUser ? 'flex-row-reverse space-x-reverse' : ''}`;
    
    const bubble = document.createElement('div');
    bubble.className = `chat-bubble chat-bubble-${bubbleType} ${bgClass} p-3 rounded-lg max-w-lg relative shadow-sm`;
    bubble.innerHTML = `<p>${message.replace(/\n/g, '<br>')}</p>`;
    
    wrap.innerHTML = `<span class="text-2xl">${icon}</span>`;
    wrap.appendChild(bubble);
    
    chatHistoryEl.appendChild(wrap);
    chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
}

function addChatError(message) {
    const w = document.createElement('div');
    w.className = 'flex justify-center my-2';
    w.innerHTML = `<span class="bg-red-100 text-red-700 text-xs font-semibold px-3 py-1 rounded-full">${message}</span>`;
    chatHistoryEl.appendChild(w);
    chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
}

function setThinking(on) {
    thinkingIndicator.classList.toggle('hidden', !on);
    if (on) chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
}

async function handleSend() {
    const message = (userInput.value || '').trim();
    if (!message) return;

    addChatBubble(message, true);
    userInput.value = '';
    setThinking(true);
    sendBtn.disabled = true;

    chatHistory.push({ role: "user", parts: [{ text: message }] });

    try {
        const response = await fetch(BACKEND_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ history: chatHistory }) 
        });

        if (!response.ok) {
            const errData = await response.json();
            throw new Error(errData.error || `Server error: ${response.status}`);
        }

        const data = await response.json(); 
        const aiReply = data.reply;

        chatHistory.push({ role: "model", parts: [{ text: aiReply }] });
        setThinking(false);
        addChatBubble(aiReply, false);

    } catch (err) {
        console.error("Fetch Error:", err);
        setThinking(false);
        addChatError(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${err.message}`);
        chatHistory.pop();
    } finally {
        sendBtn.disabled = false;
    }
}

sendBtn.addEventListener('click', handleSend);
userInput.addEventListener('keydown', e => {
    if (e.key === 'Enter') handleSend();
});

// Reset Chat
newChatBtn.addEventListener('click', () => {
    chatHistory = [SYSTEM_PROMPT, SYSTEM_ACK];
    chatHistoryEl.innerHTML = `
        <div class="flex items-start space-x-2">
        <span class="text-2xl">ü§ñ</span>
        <div class="chat-bubble chat-bubble-model bg-white text-gray-800 p-3 rounded-lg max-w-lg relative border border-gray-200 shadow-sm">
            <p>‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ú‡∏°‡∏Ñ‡∏∑‡∏≠ AI ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£ ‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö</p>
        </div>
        </div>`;
    userInput.value = '';
    setThinking(false);
});

// Modal Control
const fabToggle = document.getElementById('fab-chat-toggle');
const chatModal = document.getElementById('chatbot-modal');
const chatbotCloseBtn = document.getElementById('chatbot-close-btn');

fabToggle.addEventListener('click', () => {
    chatModal.classList.remove('chatbot-hidden');
    fabToggle.style.opacity = '0';
});
chatbotCloseBtn.addEventListener('click', () => {
    chatModal.classList.add('chatbot-hidden');
    fabToggle.style.opacity = '1';
});

</script>
</body>
</html>
