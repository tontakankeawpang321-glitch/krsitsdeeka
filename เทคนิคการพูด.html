<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>üó£Ô∏è Speaking Techniques Library ‚Äì ‡∏£‡∏ß‡∏° 100 ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏Å‡∏≤‡∏£‡∏û‡∏π‡∏î (AI Coach)</title>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
:root{
  --bg:#f3f4f6;
  --paper:#fff;
  --ink:#0f172a;
  --muted:#6b7280;
  --line:#e5e7eb;
  --brand:#6366f1; /* Indigo */
  --accent:#f97316;
  --radius:18px;
  --shadow:0 16px 40px -22px rgba(15,23,42,.15);
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:"Sarabun",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:linear-gradient(160deg,#eef2ff 0%, #f8fafc 40%, #fff 100%);
  color:var(--ink);
  min-height:100vh;
}
body.modal-open{overflow:hidden;}
header{
  position:sticky; top:0; z-index:50;
  background:rgba(255,255,255,.9);
  backdrop-filter:blur(8px);
  border-bottom:1px solid rgba(99,102,241,.08);
}
header .wrap{
  max-width:1000px; margin:auto;
  display:flex; gap:12px; align-items:center; flex-wrap:wrap;
  padding:14px 16px;
}
.title{
  font-weight:700; font-size:1.2rem;
  display:flex; gap:6px; align-items:center;
}
.badge{
  background:rgba(99,102,241,.12);
  color:#312e81;
  font-size:.7rem;
  padding:2px 12px;
  border-radius:999px;
}
.search{
  margin-left:auto;
  display:flex; align-items:center; gap:8px;
  background:rgba(99,102,241,.06);
  border:1px solid rgba(99,102,241,.15);
  padding:5px 12px;
  border-radius:999px;
  width:min(420px,100%);
}
.search input{
  border:none; outline:none; background:transparent;
  width:100%; font-size:.82rem; color:var(--ink);
}
.search ::placeholder{color:rgba(15,23,42,.45)}
.layout{
  max-width:1000px; margin:16px auto 40px; padding:0 16px;
}
#filters{
  display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap;
}
.filter-btn{
  background:#fff;
  border:1px solid rgba(99,102,241,.18);
  border-radius:999px;
  padding:5px 12px 5px 10px;
  display:flex; gap:6px; align-items:center;
  font-size:.74rem;
  cursor:pointer;
  transition:.12s ease;
}
.filter-dot{
  width:6px; height:6px; border-radius:999px; background:var(--brand);
}
.filter-btn[data-filter="intro"] .filter-dot{background:#f97316;}
.filter-btn[data-filter="pitch"] .filter-dot{background:#22c55e;}
.filter-btn[data-filter="followup"] .filter-dot{background:#0ea5e9;}
.filter-btn[data-filter="problem"] .filter-dot{background:#ef4444;}
.filter-btn.active{
  background:var(--brand);
  color:#fff;
  border-color:transparent;
}
#listWrap{
  background:transparent;
}
.tech-card{
  background:var(--paper);
  border:1px solid rgba(148,163,184,.12);
  border-radius:16px;
  padding:14px 14px 12px;
  display:flex; gap:12px; align-items:flex-start;
  margin-bottom:12px;
  box-shadow:0 12px 28px -16px rgba(15,23,42,.12);
  cursor:pointer;
  transition:transform .12s ease, box-shadow .12s ease;
}
.tech-card:hover{
  transform:translateY(-2px);
  box-shadow:0 18px 36px -18px rgba(15,23,42,.14);
}
.tech-icon{
  width:42px; height:42px; border-radius:16px;
  background:radial-gradient(circle at 10% 10%, #6366f1 0%, #a855f7 40%, #f97316 100%);
  display:flex; align-items:center; justify-content:center;
  color:#fff; font-weight:700; font-size:.75rem;
  flex:none;
}
.tech-body{flex:1;}
.tech-title{font-weight:700; font-size:.9rem; margin-bottom:2px;}
.tech-meta{font-size:.68rem; color:var(--muted); margin-bottom:6px;}
.tech-preview{font-size:.72rem; color:#374151; line-height:1.35; max-height:3.1rem; overflow:hidden;}
.tag{
  display:inline-block; background:rgba(99,102,241,.08);
  border:1px solid rgba(99,102,241,.14);
  color:#312e81; font-size:.63rem;
  padding:2px 8px; border-radius:999px; margin-top:6px; margin-right:4px;
}
.pager{
  display:flex; justify-content:center; gap:8px; margin-top:14px; align-items:center;
}
.pager .btn{
  border:1px solid var(--line);
  background:#fff;
  border-radius:9px;
  padding:5px 11px;
  cursor:pointer;
  font-size:.7rem;
}
.pager .btn[disabled]{opacity:.4; cursor:not-allowed;}
.pager .info{font-size:.7rem; color:var(--muted);}
dialog.tech-dialog{
  width:min(720px,96vw);
  border:none;
  border-radius:18px;
  overflow:hidden;
  background:#fff;
  box-shadow:0 28px 44px -26px rgba(15,23,42,.5);
  padding:0;
}
.td-head{
  background:linear-gradient(140deg,#4f46e5 0%, #6366f1 30%, #f97316 100%);
  padding:14px 16px 12px;
  display:flex; gap:8px; align-items:center;
  color:#fff;
}
.td-title{font-weight:700;}
.td-close{
  margin-left:auto;
  background:rgba(255,255,255,.1);
  border:1px solid rgba(255,255,255,.12);
  color:#fff; border-radius:999px; padding:5px 12px; cursor:pointer; font-size:.68rem;
}
.td-body{
  padding:16px 16px 14px; background:#fff;
}
.td-sub{font-size:.7rem; color:#6b7280; margin-bottom:10px;}
.section-title{
  font-size:.72rem; font-weight:600; margin-bottom:4px; color:#111827;
  text-transform:uppercase; letter-spacing:.01em;
}
.section-box{
  background:#f9fafb; border:1px solid #eef2ff;
  border-radius:12px; padding:10px 12px; font-size:.75rem; line-height:1.45; white-space:pre-wrap;
}
.td-footer{
  padding:9px 16px 14px; background:#fff; border-top:1px solid #eef2ff; text-align:right;
}
.td-link{
  background:#6366f1; border:none; color:#fff; border-radius:999px;
  padding:5px 12px; font-size:.68rem; font-weight:600; text-decoration:none;
}
footer{
  text-align:center; font-size:.7rem; color:#94a3b8; margin:16px 0 28px;
}
footer a{color:#6366f1; text-decoration:none;}
@media(max-width:640px){
  .tech-card{flex-direction:row;}
  .search{width:100%; margin-left:0;}
}

/* === CSS ‡∏Ç‡∏≠‡∏á Chatbot UI (Coach Theme) === */
.chat-bubble::before { content: ''; position: absolute; width: 0; height: 0; border-style: solid; }
.chat-bubble-user::before {
  border-width: 0 12px 12px 12px; border-color: transparent transparent #6366f1 transparent; /* Indigo */
  top: -10px; right: 12px;
}
.chat-bubble-model::before {
  border-width: 0 12px 12px 12px; border-color: transparent transparent #e5e7eb transparent;
  top: -10px; left: 12px;
}
.gemini-thinking-bar {
  position: relative; width: 100%; height: 4px; background-color: #e0e0e0;
  border-radius: 2px; overflow: hidden;
}
.gemini-thinking-bar::before {
  content: ''; position: absolute; top: 0; left: 0; height: 100%; width: 100%;
  background: linear-gradient(90deg, #6366f1, #a855f7, #6366f1);
  background-size: 200% 100%; animation: thinking-gradient 2s linear infinite;
}
@keyframes thinking-gradient { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

#fab-chat-toggle {
  position: fixed; bottom: 70px; right: 25px; /* ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° */
  width: 50px; height: 50px;
  background-color: #6366f1; /* Indigo */
  color: white;
  border: none; border-radius: 50%;
  font-size: 24px; line-height: 50px; text-align: center;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  cursor: pointer; z-index: 1000;
  transition: transform 0.2s, opacity 0.3s;
  font-family: 'Sarabun', sans-serif;
}
#fab-chat-toggle:hover { transform: scale(1.05); background-color: #4f46e5; }

#chatbot-modal {
  position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
  z-index: 1000; transition: opacity 0.3s, transform 0.3s;
  opacity: 1; transform: translateY(0); pointer-events: auto;
}
#chatbot-modal.chatbot-hidden {
  opacity: 0; transform: translateY(100%); pointer-events: none;
}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="title">üó£Ô∏è Speaking Techniques Library <span class="badge" id="countBadge">0 ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ</span></div>
    <div class="search">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="#4b5563" stroke-width="1.8" stroke-linecap="round"/></svg>
      <input id="q" type="search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤ / ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ / ‡∏ï‡πà‡∏≠‡∏£‡∏≠‡∏á / ‡∏û‡∏π‡∏î‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° ...">
    </div>
  </div>
</header>

<div class="layout">
  <div id="filters">
    <button class="filter-btn active" data-filter="all"><span class="filter-dot"></span> ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    <button class="filter-btn" data-filter="intro"><span class="filter-dot"></span> ‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤</button>
    <button class="filter-btn" data-filter="pitch"><span class="filter-dot"></span> ‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠/‡∏Ç‡∏≤‡∏¢</button>
    <button class="filter-btn" data-filter="followup"><span class="filter-dot"></span> ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô</button>
    <button class="filter-btn" data-filter="problem"><span class="filter-dot"></span> ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤/‡∏Ç‡πâ‡∏≠‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á</button>
  </div>
  <section id="listWrap"></section>
  <div id="pager" class="pager"></div>
</div>

<dialog id="detailDialog" class="tech-dialog">
  <div class="td-head">
    <div>
      <div class="td-title" id="dTitle">‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏Å‡∏≤‡∏£‡∏û‡∏π‡∏î</div>
      <div style="font-size:.68rem; opacity:.8;" id="dCat">‡∏´‡∏°‡∏ß‡∏î</div>
    </div>
    <button id="dClose" class="td-close">‡∏õ‡∏¥‡∏î</button>
  </div>
  <div class="td-body">
    <div class="td-sub" id="dScenario"></div>
    <div class="section-title">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ</div>
    <div class="section-box" id="dScript"></div>
    <div style="height:10px"></div>
    <div class="section-title">‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö</div>
    <div class="section-box" id="dTip"></div>
  </div>
  <div class="td-footer">
    <a id="dLink" class="td-link" target="_blank" rel="noopener">‡∏î‡∏π‡πÅ‡∏´‡∏•‡πà‡∏á‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á</a>
  </div>
</dialog>

<footer>
  ¬© 2025 Crow Studio ‚Ä¢ ‡∏Ñ‡∏•‡∏±‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏Å‡∏≤‡∏£‡∏û‡∏π‡∏î
</footer>

<button id="fab-chat-toggle" title="‡∏ñ‡∏≤‡∏° AI Coach">Ai</button>

<div id="chatbot-modal" class="chatbot-hidden">
  <div class="flex flex-col h-screen bg-gray-100">
    <header class="bg-[#6366f1] text-white p-4 flex justify-between items-center shadow-md">
      <div class="flex items-center gap-2">
          <span class="text-2xl">üó£Ô∏è</span>
          <h1 class="text-lg font-bold font-sans text-white m-0">AI Speaking Coach</h1>
      </div>
      <div>
        <button id="new-chat-btn" class="bg-[#eef2ff] hover:bg-[#e0e7ff] text-[#6366f1] font-bold py-1 px-3 rounded mr-2 text-sm">
          ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
        </button>
        <button id="chatbot-close-btn" class="bg-gray-700 hover:bg-gray-900 text-white font-bold py-1 px-3 rounded text-sm">
          ‡∏õ‡∏¥‡∏î
        </button>
      </div>
    </header>

    <main id="chat-history" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50">
      <div class="flex items-start space-x-2">
        <span class="text-2xl">ü§ñ</span>
        <div class="chat-bubble chat-bubble-model bg-white text-gray-800 p-3 rounded-lg max-w-lg relative border border-gray-200 shadow-sm">
          <p>‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ú‡∏°‡∏Ñ‡∏∑‡∏≠ AI Communication Coach 

[Image of public speaking]
 ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏Å‡∏≤‡∏£‡∏û‡∏π‡∏î ‡∏Å‡∏≤‡∏£‡πÄ‡∏à‡∏£‡∏à‡∏≤‡∏ï‡πà‡∏≠‡∏£‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡πà‡∏≤‡∏á‡∏ö‡∏ó‡∏û‡∏π‡∏î‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏±‡∏ö</p>
        </div>
      </div>
    </main>

    <div id="thinking-indicator" class="p-4 hidden bg-gray-50">
      <div class="flex items-center space-x-2">
        <span class="text-2xl">ü§ñ</span>
        <div class="chat-bubble chat-bubble-model bg-white text-gray-800 p-3 rounded-lg max-w-lg relative border border-gray-200">
          <div class="gemini-thinking-bar"></div>
        </div>
      </div>
    </div>

    <footer class="bg-white p-3 shadow-inner border-t border-gray-200 m-0 w-full max-w-full">
      <div class="flex space-x-2">
        <input id="user-input" type="text" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå (‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡∏≠‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)..." class="flex-1 p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#6366f1] font-sans text-base">
        <button id="send-btn" class="bg-[#6366f1] hover:bg-[#4f46e5] text-white font-bold py-2 px-4 rounded-xl shadow-sm">
          ‡∏™‡πà‡∏á
        </button>
      </div>
    </footer>
  </div>
</div>

<script>
const CSV_URL = "speaking_techniques.csv"; 
let RAW = [], CURRENT = [];
let page = 1;
const pageSize = 12;
let currentFilter = "all";
const dialogEl = document.getElementById("detailDialog");
const dClose = document.getElementById("dClose");

async function loadCSV(){
  return new Promise((resolve, reject)=>{
    Papa.parse(CSV_URL, { download:true, header:true, skipEmptyLines:true, complete:res=>resolve(res.data), error:reject });
  });
}

function applyFilters(){
  const q = document.getElementById("q").value.trim().toLowerCase();
  CURRENT = RAW.filter(r=>{
    if(currentFilter !== "all"){
      if((r.category||"").toLowerCase() !== mapFilterToCategory(currentFilter).toLowerCase()) return false;
    }
    const hay = `${r.title||""} ${r.category||""} ${r.scenario||""} ${r.script||""} ${r.tip||""}`.toLowerCase();
    return q === "" ? true : hay.includes(q);
  });
  page = 1; renderList();
}

function mapFilterToCategory(filterKey){
  switch(filterKey){
    case "intro": return "‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤";
    case "pitch": return "‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠/‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢";
    case "followup": return "‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô";
    case "problem": return "‡∏ï‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á/‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤";
    default: return "";
  }
}

function renderList(){
  const host = document.getElementById("listWrap");
  host.innerHTML = "";
  document.getElementById("countBadge").textContent = `${RAW.length} ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ`;
  if(CURRENT.length === 0){ host.innerHTML = `<div style="padding:10px;color:#6b7280;font-size:.8rem;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</div>`; document.getElementById("pager").innerHTML = ""; return; }
  const totalPages = Math.ceil(CURRENT.length / pageSize);
  const start = (page-1)*pageSize;
  const end = start + pageSize;
  const slice = CURRENT.slice(start, end);
  slice.forEach(r=>{
    const card = document.createElement("article"); card.className = "tech-card";
    const icon = document.createElement("div"); icon.className = "tech-icon"; icon.textContent = (r.id || "?").toString().padStart(2,"0");
    const body = document.createElement("div"); body.className = "tech-body";
    body.innerHTML = `<div class="tech-title">${r.title || "‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏Å‡∏≤‡∏£‡∏û‡∏π‡∏î"}</div><div class="tech-meta">${r.category || ""}${r.scenario ? " ‚Ä¢ " + r.scenario : ""}</div><div class="tech-preview">${r.script || ""}</div>${r.category ? `<span class="tag">${r.category}</span>` : ""}`;
    card.append(icon, body); card.addEventListener("click", ()=>openDialog(r)); host.append(card);
  });
  renderPager(totalPages);
}

function renderPager(totalPages){
  const pager = document.getElementById("pager"); pager.innerHTML = "";
  const prev = document.createElement("button"); prev.className = "btn"; prev.textContent = "‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö"; prev.disabled = page === 1; prev.onclick = ()=>{ page--; renderList(); };
  const next = document.createElement("button"); next.className = "btn"; next.textContent = "‡∏ñ‡∏±‡∏î‡πÑ‡∏õ"; next.disabled = page === totalPages; next.onclick = ()=>{ page++; renderList(); };
  const info = document.createElement("div"); info.className = "info"; info.textContent = `‡∏´‡∏ô‡πâ‡∏≤ ${page} / ${totalPages} (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${CURRENT.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`;
  pager.append(prev, info, next);
}

function openDialog(r){
  document.getElementById("dTitle").textContent = r.title || "‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏Å‡∏≤‡∏£‡∏û‡∏π‡∏î";
  document.getElementById("dCat").textContent = r.category || "";
  document.getElementById("dScenario").textContent = r.scenario || "";
  document.getElementById("dScript").textContent = r.script || "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á";
  document.getElementById("dTip").textContent = r.tip || "‡πÉ‡∏ä‡πâ‡πÇ‡∏ó‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏™‡∏∏‡∏†‡∏≤‡∏û ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏ü‡∏±‡∏á";
  const link = document.getElementById("dLink");
  if(r.source_url){ link.style.display = "inline-block"; link.href = r.source_url; } else { link.style.display = "none"; }
  if(typeof dialogEl.showModal === "function"){ dialogEl.showModal(); document.body.classList.add("modal-open"); } else { dialogEl.style.display = "block"; }
}

dClose.addEventListener("click", ()=>{ dialogEl.close(); document.body.classList.remove("modal-open"); });
dialogEl.addEventListener("close", ()=>{ document.body.classList.remove("modal-open"); });

document.getElementById("q").addEventListener("input", applyFilters);
document.querySelectorAll("#filters .filter-btn").forEach(btn=>{
  btn.onclick = ()=>{
    document.querySelectorAll("#filters .filter-btn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active"); currentFilter = btn.dataset.filter; applyFilters();
  };
});

(async function init(){ RAW = await loadCSV(); applyFilters(); })();


/* =========================================
    ‡∏™‡πà‡∏ß‡∏ô Chatbot AI (Backend)
   ========================================= */
// ‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å '/api/chat' ‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏ï‡πá‡∏°‡∏Ç‡∏≠‡∏á Vercel
const BACKEND_URL = 'https://shy-fog-aa02.tontakankeawpang321.workers.dev';


// System Prompt: ‡πÇ‡∏Ñ‡πâ‡∏ä‡∏™‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏π‡∏î
const SYSTEM_PROMPT = {
    role: "user",
    parts: [{ text: "System Instruction: ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ AI Communication Coach ‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏à‡∏¥‡∏ï‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£ ‡∏ß‡∏≤‡∏ó‡∏®‡∏¥‡∏•‡∏õ‡πå ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏û‡∏π‡∏î‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞ ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏Å‡∏≤‡∏£‡∏û‡∏π‡∏î ‡∏£‡πà‡∏≤‡∏á‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå (Script) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ï‡πà‡∏≤‡∏á‡πÜ (‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢, ‡∏Å‡∏≤‡∏£‡πÄ‡∏à‡∏£‡∏à‡∏≤, ‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠‡∏á‡∏≤‡∏ô) ‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÇ‡∏ó‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏†‡∏≤‡∏©‡∏≤‡∏Å‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏° ‡∏à‡∏á‡∏ï‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏†‡∏≤‡∏©‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏†‡∏≤‡∏û ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏á ‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏à" }]
};
const SYSTEM_ACK = {
    role: "model",
    parts: [{ text: "‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ú‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏Ñ‡πâ‡∏ä‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏Å‡∏≤‡∏£‡∏û‡∏π‡∏î‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö" }]
};

let chatHistory = [SYSTEM_PROMPT, SYSTEM_ACK];

const chatHistoryEl = document.getElementById('chat-history');
const userInput = document.getElementById('user-input');
const sendBtn = document.getElementById('send-btn');
const newChatBtn = document.getElementById('new-chat-btn');
const thinkingIndicator = document.getElementById('thinking-indicator');

function addChatBubble(message, isUser = true) {
    const bubbleType = isUser ? 'user' : 'model';
    const icon = isUser ? 'üë§' : 'ü§ñ';
    const bgClass = isUser ? 'bg-[#6366f1] text-white' : 'bg-white text-gray-800 border border-gray-200';
    
    const wrap = document.createElement('div');
    wrap.className = `flex items-start space-x-2 ${isUser ? 'flex-row-reverse space-x-reverse' : ''}`;
    
    const bubble = document.createElement('div');
    bubble.className = `chat-bubble chat-bubble-${bubbleType} ${bgClass} p-3 rounded-lg max-w-lg relative shadow-sm`;
    bubble.innerHTML = `<p>${message.replace(/\n/g, '<br>')}</p>`;
    
    wrap.innerHTML = `<span class="text-2xl">${icon}</span>`;
    wrap.appendChild(bubble);
    
    chatHistoryEl.appendChild(wrap);
    chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
}

function addChatError(message) {
    const w = document.createElement('div');
    w.className = 'flex justify-center my-2';
    w.innerHTML = `<span class="bg-red-100 text-red-700 text-xs font-semibold px-3 py-1 rounded-full">${message}</span>`;
    chatHistoryEl.appendChild(w);
    chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
}

function setThinking(on) {
    thinkingIndicator.classList.toggle('hidden', !on);
    if (on) chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
}

async function handleSend() {
    const message = (userInput.value || '').trim();
    if (!message) return;

    addChatBubble(message, true);
    userInput.value = '';
    setThinking(true);
    sendBtn.disabled = true;

    chatHistory.push({ role: "user", parts: [{ text: message }] });

    try {
        const response = await fetch(BACKEND_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ history: chatHistory }) 
        });

        if (!response.ok) {
            const errData = await response.json();
            throw new Error(errData.error || `Server error: ${response.status}`);
        }

        const data = await response.json(); 
        const aiReply = data.reply;

        chatHistory.push({ role: "model", parts: [{ text: aiReply }] });
        setThinking(false);
        addChatBubble(aiReply, false);

    } catch (err) {
        console.error("Fetch Error:", err);
        setThinking(false);
        addChatError(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${err.message}`);
        chatHistory.pop();
    } finally {
        sendBtn.disabled = false;
    }
}

sendBtn.addEventListener('click', handleSend);
userInput.addEventListener('keydown', e => {
    if (e.key === 'Enter') handleSend();
});

// Reset Chat
newChatBtn.addEventListener('click', () => {
    chatHistory = [SYSTEM_PROMPT, SYSTEM_ACK];
    chatHistoryEl.innerHTML = `
        <div class="flex items-start space-x-2">
        <span class="text-2xl">ü§ñ</span>
        <div class="chat-bubble chat-bubble-model bg-white text-gray-800 p-3 rounded-lg max-w-lg relative border border-gray-200 shadow-sm">
            <p>‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ú‡∏°‡∏Ñ‡∏∑‡∏≠ AI Communication Coach ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏π‡∏î‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö</p>
        </div>
        </div>`;
    userInput.value = '';
    setThinking(false);
});

// Modal Control
const fabToggle = document.getElementById('fab-chat-toggle');
const chatModal = document.getElementById('chatbot-modal');
const chatbotCloseBtn = document.getElementById('chatbot-close-btn');

fabToggle.addEventListener('click', () => {
    chatModal.classList.remove('chatbot-hidden');
    fabToggle.style.opacity = '0';
});
chatbotCloseBtn.addEventListener('click', () => {
    chatModal.classList.add('chatbot-hidden');
    fabToggle.style.opacity = '1';
});
</script>
</body>
</html>



